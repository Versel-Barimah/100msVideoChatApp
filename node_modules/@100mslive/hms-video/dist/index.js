var Dr=Object.defineProperty,_r=Object.defineProperties;var Nr=Object.getOwnPropertyDescriptors;var Zt=Object.getOwnPropertySymbols;var xr=Object.prototype.hasOwnProperty,Or=Object.prototype.propertyIsEnumerable;var Xt=(n,e,t)=>e in n?Dr(n,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):n[e]=t,v=(n,e)=>{for(var t in e||(e={}))xr.call(e,t)&&Xt(n,t,e[t]);if(Zt)for(var t of Zt(e))Or.call(e,t)&&Xt(n,t,e[t]);return n},x=(n,e)=>_r(n,Nr(e));var c=(n,e,t)=>new Promise((r,i)=>{var a=l=>{try{d(t.next(l))}catch(u){i(u)}},s=l=>{try{d(t.throw(l))}catch(u){i(u)}},d=l=>l.done?r(l.value):Promise.resolve(l.value).then(a,s);d((t=t.apply(n,e)).next())});import Lr from"webrtc-adapter";var V;(function(l){l[l.VERBOSE=0]="VERBOSE",l[l.DEBUG=1]="DEBUG",l[l.INFO=2]="INFO",l[l.WARN=3]="WARN",l[l.TIME=4]="TIME",l[l.TIMEEND=5]="TIMEEND",l[l.ERROR=6]="ERROR",l[l.NONE=7]="NONE"})(V||(V={}));var Vr=typeof window!="undefined"&&typeof window.expect!="undefined",o=class{static v(e,...t){this.log(0,e,...t)}static d(e,...t){this.log(1,e,...t)}static i(e,...t){this.log(2,e,...t)}static w(e,...t){this.log(3,e,...t)}static e(e,...t){this.log(6,e,...t)}static time(e){this.log(4,"[HMSPerformanceTiming]",e)}static timeEnd(e){this.log(5,"[HMSPerformanceTiming]",e,e)}static cleanUp(){performance.clearMarks(),performance.clearMeasures()}static log(e,t,...r){if(!(this.level.valueOf()>e.valueOf()))switch(e){case 0:{console.log(t,...r);break}case 1:{console.debug(t,...r);break}case 2:{console.info(t,...r);break}case 3:{console.warn(t,...r);break}case 6:{console.error(t,...r);break}case 4:{performance.mark(r[0]);break}case 5:{let i=r[0];try{let a=performance.measure(i,i);this.log(1,t,i,a==null?void 0:a.duration),performance.clearMarks(i),performance.clearMeasures(i)}catch(a){this.log(1,t,i,a)}break}}}};o.level=Vr?7:0;var W;(function(t){t[t.Publish=0]="Publish",t[t.Subscribe=1]="Subscribe"})(W||(W={}));import{parse as ar,write as Fr}from"sdp-transform";var k={WebSocketConnectionErrors:{GENERIC_CONNECT:1e3,WEBSOCKET_CONNECTION_LOST:1003},InitAPIErrors:{SERVER_ERRORS:2e3,INIT_CONFIG_NOT_AVAILABLE:2002,ENDPOINT_UNREACHABLE:2003,INVALID_TOKEN_FORMAT:2004},TracksErrors:{GENERIC_TRACK:3e3,CANT_ACCESS_CAPTURE_DEVICE:3001,DEVICE_NOT_AVAILABLE:3002,DEVICE_IN_USE:3003,DEVICE_LOST_MIDWAY:3008,NOTHING_TO_RETURN:3005,INVALID_VIDEO_SETTINGS:3006,CODEC_CHANGE_NOT_PERMITTED:3007,AUTOPLAY_ERROR:3008,OVER_CONSTRAINED:3009,NO_AUDIO_DETECTED:3010},WebrtcErrors:{CREATE_OFFER_FAILED:4001,CREATE_ANSWER_FAILED:4002,SET_LOCAL_DESCRIPTION_FAILED:4003,SET_REMOTE_DESCRIPTION_FAILED:4004,ICE_FAILURE:4005},WebsocketMethodErrors:{SERVER_ERRORS:5e3,ALREADY_JOINED:5001,CANNOT_JOIN_PREVIEW_IN_PROGRESS:5002},GenericErrors:{NOT_CONNECTED:6e3,SIGNALLING:6001,UNKNOWN:6002,NOT_READY:6003,JSON_PARSING_FAILED:6004,TRACK_METADATA_MISSING:6005,RTC_TRACK_MISSING:6006,PEER_METADATA_MISSING:6007,INVALID_ROLE:6008,PREVIEW_IN_PROGRESS:6009,MISSING_MEDIADEVICES:6010,MISSING_RTCPEERCONNECTION:6011},PlaylistErrors:{NO_ENTRY_TO_PLAY:8001,NO_ENTRY_IS_PLAYING:8002}};var g=class extends Error{constructor(e,t,r,i,a,s=!1){super(i);this.code=e;this.name=t;this.message=i;this.description=a;this.isTerminal=s;Object.setPrototypeOf(this,g.prototype),this.action=r.toString()}toAnalyticsProperties(){return{error_name:this.name,error_code:this.code,error_message:this.message,error_description:this.description,action:this.action,is_terminal:this.isTerminal}}addNativeError(e){this.nativeError=e}};var h;(function(E){E.NONE="NONE",E.TRACK="TRACK",E.INIT="INIT",E.PUBLISH="PUBLISH",E.UNPUBLISH="UNPUBLISH",E.JOIN="JOIN",E.SUBSCRIBE="SUBSCRIBE",E.DATA_CHANNEL_SEND="DATA_CHANNEL_SEND",E.RESTART_ICE="RESTART_ICE",E.VIDEO_PLUGINS="VIDEO_PLUGINS",E.AUDIO_PLUGINS="AUDIO_PLUGINS",E.AUTOPLAY="AUTOPLAY",E.RECONNECT_SIGNAL="RECONNECT_SIGNAL",E.VALIDATION="VALIDATION",E.PLAYLIST="PLAYLIST",E.PREVIEW="PREVIEW"})(h||(h={}));var p={WebSocketConnectionErrors:{GenericConnect(n,e=""){return new g(k.WebSocketConnectionErrors.GENERIC_CONNECT,"WebsocketConnection",n,`[WS]: ${e}`,`[WS]: ${e}`)},WebSocketConnectionLost(n,e=""){return new g(k.WebSocketConnectionErrors.WEBSOCKET_CONNECTION_LOST,"WebSocketConnectionLost",n,"Network connection lost ",e)}},InitAPIErrors:{ServerErrors(n,e,t=""){return new g(n,"ServerErrors",e,"[INIT]: Server error",t)},EndpointUnreachable(n,e=""){return new g(k.InitAPIErrors.ENDPOINT_UNREACHABLE,"EndpointUnreachable",n,"Endpoint is not reachable.",e)},InvalidTokenFormat(n,e=""){return new g(k.InitAPIErrors.INVALID_TOKEN_FORMAT,"InvalidTokenFormat",n,`Token is not in proper JWT format - ${e}`,e)},InitConfigNotAvailable(n,e=""){return new g(k.InitAPIErrors.INIT_CONFIG_NOT_AVAILABLE,"InitError",n,`[INIT]: ${e}`,`[INIT]: ${e}`)}},TracksErrors:{GenericTrack(n,e=""){return new g(k.TracksErrors.GENERIC_TRACK,"GenericTrack",n,`[TRACK]: ${e}`,`[TRACK]: ${e}`)},CantAccessCaptureDevice(n,e,t=""){return new g(k.TracksErrors.CANT_ACCESS_CAPTURE_DEVICE,"CantAccessCaptureDevice",n,`[TRACK]: No permission to access capture device - ${e}`,t)},DeviceNotAvailable(n,e,t=""){return new g(k.TracksErrors.DEVICE_NOT_AVAILABLE,"DeviceNotAvailable",n,`[TRACK]: Capture device is no longer available - ${e}`,t)},DeviceInUse(n,e,t=""){return new g(k.TracksErrors.DEVICE_IN_USE,"DeviceInUse",n,`[TRACK]: Capture device is in use by another application - ${e}`,t)},DeviceLostMidway(n,e,t=""){return new g(k.TracksErrors.DEVICE_LOST_MIDWAY,"DeviceLostMidway",n,`Lost access to capture device midway - ${e}`,t)},NothingToReturn(n,e=""){return new g(k.TracksErrors.NOTHING_TO_RETURN,"NothingToReturn",n,"There is no media to return. Please select either video or audio or both.",e)},InvalidVideoSettings(n,e=""){return new g(k.TracksErrors.INVALID_VIDEO_SETTINGS,"InvalidVideoSettings",n,"Cannot enable simulcast when no video settings are provided",e)},AutoplayBlocked(n,e=""){return new g(k.TracksErrors.AUTOPLAY_ERROR,"AutoplayBlocked",n,"Autoplay blocked because the user didn't interact with the document first",e)},CodecChangeNotPermitted(n,e=""){return new g(k.TracksErrors.CODEC_CHANGE_NOT_PERMITTED,"CodecChangeNotPermitted",n,"Codec can't be changed mid call.",e)},OverConstrained(n,e,t=""){return new g(k.TracksErrors.OVER_CONSTRAINED,"OverConstrained",n,`[TRACK]: Requested constraints cannot be satisfied with the device hardware - ${e}`,t)},NoAudioDetected(n,e="Please check the mic or use another audio input"){return new g(k.TracksErrors.NO_AUDIO_DETECTED,"NoAudioDetected",n,"No audio input detected from microphone",e)}},WebrtcErrors:{CreateOfferFailed(n,e=""){return new g(k.WebrtcErrors.CREATE_OFFER_FAILED,"CreateOfferFailed",n,`[${n.toString()}]: Failed to create offer. `,e)},CreateAnswerFailed(n,e=""){return new g(k.WebrtcErrors.CREATE_ANSWER_FAILED,"CreateAnswerFailed",n,`[${n.toString()}]: Failed to create answer. `,e)},SetLocalDescriptionFailed(n,e=""){return new g(k.WebrtcErrors.SET_LOCAL_DESCRIPTION_FAILED,"SetLocalDescriptionFailed",n,`[${n.toString()}]: Failed to set offer. `,e)},SetRemoteDescriptionFailed(n,e=""){return new g(k.WebrtcErrors.SET_REMOTE_DESCRIPTION_FAILED,"SetRemoteDescriptionFailed",n,`[${n.toString()}]: Failed to set answer. `,e)},ICEFailure(n,e=""){return new g(k.WebrtcErrors.ICE_FAILURE,"ICEFailure",n,`[${n.toString()}]: Ice connection state FAILED`,e)}},WebsocketMethodErrors:{ServerErrors(n,e,t){return new g(n,"ServerErrors",e,t,t,!0)},AlreadyJoined(n,e=""){return new g(k.WebsocketMethodErrors.ALREADY_JOINED,"AlreadyJoined",n,"[JOIN]: You have already joined this room.",e)},CannotJoinPreviewInProgress(n,e=""){return new g(k.WebsocketMethodErrors.CANNOT_JOIN_PREVIEW_IN_PROGRESS,"CannotJoinPreviewInProgress",n,"[JOIN]: Cannot join if preview is in progress",e)}},GenericErrors:{NotConnected(n,e=""){return new g(k.GenericErrors.NOT_CONNECTED,"NotConnected",n,"Client is not connected",e)},Signalling(n,e){return new g(k.GenericErrors.SIGNALLING,"Signalling",n,`Unknown signalling error: ${n.toString()} ${e} `,e)},Unknown(n,e){return new g(k.GenericErrors.UNKNOWN,"Unknown",n,`Unknown exception: ${e}`,e)},NotReady(n,e=""){return new g(k.GenericErrors.NOT_READY,"NotReady",n,e,e)},JsonParsingFailed(n,e,t=""){return new g(k.GenericErrors.JSON_PARSING_FAILED,"JsonParsingFailed",n,`Failed to parse JSON message - ${e}`,t)},TrackMetadataMissing(n,e=""){return new g(k.GenericErrors.TRACK_METADATA_MISSING,"TrackMetadataMissing",n,"Track Metadata Missing",e)},RTCTrackMissing(n,e=""){return new g(k.GenericErrors.RTC_TRACK_MISSING,"RTCTrackMissing",n,"RTC Track missing",e)},PeerMetadataMissing(n,e=""){return new g(k.GenericErrors.PEER_METADATA_MISSING,"PeerMetadataMissing",n,"Peer Metadata Missing",e)},ValidationFailed(n,e){return new g(k.GenericErrors.INVALID_ROLE,"ValidationFailed",h.VALIDATION,n,e?JSON.stringify(e):"")},InvalidRole(n,e){return new g(k.GenericErrors.INVALID_ROLE,"InvalidRole",n,"Invalid role. Join with valid role",e,!0)},PreviewAlreadyInProgress(n,e=""){return new g(k.GenericErrors.PREVIEW_IN_PROGRESS,"PreviewAlreadyInProgress",n,"[Preview]: Cannot join if preview is in progress",e)},MissingMediaDevices(){return new g(k.GenericErrors.MISSING_MEDIADEVICES,"MissingMediaDevices",h.JOIN,"navigator.mediaDevices is undefined. 100ms SDK won't work on this website as WebRTC is not supported on HTTP endpoints(missing navigator.mediaDevices). Please ensure you're using the SDK either on localhost or a valid HTTPS endpoint.","",!0)},MissingRTCPeerConnection(){return new g(k.GenericErrors.MISSING_RTCPEERCONNECTION,"MissingRTCPeerConnection",h.JOIN,"RTCPeerConnection which is a core requirement for WebRTC call was not found, this could be due to an unsupported browser or browser extensions blocking WebRTC","",!0)}},MediaPluginErrors:{PlatformNotSupported(n,e=""){return new g(7001,"PlatformNotSupported",n,"Check HMS Docs to see the list of supported platforms",e)},InitFailed(n,e=""){return new g(7002,"InitFailed",n,"Plugin init failed",e)},ProcessingFailed(n,e=""){return new g(7003,"ProcessingFailed",n,"Plugin processing failed",e)},AddAlreadyInProgress(n,e=""){return new g(7004,"AddAlreadyInProgress",n,"Plugin add already in progress",e)}},PlaylistErrors:{NoEntryToPlay(n,e){return new g(k.PlaylistErrors.NO_ENTRY_TO_PLAY,"NoEntryToPlay",n,"Reached end of playlist",e)},NoEntryPlaying(n,e){return new g(k.PlaylistErrors.NO_ENTRY_IS_PLAYING,"NoEntryIsPlaying",n,"No entry is playing at this time",e)}}};var er="VALIDATIONS";function Z(n){return n!=null}var Et=()=>{if(!Z(RTCPeerConnection)){let n=p.GenericErrors.MissingRTCPeerConnection();throw o.e(er,n),n}},Mt=()=>{if(!Z(navigator.mediaDevices)){let n=p.GenericErrors.MissingMediaDevices();throw o.e(er,n),n}};function tr(n,e){var i;let t=ar(n.sdp);if(!((i=t.origin)==null?void 0:i.username.startsWith("mozilla")))return n;let r=Array.from(e.values());return t.media.forEach(a=>{var l,u,m;let s=(l=a.msid)==null?void 0:l.split(" ")[0],d=(u=r.find(T=>T.type===a.type&&T.stream_id===s))==null?void 0:u.track_id;d&&(a.msid=(m=a.msid)==null?void 0:m.replace(/\s(.+)/,` ${d}`))}),{type:n.type,sdp:Fr(t)}}function rr(n,e){var a;if(!(n==null?void 0:n.sdp)||!e)return;let r=ar(n.sdp).media.find(s=>Z(s.mid)&&parseInt(s.mid)===parseInt(e));return(a=r==null?void 0:r.msid)==null?void 0:a.split(" ")[1]}function ir(n){return n.sdp.includes("usedtx=1")?n:{type:n.type,sdp:n.sdp.replace("useinbandfec=1","useinbandfec=1;usedtx=1")}}var ge="HMSConnection",ve=class{constructor(e,t){this.candidates=new Array;this.role=e,this.signal=t}get iceConnectionState(){return this.nativeConnection.iceConnectionState}get connectionState(){return this.nativeConnection.connectionState}get action(){return this.role===W.Publish?h.PUBLISH:h.SUBSCRIBE}addTransceiver(e,t){return this.nativeConnection.addTransceiver(e,t)}createOffer(e=void 0,t){return c(this,null,function*(){try{let r=yield this.nativeConnection.createOffer(e);return o.d(ge,`[role=${this.role}] createOffer offer=${JSON.stringify(r,null,1)}`),ir(tr(r,t))}catch(r){throw p.WebrtcErrors.CreateOfferFailed(this.action,r.message)}})}createAnswer(e=void 0){return c(this,null,function*(){try{let t=yield this.nativeConnection.createAnswer(e);return o.d(ge,`[role=${this.role}] createAnswer answer=${JSON.stringify(t,null,1)}`),t}catch(t){throw p.WebrtcErrors.CreateAnswerFailed(this.action,t.message)}})}setLocalDescription(e){return c(this,null,function*(){try{o.d(ge,`[role=${this.role}] setLocalDescription description=${JSON.stringify(e,null,1)}`),yield this.nativeConnection.setLocalDescription(e)}catch(t){throw p.WebrtcErrors.SetLocalDescriptionFailed(this.action,t.message)}})}setRemoteDescription(e){return c(this,null,function*(){try{o.d(ge,`[role=${this.role}] setRemoteDescription description=${JSON.stringify(e,null,1)}`),yield this.nativeConnection.setRemoteDescription(e)}catch(t){throw p.WebrtcErrors.SetRemoteDescriptionFailed(this.action,t.message)}})}addIceCandidate(e){return c(this,null,function*(){o.d(ge,`[role=${this.role}] addIceCandidate candidate=${JSON.stringify(e,null,1)}`),yield this.nativeConnection.addIceCandidate(e)})}get remoteDescription(){return this.nativeConnection.remoteDescription}getSenders(){return this.nativeConnection.getSenders()}removeTrack(e){this.nativeConnection.removeTrack(e)}setMaxBitrate(e,t){return c(this,null,function*(){let r=this.getSenders().find(i=>{var a;return((a=i==null?void 0:i.track)==null?void 0:a.id)===t.getTrackIDBeingSent()});if(r){let i=r.getParameters();i.encodings.length>0&&(i.encodings[0].maxBitrate=e*1e3),yield r.setParameters(i)}else o.w(ge,`no sender found to setMaxBitrate for track - ${t.trackId}, sentTrackId - ${t.getTrackIDBeingSent()}`)})}getStats(){return c(this,null,function*(){return yield this.nativeConnection.getStats()})}close(){return c(this,null,function*(){this.nativeConnection.close()})}};var Se="renegotiation-callback-id",xe="ion-sfu",Oe=100,Ce=5,sr=60,nr=12e3,or=1e3,Te="SUBSCRIBE_ICE_CONNECTION_CALLBACK_ID",cr=6e4,dr=1e3,X={DEVICE_CHANGE:"device-change",LOCAL_AUDIO_ENABLED:"local-audio-enabled",LOCAL_VIDEO_ENABLED:"local-video-enabled",STATS_UPDATE:"stats-update",RTC_STATS_UPDATE:"rtc-stats-update",TRACK_DEGRADED:"track-degraded",TRACK_RESTORED:"track-restored",TRACK_AUDIO_LEVEL_UPDATE:"track-audio-level-update",LOCAL_AUDIO_SILENCE:"local-audio-silence"};var Gr="HMSPublishConnection",Ve=class extends ve{constructor(e,t,r,i){super(W.Publish,e);this.observer=r,this.transport=i,this.nativeConnection=new RTCPeerConnection(t),this.nativeConnection.createDataChannel(xe,{protocol:"SCTP"}),this.nativeConnection.onicecandidate=({candidate:a})=>{a&&e.trickle(this.role,a)},this.nativeConnection.oniceconnectionstatechange=()=>{this.observer.onIceConnectionChange(this.nativeConnection.iceConnectionState)},this.nativeConnection.onconnectionstatechange=()=>{this.observer.onConnectionStateChange(this.nativeConnection.connectionState)}}initAfterJoin(){this.nativeConnection.onnegotiationneeded=()=>c(this,null,function*(){o.d(Gr,"onnegotiationneeded"),yield this.observer.onRenegotiationNeeded()})}trackUpdate(e){this.transport.trackUpdate(e)}};var fe=class{constructor(e){this.tracks=new Array;this.nativeStream=e,this.id=e.id}};var re;(function(A){A[A.PEER_ADDED=0]="PEER_ADDED",A[A.PEER_REMOVED=1]="PEER_REMOVED",A[A.PEER_KNOCKED=2]="PEER_KNOCKED",A[A.ROOM_TYPE_CHANGED=3]="ROOM_TYPE_CHANGED",A[A.METADATA_UPDATED=4]="METADATA_UPDATED",A[A.SCREENSHARE_STARTED=5]="SCREENSHARE_STARTED",A[A.SCREENSHARE_STOPPED=6]="SCREENSHARE_STOPPED",A[A.DEFAULT_UPDATE=7]="DEFAULT_UPDATE",A[A.RECORDING_STATE_UPDATED=8]="RECORDING_STATE_UPDATED",A[A.BROWSER_RECORDING_STATE_UPDATED=9]="BROWSER_RECORDING_STATE_UPDATED",A[A.SERVER_RECORDING_STATE_UPDATED=10]="SERVER_RECORDING_STATE_UPDATED",A[A.RTMP_STREAMING_STATE_UPDATED=11]="RTMP_STREAMING_STATE_UPDATED",A[A.HLS_STREAMING_STATE_UPDATED=12]="HLS_STREAMING_STATE_UPDATED",A[A.ROOM_STATE=13]="ROOM_STATE"})(re||(re={}));var q;(function(S){S[S.PEER_JOINED=0]="PEER_JOINED",S[S.PEER_LEFT=1]="PEER_LEFT",S[S.AUDIO_TOGGLED=2]="AUDIO_TOGGLED",S[S.VIDEO_TOGGLED=3]="VIDEO_TOGGLED",S[S.BECAME_DOMINANT_SPEAKER=4]="BECAME_DOMINANT_SPEAKER",S[S.RESIGNED_DOMINANT_SPEAKER=5]="RESIGNED_DOMINANT_SPEAKER",S[S.STARTED_SPEAKING=6]="STARTED_SPEAKING",S[S.STOPPED_SPEAKING=7]="STOPPED_SPEAKING",S[S.ROLE_UPDATED=8]="ROLE_UPDATED",S[S.PEER_LIST=9]="PEER_LIST",S[S.NAME_UPDATED=10]="NAME_UPDATED",S[S.METADATA_UPDATED=11]="METADATA_UPDATED"})(q||(q={}));var L;(function(d){d[d.TRACK_ADDED=0]="TRACK_ADDED",d[d.TRACK_REMOVED=1]="TRACK_REMOVED",d[d.TRACK_MUTED=2]="TRACK_MUTED",d[d.TRACK_UNMUTED=3]="TRACK_UNMUTED",d[d.TRACK_DESCRIPTION_CHANGED=4]="TRACK_DESCRIPTION_CHANGED",d[d.TRACK_DEGRADED=5]="TRACK_DEGRADED",d[d.TRACK_RESTORED=6]="TRACK_RESTORED"})(L||(L={}));var lr;(function(e){e[e.DEFAULT=0]="DEFAULT"})(lr||(lr={}));var F;(function(i){i.NONE="none",i.LOW="low",i.MEDIUM="medium",i.HIGH="high"})(F||(F={}));var ur={f:F.HIGH,h:F.MEDIUM,q:F.LOW};var Fe;(function(r){r.VP8="vp8",r.VP9="vp9",r.H264="h264"})(Fe||(Fe={}));var Ge;(function(e){e.OPUS="opus"})(Ge||(Ge={}));var P;(function(t){t.audio="audio",t.video="video"})(P||(P={}));var ie=class extends fe{constructor(e,t){super(e);this.audio=!0;this.video=F.NONE;this.frameRate=F.HIGH;this.connection=t}setAudio(e){this.audio!==e&&(this.audio=e,this.syncWithApiChannel())}setVideoLayer(e){this.video=e,o.d(`[Remote stream] ${this.id}`,`Switching to ${e} layer`)}setVideo(e){if(this.video===e){o.d(`[Remote stream] ${this.id}`,`Already on ${e} layer`);return}this.setVideoLayer(e),this.syncWithApiChannel()}getSimulcastLayer(){return this.video}isAudioSubscribed(){return this.audio}isServerHandlingDegradation(){return this.connection.isServerHandlingDegradation}syncWithApiChannel(){let e={streamId:this.id,video:this.video,audio:this.audio,framerate:this.frameRate};this.connection.sendOverApiDataChannel(JSON.stringify(e))}};var Ue=class{constructor(e,t,r=""){this.TAG="HMSDataChannel";this.nativeChannel=e,this.observer=t,this.metadata=r,e.onmessage=i=>{this.observer.onMessage(i.data)}}get id(){return this.nativeChannel.id}get label(){return this.nativeChannel.label}get readyState(){return this.nativeChannel.readyState}send(e){o.d(this.TAG,`[${this.metadata}] Sending [size=${e.length}] message=${e}`),this.nativeChannel.send(e)}close(){this.nativeChannel.close()}};var le=class{get enabled(){return this.nativeTrack.enabled}get trackId(){return this.firstTrackId||this.sdpTrackId||this.nativeTrack.id}getMediaTrackSettings(){return this.nativeTrack.getSettings()}setEnabled(e){return c(this,null,function*(){this.nativeTrack.enabled=e})}constructor(e,t,r){this.stream=e,this.nativeTrack=t,this.source=r}setSdpTrackId(e){this.sdpTrackId=e}setFirstTrackId(e){this.firstTrackId=e}cleanup(){var e;(e=this.nativeTrack)==null||e.stop()}};var H;(function(t){t.AUDIO="audio",t.VIDEO="video"})(H||(H={}));var Re=class extends le{constructor(e,t,r){super(e,t,r);this.type=H.AUDIO;this.audioElement=null;if(t.kind!=="audio")throw new Error("Expected 'track' kind = 'audio'")}getVolume(){return this.audioElement?this.audioElement.volume*100:null}setVolume(e){if(e<0||e>100)throw Error("Please pass a valid number between 0-100");this.subscribeToAudio(e===0?!1:this.enabled),this.audioElement&&(this.audioElement.volume=e/100)}setAudioElement(e){this.audioElement=e}getAudioElement(){return this.audioElement}getOutputDevice(){return this.outputDevice}cleanup(){super.cleanup(),this.audioElement&&(this.audioElement.srcObject=null,this.audioElement.remove(),this.audioElement=null)}setOutputDevice(e){return c(this,null,function*(){var t;if(!this.audioElement){o.d("audio-track","no audio element to set output");return}try{typeof this.audioElement.setSinkId=="function"&&(yield(t=this.audioElement)==null?void 0:t.setSinkId(e.deviceId),this.outputDevice=e)}catch(r){o.d("audio-track",r)}})}removeSink(){var e;this.audioElement&&((e=window.HMS)==null?void 0:e.AUDIO_SINK)&&(this.audioElement.srcObject=null,this.subscribeToAudio(!1))}addSink(){var t,r;if(!this.nativeTrack||!this.audioElement||!((t=window.HMS)==null?void 0:t.AUDIO_SINK))return;let e=this.audioElement.srcObject;e!==null&&e instanceof MediaStream&&((r=e.getAudioTracks()[0])==null?void 0:r.id)===this.nativeTrack.id||(this.audioElement.srcObject=new MediaStream([this.nativeTrack]),this.subscribeToAudio(!0))}subscribeToAudio(e){this.stream instanceof ie&&this.stream.setAudio(e)}};var At=class extends Re{setEnabled(e){var t=r=>super[r];return c(this,null,function*(){e!==this.enabled&&(yield t("setEnabled").call(this,e),this.subscribeToAudio(e))})}};var be=class extends le{constructor(e,t,r){super(e,t,r);this.type=H.VIDEO;this.sinkCount=0;if(t.kind!=="video")throw new Error("Expected 'track' kind = 'video'")}hasSinks(){return this.sinkCount>0}addSink(e){this.addSinkInternal(e,this.nativeTrack)}removeSink(e){e.srcObject=null,this.sinkCount>0&&this.sinkCount--}addSinkInternal(e,t){var i;let r=e.srcObject;r!==null&&r instanceof MediaStream&&((i=r.getVideoTracks()[0])==null?void 0:i.id)===t.id||(e.srcObject=new MediaStream([t]),this.sinkCount++)}};var ue=class extends be{constructor(){super(...arguments);this._degraded=!1;this._degradedAt=null;this._layerDefinitions=[]}get degraded(){return this._degraded}get degradedAt(){return this._degradedAt}setEnabled(e){var t=r=>super[r];return c(this,null,function*(){e!==this.enabled&&(this._degraded&&!e&&(this._degraded=!1),yield t("setEnabled").call(this,e))})}preferLayer(e){this.stream.setVideo(e)}getSimulcastLayer(){return this.stream.getSimulcastLayer()}addSink(e){super.addSink(e),this.updateLayer()}removeSink(e){super.removeSink(e),this.updateLayer()}getSimulcastDefinitions(){return[...this._layerDefinitions]}setSimulcastDefinitons(e){this._layerDefinitions=e}setDegraded(e){if(this._degraded=e,e&&(this._degradedAt=new Date),this.stream instanceof ie&&this.stream.isServerHandlingDegradation()){let t=e?F.NONE:F.HIGH;this.stream.setVideoLayer(t);return}this.updateLayer()}updateLayer(){let e=this.hasSinks()?F.HIGH:F.NONE;this.degraded&&(e=F.NONE),this.stream.setVideo(e)}};var Be=class extends ve{constructor(e,t,r,i){super(W.Subscribe,e);this.TAG="[HMSSubscribeConnection]";this.remoteStreams=new Map;this.pendingMessageQueue=[];this.handlePendingApiMessages=()=>{this.pendingMessageQueue.length>0&&(o.d(this.TAG,"Found pending message queue, sending messages"),this.pendingMessageQueue.forEach(e=>this.sendOverApiDataChannel(e)),this.pendingMessageQueue.length=0)};this.observer=r,this.isServerHandlingDegradation=i,this.nativeConnection=new RTCPeerConnection(t),this.initNativeConnectionCallbacks()}initNativeConnectionCallbacks(){this.nativeConnection.oniceconnectionstatechange=()=>{this.observer.onIceConnectionChange(this.nativeConnection.iceConnectionState)},this.nativeConnection.onconnectionstatechange=()=>{this.observer.onConnectionStateChange(this.nativeConnection.connectionState)},this.nativeConnection.ondatachannel=e=>{e.channel.label===xe&&(this.apiChannel=new Ue(e.channel,{onMessage:t=>{this.observer.onApiChannelMessage(t)}},`role=${this.role}`),e.channel.onopen=this.handlePendingApiMessages)},this.nativeConnection.onicecandidate=e=>{e.candidate!==null&&this.signal.trickle(this.role,e.candidate)},this.nativeConnection.ontrack=e=>{var l;let t=e.streams[0],r=t.id;if(!this.remoteStreams.has(r)){let u=new ie(t,this);this.remoteStreams.set(r,u),t.onremovetrack=m=>{let T=u.tracks.findIndex(S=>S.nativeTrack.id===m.track.id);if(T>=0){let S=u.tracks[T];this.observer.onTrackRemove(S),u.tracks.splice(T,1),u.tracks.length===0&&this.remoteStreams.delete(r)}}}let i=this.remoteStreams.get(r),a=e.track.kind==="audio"?At:ue,s=new a(i,e.track),d=rr(this.remoteDescription,(l=e.transceiver)==null?void 0:l.mid);d&&s.setSdpTrackId(d),i.tracks.push(s),this.observer.onTrackAdd(s)}}sendOverApiDataChannel(e){this.apiChannel&&this.apiChannel.readyState==="open"?this.apiChannel.send(e):(o.w(this.TAG,`API Data channel not ${this.apiChannel?"open":"present"}, queueing`,e),this.pendingMessageQueue.push(e))}close(){var e=t=>super[t];return c(this,null,function*(){var r;yield e("close").call(this),(r=this.apiChannel)==null||r.close()})}};import{UAParser as Br}from"ua-parser-js";var qe="0.1.44";var He=new Br,pr,ke=typeof window=="undefined"&&!((pr=He.getBrowser().name)==null?void 0:pr.toLowerCase().includes("electron")),Ee=typeof window!="undefined",qr=()=>!ke,ja=qr();function $r(){if(ke)return`hmsclient/${qe}`;let n=He.getDevice(),e=He.getBrowser(),t=He.getOS();return n.type?`hmsclient/${qe} ${t.name}/${t.version} (${n.vendor}_${n.type}_/_${e.name}_${e.version})`:`hmsclient/${qe} ${t.name}/${t.version} (${e.name}_${e.version})`}var hr=()=>He.getDevice().type==="mobile",$e=$r();var yt="InitService",Ke=class{static fetchInitConfig(e,t,r="https://prod-init.100ms.live",i=""){return c(this,null,function*(){o.d(yt,`fetchInitConfig: initEndpoint=${r} token=${e} peerId=${t} region=${i} `);let a=Kr(r,t,i),s,d;try{s=yield fetch(a,{headers:{Authorization:`Bearer ${e}`}});let l=yield s.json();if(s.status===404)throw p.InitAPIErrors.EndpointUnreachable(h.INIT,l.message||s.statusText);if((s==null?void 0:s.status)!==200)throw p.InitAPIErrors.ServerErrors(l.code||s.status,h.INIT,l.message||(s==null?void 0:s.statusText));d=l,o.d(yt,`config is ${JSON.stringify(d,null,2)}`)}catch(l){let u=l;throw u.message==="Failed to fetch"||u.message.includes("NetworkError")?p.InitAPIErrors.EndpointUnreachable(h.INIT,u.message):u}return Wr(d)})}};function Kr(n,e,t){try{let r=new URL("/init",n);return t&&t.trim().length>0&&r.searchParams.set("region",t.trim()),r.searchParams.set("peer_id",e),r.searchParams.set("user_agent",$e),r.toString()}catch(r){let i=r;throw o.e(yt,i.name,i.message),i}}function Wr(n){return x(v({},n),{rtcConfiguration:x(v({},n.rtcConfiguration),{iceServers:n.rtcConfiguration.ice_servers})})}import{v4 as jr}from"uuid";var C;(function(M){M.JOIN="join",M.OFFER="offer",M.ANSWER="answer",M.TRICKLE="trickle",M.TRACK_UPDATE="track-update",M.BROADCAST="broadcast",M.ANALYTICS="analytics",M.SERVER_ERROR="on-error",M.SERVER_WARNING="on-warning",M.SDK_NOTIFICATION="sdk-notification",M.LEAVE="leave",M.END_ROOM="end-room",M.PING="ping",M.ROLE_CHANGE_REQUEST="role-change-request",M.ROLE_CHANGE="role-change",M.TRACK_UPDATE_REQUEST="track-update-request",M.PEER_LEAVE_REQUEST="peer-leave-request",M.CHANGE_TRACK_MUTE_STATE_REQUEST="change-track-mute-state-request",M.START_RTMP_OR_RECORDING_REQUEST="rtmp-start",M.STOP_RTMP_AND_RECORDING_REQUEST="rtmp-stop",M.UPDATE_PEER_METADATA="peer-update",M.START_HLS_STREAMING="hls-start",M.STOP_HLS_STREAMING="hls-stop"})(C||(C={}));function mr(n){switch(n){case C.JOIN:return h.JOIN;case C.OFFER:return h.PUBLISH;case C.ANSWER:return h.SUBSCRIBE;case C.TRACK_UPDATE:return h.TRACK;default:return h.NONE}}var We=class{constructor(e){this.TAG="[ SIGNAL ]: ";this.isJoinCompleted=!1;this.pendingTrickle=[];this.socket=null;this.callbacks=new Map;this._isConnected=!1;this.id=0;this.observer=e,window.addEventListener("offline",()=>{o.d(this.TAG,"Window network offline"),this.isConnected=!1}),window.addEventListener("online",()=>{o.d(this.TAG,"Window network online")}),this.onCloseHandler=this.onCloseHandler.bind(this),this.onMessageHandler=this.onMessageHandler.bind(this)}get isConnected(){return this._isConnected}set isConnected(e){o.d(this.TAG,"isConnected set",{id:this.id,old:this._isConnected,new:e}),this._isConnected!==e&&(this._isConnected&&!e?(this._isConnected=e,this.observer.onOffline()):!this._isConnected&&e&&(this._isConnected=e,this.observer.onOnline()))}call(e,t){return c(this,null,function*(){let r=jr(),i={method:e,params:t,id:r,jsonrpc:"2.0"};this.socket.send(JSON.stringify(i));try{return yield new Promise((s,d)=>{this.callbacks.set(r,{resolve:s,reject:d})})}catch(a){let s=a;throw p.WebsocketMethodErrors.ServerErrors(Number(s.code),mr(e),s.message)}})}notify(e,t){let r={method:e,params:t};this.socket.send(JSON.stringify(r))}open(e){return new Promise((t,r)=>{this.socket&&(this.socket.removeEventListener("close",this.onCloseHandler),this.socket.removeEventListener("message",this.onMessageHandler)),this.socket=new WebSocket(e);let i=s=>{o.e(this.TAG,"Error from websocket",s),r(p.WebSocketConnectionErrors.GenericConnect(h.JOIN,`Error opening socket connection - ${s}`))};this.socket.addEventListener("error",i);let a=()=>{t(),this.isConnected=!0,this.id++,this.socket.removeEventListener("open",a),this.socket.removeEventListener("error",i),this.pingPongLoop(this.id)};this.socket.addEventListener("open",a),this.socket.addEventListener("close",this.onCloseHandler),this.socket.addEventListener("message",this.onMessageHandler)})}close(){return c(this,null,function*(){let e=new Promise(t=>{this.socket.addEventListener("close",()=>t())});return this.socket.close(1e3,"Normal Close"),this.isConnected=!1,this.socket.removeEventListener("close",this.onCloseHandler),this.socket.removeEventListener("message",this.onMessageHandler),e})}join(e,t,r,i,a){return c(this,null,function*(){let s={name:e,disableVidAutoSub:i,data:t,offer:r,server_sub_degrade:a},d=yield this.call(C.JOIN,s);return this.isJoinCompleted=!0,this.pendingTrickle.forEach(({target:l,candidate:u})=>this.trickle(l,u)),this.pendingTrickle.length=0,o.d(this.TAG,`join: response=${JSON.stringify(d,null,1)}`),d})}trickle(e,t){this.isJoinCompleted?this.notify(C.TRICKLE,{target:e,candidate:t}):this.pendingTrickle.push({target:e,candidate:t})}offer(e,t){return c(this,null,function*(){return yield this.call(C.OFFER,{desc:e,tracks:Object.fromEntries(t)})})}answer(e){this.notify(C.ANSWER,{desc:e})}trackUpdate(e){this.notify(C.TRACK_UPDATE,{version:"1.0",tracks:Object.fromEntries(e)})}broadcast(e){return c(this,null,function*(){yield this.call(C.BROADCAST,v({version:"1.0"},e.toSignalParams()))})}leave(){this.notify(C.LEAVE,{version:"1.0"})}endRoom(e,t){return c(this,null,function*(){yield this.call(C.END_ROOM,{lock:e,reason:t})})}sendEvent(e){if(!this.isConnected)throw Error(`${this.TAG} not connected. Could not send event ${e}`);this.notify(C.ANALYTICS,e.toSignalParams())}ping(e){let t=Date.now(),r=new Promise(a=>{setTimeout(()=>{a(Date.now()-t)},e+1)}),i=this.call(C.PING,{timestamp:t}).then(()=>Date.now()-t).catch(()=>Date.now()-t);return Promise.race([r,i])}requestRoleChange(e){return c(this,null,function*(){yield this.call(C.ROLE_CHANGE_REQUEST,e)})}acceptRoleChangeRequest(e){return c(this,null,function*(){yield this.call(C.ROLE_CHANGE,e)})}requestTrackStateChange(e){return c(this,null,function*(){yield this.call(C.TRACK_UPDATE_REQUEST,e)})}requestMultiTrackStateChange(e){return c(this,null,function*(){yield this.call(C.CHANGE_TRACK_MUTE_STATE_REQUEST,e)})}removePeer(e){return c(this,null,function*(){yield this.call(C.PEER_LEAVE_REQUEST,e)})}startRTMPOrRecording(e){return c(this,null,function*(){yield this.call(C.START_RTMP_OR_RECORDING_REQUEST,v({version:"1.0"},e))})}stopRTMPAndRecording(){return c(this,null,function*(){yield this.call(C.STOP_RTMP_AND_RECORDING_REQUEST,{version:"1.0"})})}startHLSStreaming(e){return c(this,null,function*(){yield this.call(C.START_HLS_STREAMING,v({version:"1.0"},e))})}stopHLSStreaming(e){return c(this,null,function*(){yield this.call(C.STOP_HLS_STREAMING,v({version:"1.0"},e))})}updatePeer(e){return c(this,null,function*(){yield this.call(C.UPDATE_PEER_METADATA,v({version:"1.0"},e))})}onCloseHandler(e){o.d(`Websocket closed code=${e.code}`),this.isConnected=!1}onMessageHandler(e){let t=e.data,r=JSON.parse(t);if(r.id)this.handleResponseWithId(r);else if(r.method)this.handleResponseWithMethod(r);else throw Error(`WebSocket message has no 'method' or 'id' field, message=${r}`)}handleResponseWithId(e){let t=e,r=t.id;if(this.callbacks.has(r)){let i=this.callbacks.get(r);this.callbacks.delete(r),t.result?i.resolve(t.result):i.reject(t.error)}else this.observer.onNotification(t)}handleResponseWithMethod(e){switch(e.method){case C.OFFER:this.observer.onOffer(e.params);break;case C.TRICKLE:this.observer.onTrickle(e.params);break;case C.SERVER_ERROR:this.observer.onServerError(p.WebsocketMethodErrors.ServerErrors(Number(e.params.code),h.NONE,e.params.message));break;case C.SERVER_WARNING:o.w(this.TAG,e.params);break;default:this.observer.onNotification(e);break}}pingPongLoop(e){return c(this,null,function*(){var r,i;let t=((r=window.HMS)==null?void 0:r.PING_TIMEOUT)||nr;if(this.isConnected)if((yield this.ping(t))>t){let s=!1;typeof document!==void 0&&document.hidden&&(s=!0),o.d(this.TAG,`Pong timeout ${e}, pageHidden=${s}`),this.id===e&&(this.isConnected=!1)}else setTimeout(()=>this.pingPongLoop(e),((i=window.HMS)==null?void 0:i.PING_INTERVAL)||or)})}};var j=class{constructor(){this._volume=1;this._codec=Ge.OPUS;this._maxBitrate=32;this._deviceId="default";this._advanced=[{googEchoCancellation:{exact:!0}},{googExperimentalEchoCancellation:{exact:!0}},{autoGainControl:{exact:!0}},{noiseSuppression:{exact:!0}},{googHighpassFilter:{exact:!0}},{googAudioMirroring:{exact:!0}}]}volume(e){if(!(0<=e&&e<=1))throw Error("volume can only be in range [0.0, 1.0]");return this._volume=e,this}codec(e){return this._codec=e,this}maxBitrate(e){if(e&&e<=0)throw Error("maxBitrate should be >= 1");return this._maxBitrate=e,this}deviceId(e){return this._deviceId=e,this}advanced(e){return this._advanced=e,this}build(){return new Me(this._volume,this._codec,this._maxBitrate,this._deviceId,this._advanced)}},Me=class{constructor(e,t,r,i,a){this.volume=e,this.codec=t,this.maxBitrate=r,this.deviceId=i,this.advanced=a}toConstraints(){return{deviceId:this.deviceId,advanced:this.advanced}}toAnalyticsProperties(){return{audio_bitrate:this.maxBitrate,audio_codec:this.codec}}};var U=class{constructor(){this._width=320;this._height=180;this._codec=Fe.VP8;this._maxFramerate=30;this._maxBitrate=150;this._advanced=[]}setWidth(e){return this._width=e,this}setHeight(e){return this._height=e,this}codec(e){return this._codec=e,this}maxFramerate(e){if(e&&e<=0)throw Error("maxFramerate should be >= 1");return this._maxFramerate=e,this}maxBitrate(e,t=!0){if(typeof e=="number"&&e<=0)throw Error("maxBitrate should be >= 1");return this._maxBitrate=e,!this._maxBitrate&&t&&(this._maxBitrate=15e4),this}deviceId(e){return this._deviceId=e,this}advanced(e){return this._advanced=e,this}build(){return new Ae(this._width,this._height,this._codec,this._maxFramerate,this._deviceId,this._advanced,this._maxBitrate)}},Ae=class{constructor(e,t,r,i,a,s,d){this.width=e,this.height=t,this.codec=r,this.maxFramerate=i,this.maxBitrate=d,this.deviceId=a,this.advanced=s}toConstraints(){return{width:this.width,height:this.height,frameRate:this.maxFramerate,deviceId:this.deviceId}}toAnalyticsProperties(){return{width:this.width,height:this.height,video_bitrate:this.maxBitrate,framerate:this.maxFramerate,video_codec:this.codec}}};var je=class{constructor(){this._video=new U().build();this._audio=new j().build();this._screen=new U().build();this._simulcast=!1}video(e){return this._video=e,this}audio(e){return this._audio=e,this}screen(e){return this._screen=e,this}simulcast(e){return this._simulcast=e,this}build(){if(this._audio===null&&this._video===null)throw p.TracksErrors.NothingToReturn(h.TRACK);if(this._video===null&&this._simulcast)throw p.TracksErrors.InvalidVideoSettings(h.TRACK,"Cannot enable simulcast when no video settings are provided");return new ye(this._video,this._audio,this._simulcast,this._screen||void 0)}},ye=class{constructor(e,t,r,i=null){this.video=e,this.audio=t,this.simulcast=r,this.screen=i}toAnalyticsProperties(){let e={audio_enabled:this.audio!==null,video_enabled:this.video!==null};return this.audio&&(e=v(v({},this.audio.toAnalyticsProperties()),e)),this.video&&(e=v(v({},this.video.toAnalyticsProperties()),e)),e}};import{EventEmitter2 as ai}from"eventemitter2";var y;(function(f){f.ROOM_STATE="room-state",f.PEER_JOIN="on-peer-join",f.PEER_LEAVE="on-peer-leave",f.PEER_LIST="peer-list",f.TRACK_METADATA_ADD="on-track-add",f.TRACK_UPDATE="on-track-update",f.CHANGE_TRACK_MUTE_STATE_UPDATE="on-change-track-mute-state-request",f.ACTIVE_SPEAKERS="active-speakers",f.SFU_STATS="sfu-stats",f.ON_SFU_TRACK_LAYER_UPDATE="on-track-layer-update",f.BROADCAST="on-broadcast",f.ROLE_CHANGE="on-role-change",f.POLICY_CHANGE="on-policy-change",f.ROLE_CHANGE_REQUEST="on-role-change-request",f.TRACK_UPDATE_REQUEST="on-track-update-request",f.PEER_UPDATE="on-peer-update",f.PEER_LEAVE_REQUEST="on-peer-leave-request",f.UNSUPPORTED="unsupported",f.RTMP_START="on-rtmp-start",f.RTMP_STOP="on-rtmp-stop",f.RECORDING_START="on-record-start",f.RECORDING_STOP="on-record-stop",f.HLS_START="on-hls-start",f.HLS_STOP="on-hls-stop"})(y||(y={}));var Pt=class{constructor(e,t,r){this.store=e;this.listener=t;this.audioListener=r}handleActiveSpeakers(e){var a,s,d;let t=e["speaker-list"],r=t.map(l=>({audioLevel:l.level,peer:this.store.getPeerById(l.peer_id),track:this.store.getTrackById(l.track_id)}));(a=this.audioListener)==null||a.onAudioLevelUpdate(r),this.store.updateSpeakers(r);let i=t[0];if(i){let l=this.store.getPeerById(i.peer_id);(s=this.listener)==null||s.onPeerUpdate(q.BECAME_DOMINANT_SPEAKER,l)}else(d=this.listener)==null||d.onPeerUpdate(q.RESIGNED_DOMINANT_SPEAKER,null)}};var Pe=class{constructor({sender:e,message:t,type:r="chat",recipientPeer:i,recipientRoles:a,time:s}){this.sender=e,this.message=t,this.type=r,this.recipientPeer=i,this.recipientRoles=a,this.time=s}toSignalParams(){var i,a;let e=(i=this.recipientRoles)==null?void 0:i.map(s=>s.name),t=(a=this.recipientPeer)==null?void 0:a.peerId,r={info:{sender:this.sender.peerId,message:this.message,type:this.type}};return(e==null?void 0:e.length)&&(r.roles=e),t&&(r.peer_id=t),r}};var ae=class{constructor({peerId:e,name:t,isLocal:r,customerUserId:i,metadata:a,role:s}){this.customerUserId="";this.metadata="";this.auxiliaryTracks=[];this.name=t,this.peerId=e,this.isLocal=r,this.customerUserId=i,this.metadata=a,s&&(this.role=s)}updateRole(e){this.role=e}updateName(e){this.name=e}updateMetadata(e){this.metadata=e}};import{v4 as Jr}from"uuid";var we=class{};we.makePeerId=()=>Jr();var Je=class extends ae{constructor(e){super(x(v({},e),{peerId:we.makePeerId(),isLocal:!0}));this.isLocal=!0;this.auxiliaryTracks=[]}};var Ye=class extends ae{constructor(e){super(x(v({},e),{isLocal:!1}));this.isLocal=!1;this.auxiliaryTracks=[]}};var It=class{constructor(e,t){this.store=e;this.listener=t}get TAG(){return`[${this.constructor.name}]`}handleNotification(e,t){e===y.BROADCAST&&this.handleBroadcast(t)}handleBroadcast(e){var u;let t=e.peer,r=e.info,i=e.roles,a=this.store.getPeerById(t.peer_id);a||(a=new ae({peerId:t.peer_id,name:t.info.name,isLocal:!1,customerUserId:t.info.user_id,metadata:t.info.data}));let s=e.private?this.store.getLocalPeer():void 0,d=[];if(i==null?void 0:i.length){let m=this.store.getKnownRoles();for(let T of i)m[T]&&d.push(m[T])}let l=new Pe(x(v({},r),{sender:a,recipientRoles:d,recipientPeer:s,time:new Date(e.timestamp)}));o.d(this.TAG,"Received Message:: ",l),(u=this.listener)==null||u.onMessageReceived(l)}};var Ct=class{constructor(e,t,r,i){this.store=e;this.peerManager=t;this.trackManager=r;this.listener=i;this.handleInitialPeerList=e=>{let t=Object.values(e.peers);this.peerManager.handlePeerList(t)};this.handleReconnectPeerList=e=>{this.handleRepeatedPeerList(e.peers)};this.handlePreviewRoomState=e=>{if(!this.store.hasRoleDetailsArrived())return;let t=e.peers||{};Object.keys(t).forEach(r=>{t[r].tracks={}}),this.handleRepeatedPeerList(t)};this.handleRepeatedPeerList=e=>{let t=this.store.getRemotePeers(),r=Object.values(e),i=t.filter(a=>!e[a.peerId]);o.d(this.TAG,{peersToRemove:i}),i.forEach(a=>{var d;let s={peer_id:a.peerId,role:((d=a.role)==null?void 0:d.name)||"",info:{name:a.name,data:a.metadata||"",user_id:a.customerUserId||""},tracks:{}};this.peerManager.handlePeerLeave(s)}),r.forEach(a=>{let s=this.store.getPeerById(a.peer_id),d=Object.values(a.tracks);s?(this.store.getPeerTracks(s.peerId).forEach(u=>{var m;a.tracks[u.trackId]||(this.removePeerTrack(s,u.trackId),(m=this.listener)==null||m.onTrackUpdate(L.TRACK_REMOVED,u,s))}),d.forEach(u=>{this.store.getTrackById(u.track_id)||this.store.setTrackState({peerId:s.peerId,trackInfo:u})}),this.trackManager.handleTrackUpdate({peer:{info:a.info,peer_id:a.peer_id},tracks:a.tracks}),this.peerManager.handlePeerUpdate(a)):this.peerManager.handlePeerJoin(a)})}}get TAG(){return`[${this.constructor.name}]`}handleNotification(e,t,r){if(e===y.PEER_LIST){let i=t;r?(o.d(this.TAG,"RECONNECT_PEER_LIST event",i),this.handleReconnectPeerList(i)):(o.d(this.TAG,"PEER_LIST event",i),this.handleInitialPeerList(i))}else if(e===y.ROOM_STATE){let i=t;this.handlePreviewRoomState(i)}}removePeerTrack(e,t){var r,i;if(((r=e.audioTrack)==null?void 0:r.trackId)===t)e.audioTrack=void 0;else if(((i=e.videoTrack)==null?void 0:i.trackId)===t)e.videoTrack=void 0;else{let a=e.auxiliaryTracks.findIndex(s=>s.trackId===t);a>=0&&e.auxiliaryTracks.splice(a,1)}}};var Rt=class{constructor(e,t,r){this.store=e;this.trackManager=t;this.listener=r;this.handlePeerList=e=>{var r;if(e.length===0)return;let t=[];for(let i of e)t.push(this.makePeer(i));(r=this.listener)==null||r.onPeerUpdate(q.PEER_LIST,t),this.trackManager.processPendingTracks()};this.handlePeerJoin=e=>{var r;let t=this.makePeer(e);(r=this.listener)==null||r.onPeerUpdate(q.PEER_JOINED,t),this.trackManager.processPendingTracks()};this.handlePeerLeave=e=>{var r,i,a,s;let t=this.store.getPeerById(e.peer_id);this.store.removePeer(e.peer_id),o.d(this.TAG,"PEER_LEAVE event",e,this.store.getPeers()),!!t&&(t.audioTrack&&((r=this.listener)==null||r.onTrackUpdate(L.TRACK_REMOVED,t.audioTrack,t)),t.videoTrack&&((i=this.listener)==null||i.onTrackUpdate(L.TRACK_REMOVED,t.videoTrack,t)),(a=t.auxiliaryTracks)==null||a.forEach(d=>{var l;(l=this.listener)==null||l.onTrackUpdate(L.TRACK_REMOVED,d,t)}),(s=this.listener)==null||s.onPeerUpdate(q.PEER_LEFT,t))}}get TAG(){return`[${this.constructor.name}]`}handleNotification(e,t){switch(e){case y.PEER_JOIN:{let r=t;this.handlePeerJoin(r);break}case y.PEER_LEAVE:{let r=t;this.handlePeerLeave(r);break}case y.PEER_UPDATE:this.handlePeerUpdate(t);break;default:break}}handlePeerUpdate(e){var r;let t=this.store.getPeerById(e.peer_id);if(!!t){if(t.role&&t.role.name!==e.role){let i=this.store.getPolicyForRole(e.role);t.updateRole(i),(r=this.listener)==null||r.onPeerUpdate(q.ROLE_UPDATED,t)}this.handlePeerInfoUpdate(v({peer:t},e.info))}}handlePeerInfoUpdate({peer:e,name:t,data:r}){var i,a;!e||(t&&e.name!==t&&(e.updateName(t),(i=this.listener)==null||i.onPeerUpdate(q.NAME_UPDATED,e)),r&&e.metadata!==r&&(e.updateMetadata(r),(a=this.listener)==null||a.onPeerUpdate(q.METADATA_UPDATED,e)))}makePeer(e){let t=new Ye({peerId:e.peer_id,name:e.info.name,customerUserId:e.info.user_id,metadata:e.info.data,role:this.store.getPolicyForRole(e.role)});this.store.addPeer(t),o.d(this.TAG,"adding to the peerList",t);for(let r in e.tracks)this.store.setTrackState({peerId:e.peer_id,trackInfo:e.tracks[r]});return t}};var bt=class{constructor(e,t){this.store=e;this.eventEmitter=t}handlePolicyChange(e){var i,a;let t=this.store.getLocalPeer();if(t&&!t.role){let s=e.known_roles[e.name];t.updateRole(s)}this.store.setKnownRoles(e.known_roles);let r=(i=e.known_roles[e.name])==null?void 0:i.publishParams;if(this.store.setPublishParams(r),this.setSimulcastLayers(r),this.handleStreamingRecordingPermissions((a=e.known_roles[e.name])==null?void 0:a.permissions),(t==null?void 0:t.role)&&t.role.name!==e.name){let s=this.store.getPolicyForRole(e.name),d=t.role;t.updateRole(s),this.eventEmitter.emit("local-peer-role-update",{detail:{oldRole:d,newRole:s}})}this.eventEmitter.emit("policy-change",{detail:{params:e}})}setSimulcastLayers(e){if(e&&Object.keys(e).length>0){let{videoSimulcastLayers:t,screenSimulcastLayers:r}=e;this.store.setVideoSimulcastLayers(t),this.store.setScreenshareSimulcastLayers(r)}}handleStreamingRecordingPermissions(e){e&&(e.recording===void 0&&(e.recording=!0),e.streaming===void 0&&(e.streaming=!0))}};var Ht=class{constructor(e,t){this.store=e;this.listener=t}handleNotification(e,t){switch(e){case y.ROLE_CHANGE_REQUEST:this.handleRoleChangeRequest(t);break;case y.TRACK_UPDATE_REQUEST:this.handleTrackUpdateRequest(t);break;case y.CHANGE_TRACK_MUTE_STATE_UPDATE:this.handleChangeTrackStateRequest(t);break;default:return}}handleRoleChangeRequest(e){var r;let t={requestedBy:this.store.getPeerById(e.requested_by),role:this.store.getPolicyForRole(e.role),token:e.token};(r=this.listener)==null||r.onRoleChangeRequest(t)}handleTrackUpdateRequest(e){let{requested_by:t,track_id:r,mute:i}=e,a=this.store.getPeerById(t),s=this.store.getLocalPeerTracks().find(l=>l.publishedTrackId===r);if(!a||a.isLocal||!s)return;let d=()=>{var l;(l=this.listener)==null||l.onChangeTrackStateRequest({requestedBy:a,track:s,enabled:!i})};if(i){if(s.enabled===!i)return;s.setEnabled(!i).then(d)}else d()}handleChangeTrackStateRequest(e){var u;let{type:t,source:r,value:i,requested_by:a}=e,s=this.store.getPeerById(a);if(!s)return;let d=!i,l=this.getTracksToBeUpdated({type:t,source:r,enabled:d});if(l.length!==0)if(d)(u=this.listener)==null||u.onChangeMultiTrackStateRequest({requestedBy:s,tracks:l,type:t,source:r,enabled:!0});else{let m=[];for(let T of l)m.push(T.setEnabled(!1));Promise.all(m).then(()=>{var T;(T=this.listener)==null||T.onChangeMultiTrackStateRequest({requestedBy:s,tracks:l,enabled:!1})})}}getTracksToBeUpdated({type:e,source:t,enabled:r}){let a=this.store.getLocalPeerTracks();return e&&(a=a.filter(s=>s.type===e)),t&&(a=a.filter(s=>s.source===t)),a.filter(s=>s.enabled!==r)}};var wt=class{constructor(e,t){this.store=e;this.listener=t}handleNotification(e,t){switch(e){case y.PEER_LIST:this.onRoomState(t.room);break;case y.RTMP_START:this.onRTMPStart(t);break;case y.RTMP_STOP:this.onRTMPStop(t);break;case y.RECORDING_START:this.onRecordingStart(t);break;case y.RECORDING_STOP:this.onRecordingStop(t);break;case y.ROOM_STATE:this.handlePreviewRoomState(t);break;default:this.onHLS(e,t);break}}handlePreviewRoomState(e){let{room:t}=e;this.onRoomState(t,e.peer_count)}onRoomState(e,t){var u,m,T;let{recording:r,streaming:i,session_id:a,started_at:s,name:d}=e,l=this.store.getRoom();l.peerCount=t,l.name=d,l.recording.server.running=!!(r==null?void 0:r.sfu.enabled),l.recording.browser.running=!!(r==null?void 0:r.browser.enabled),l.rtmp.running=!!((u=i==null?void 0:i.rtmp)==null?void 0:u.enabled),l.rtmp.startedAt=this.getAsDate((m=i==null?void 0:i.rtmp)==null?void 0:m.started_at),l.recording.server.startedAt=this.getAsDate(r==null?void 0:r.sfu.started_at),l.recording.browser.startedAt=this.getAsDate(r==null?void 0:r.browser.started_at),l.recording.hls=this.getHLSRecording(i==null?void 0:i.hls),l.hls=this.convertHls(i==null?void 0:i.hls),l.sessionId=a,l.startedAt=this.getAsDate(s),(T=this.listener)==null||T.onRoomUpdate(re.RECORDING_STATE_UPDATED,l)}getAsDate(e){return e?new Date(e):void 0}onRTMPStart(e){var t;this.setRTMPStatus(!((t=e.error)==null?void 0:t.code),e)}onRTMPStop(e){this.setRTMPStatus(!1,e)}onRecordingStart(e){var t;this.setRecordingStatus(!((t=e.error)==null?void 0:t.code),e)}onRecordingStop(e){this.setRecordingStatus(!1,e)}onHLS(e,t){var i,a;if(![y.HLS_START,y.HLS_STOP].includes(e))return;let r=this.store.getRoom();t.enabled=e===y.HLS_START&&!((i=t.error)==null?void 0:i.code),r.hls=this.convertHls(t),r.recording.hls=this.getHLSRecording(t),(a=this.listener)==null||a.onRoomUpdate(re.HLS_STREAMING_STATE_UPDATED,r)}convertHls(e){var r,i;let t={running:!!(e==null?void 0:e.enabled),variants:[],error:((r=e==null?void 0:e.error)==null?void 0:r.code)?e.error:void 0};return(i=e==null?void 0:e.variants)==null||i.forEach(a=>{t.variants.push({meetingURL:a.meeting_url,url:a.url,metadata:a.metadata,startedAt:this.getAsDate(a.started_at)})}),t}getHLSRecording(e){var r,i,a,s;let t={running:!1};return(e==null?void 0:e.hls_recording)&&(t={running:!!(e==null?void 0:e.enabled),singleFilePerLayer:!!((r=e.hls_recording)==null?void 0:r.single_file_per_layer),hlsVod:!!((i=e.hls_recording)==null?void 0:i.hls_vod),startedAt:this.getAsDate((a=e==null?void 0:e.variants)==null?void 0:a[0].started_at),error:((s=e==null?void 0:e.error)==null?void 0:s.code)?e.error:void 0}),t}setRecordingStatus(e,t){var a,s,d;let r=this.store.getRoom(),i;t.type==="sfu"?(r.recording.server={running:e,startedAt:e?this.getAsDate(t.started_at):void 0,error:((a=t.error)==null?void 0:a.code)?t.error:void 0},i=re.SERVER_RECORDING_STATE_UPDATED):(r.recording.browser={running:e,startedAt:e?this.getAsDate(t.started_at):void 0,error:((s=t.error)==null?void 0:s.code)?t.error:void 0},i=re.BROWSER_RECORDING_STATE_UPDATED),(d=this.listener)==null||d.onRoomUpdate(i,r)}setRTMPStatus(e,t){var i,a;let r=this.store.getRoom();r.rtmp={running:e,startedAt:e?this.getAsDate(t.started_at):void 0,error:((i=t.error)==null?void 0:i.code)?t.error:void 0},(a=this.listener)==null||a.onRoomUpdate(re.RTMP_STREAMING_STATE_UPDATED,r)}};import Yr from"webrtc-adapter";var $;(function(i){i.AUDIO="audio",i.VIDEO="video",i.AV="audio, video",i.SCREEN="screen"})($||($={}));function zr(n,e){let t=n.message.toLowerCase();if(e==="screen"&&Yr.browserDetails.browser==="chrome"&&n.name==="NotAllowedError"&&n.message.includes("denied by system"))return p.TracksErrors.DeviceNotAvailable(h.TRACK,e,n.message);switch(n.name){case"OverconstrainedError":return p.TracksErrors.OverConstrained(h.TRACK,e,n.constraint);case"NotAllowedError":return p.TracksErrors.CantAccessCaptureDevice(h.TRACK,e,n.message);case"NotFoundError":return p.TracksErrors.DeviceNotAvailable(h.TRACK,e,n.message);case"NotReadableError":return p.TracksErrors.DeviceInUse(h.TRACK,e,n.message);case"TypeError":return p.TracksErrors.NothingToReturn(h.TRACK,n.message);default:return t.includes("device not found")?p.TracksErrors.DeviceNotAvailable(h.TRACK,e,n.message):t.includes("permission denied")?p.TracksErrors.CantAccessCaptureDevice(h.TRACK,e,n.message):p.TracksErrors.GenericTrack(h.TRACK,n.message)}}function Y(n,e){let t=zr(n,e);return t.addNativeError(n),t}function ze(n){return c(this,null,function*(){try{return(yield navigator.mediaDevices.getUserMedia({audio:n?n.toConstraints():!1})).getAudioTracks()[0]}catch(e){throw Y(e,$.AUDIO)}})}function Qe(n){return c(this,null,function*(){try{return(yield navigator.mediaDevices.getUserMedia({video:n?n.toConstraints():!1})).getVideoTracks()[0]}catch(e){throw Y(e,$.VIDEO)}})}function Ze(n){return"canvas"in n||n.label==="MediaStreamAudioDestinationNode"||n.label===""}var Le=class{constructor(e=1/0){this.capacity=e;this.storage=[]}size(){return this.storage.length}enqueue(e){this.size()===this.capacity&&this.dequeue(),this.storage.push(e)}dequeue(){return this.storage.shift()}aggregate(e){return e(this.storage)}};function ee(n){if(n<0)throw Error("`ms` should be a positive integer");return new Promise(e=>setTimeout(e,n))}function gr(n,e=300){let t;return function(...r){clearTimeout(t),t=void 0;let i=this;t=setTimeout(()=>{n.apply(i,r)},e)}}var Qr=35,Zr=5,Lt=class{constructor(e,t,r){this.track=e;this.audioLevelEvent=t;this.silenceEvent=r;this.TAG="[TrackAudioLevelMonitor]";this.audioLevel=0;this.isMonitored=!1;this.interval=100;this.historyInterval=700;this.history=new Le(this.historyInterval/this.interval);this.detectSilence=()=>c(this,null,function*(){let e=30,t=10,r=0;for(;this.isMonitored;){if(this.track.enabled)if(this.isSilentThisInstant()){if(r++,r>t){this.silenceEvent.publish({track:this.track});break}}else break;yield ee(e)}});try{let i=new MediaStream([this.track.nativeTrack]);this.analyserNode=this.createAnalyserNodeForStream(i)}catch(i){o.w(this.TAG,"Unable to initialize AudioContext",i)}}start(){this.stop(),this.isMonitored=!0,o.d(this.TAG,"Starting track Monitor",this.track),this.loop().then(()=>o.d(this.TAG,"Stopping track Monitor",this.track))}stop(){if(!this.analyserNode){o.d(this.TAG,"AudioContext not initialized");return}this.sendAudioLevel(0),this.isMonitored=!1}loop(){return c(this,null,function*(){for(;this.isMonitored;)this.sendAudioLevel(this.getMaxAudioLevelOverPeriod()),yield ee(this.interval)})}sendAudioLevel(e=0){if(e=e>Qr?e:0,Math.abs(this.audioLevel-e)>Zr){this.audioLevel=e;let r={track:this.track,audioLevel:this.audioLevel};this.audioLevelEvent.publish(r)}}getMaxAudioLevelOverPeriod(){if(!this.analyserNode){o.d(this.TAG,"AudioContext not initialized");return}let e=this.calculateAudioLevel();return e!==void 0&&this.history.enqueue(e),this.history.aggregate(t=>Math.max(...t))}calculateAudioLevel(){if(!this.analyserNode){o.d(this.TAG,"AudioContext not initialized");return}let e=new Uint8Array(this.analyserNode.fftSize);this.analyserNode.getByteTimeDomainData(e);let t=.009,r=t;for(let s of e)r=Math.max(r,(s-128)/128);let i=(Math.log(t)-Math.log(r))/Math.log(t);return Math.ceil(Math.min(Math.max(i*100,0),100))}isSilentThisInstant(){if(!this.analyserNode){o.d(this.TAG,"AudioContext not initialized");return}let e=new Uint8Array(this.analyserNode.fftSize);return this.analyserNode.getByteTimeDomainData(e),!e.some(t=>t!==128&&t!==0)}createAnalyserNodeForStream(e){let t=new AudioContext,r=t.createAnalyser();return t.createMediaStreamSource(e).connect(r),r}};var Dt;(function(t){t.TRANSFORM="TRANSFORM",t.ANALYZE="ANALYZE"})(Dt||(Dt={}));var he;(function(r){r.CUSTOM="CUSTOM",r.LOCAL="LOCAL",r.HMS="HMS"})(he||(he={}));function Xr(){if(Ee&&window){let n=window.location.hostname;return n==="localhost"||n==="127.0.0.1"?he.LOCAL:n.includes("app.100ms.live")?he.HMS:he.CUSTOM}return he.CUSTOM}var vr=Xr();var O=class{constructor({name:e,level:t,properties:r,includesPII:i,timestamp:a}){this.name=e,this.level=t,this.includesPII=i||!1,this.properties=r||{},this.timestamp=a||new Date().getTime()}toSignalParams(){return{name:this.name,info:x(v({},this.properties),{timestamp:this.timestamp,domain:vr}),timestamp:new Date().getTime()}}};var Xe;(function(i){i[i.VERBOSE=0]="VERBOSE",i[i.INFO=1]="INFO",i[i.ERROR=2]="ERROR",i[i.OFF=3]="OFF"})(Xe||(Xe={}));var N;(function(i){i[i.VERBOSE=0]="VERBOSE",i[i.INFO=1]="INFO",i[i.ERROR=2]="ERROR",i[i.OFF=3]="OFF"})(N||(N={}));var se=class{static failure(e,t){let r="mediaPlugin.failed",i=N.ERROR,a=v({plugin_name:e},t.toAnalyticsProperties());return new O({name:r,level:i,properties:a})}static audioPluginStats({pluginName:e,duration:t,loadTime:r}){let i="mediaPlugin.stats",a=N.INFO,s={plugin_name:e,duration:t,load_time:r};return new O({name:i,level:a,properties:s})}static stats({pluginName:e,duration:t,loadTime:r,avgPreProcessingTime:i,avgProcessingTime:a,inputFrameRate:s,pluginFrameRate:d}){let l="mediaPlugin.stats",u=N.INFO,m={plugin_name:e,duration:t,load_time:r,avg_preprocessing_time:i,avg_processing_time:a,input_frame_rate:s,plugin_frame_rate:d};return new O({name:l,level:u,properties:m})}};var _t="AnalyticsEventsService",Sr=class{constructor(){this.bufferSize=Oe;this.transports=[];this.pendingEvents=[];this.level=Xe.INFO}addTransport(e){this.transports.push(e)}removeTransport(e){this.transports.splice(this.transports.indexOf(e),1)}queue(e){if(e.level>=this.level&&(this.pendingEvents.push(e),this.pendingEvents.length>this.bufferSize)){let t=this.pendingEvents.shift();o.d(_t,"Max buffer size reached","Removed event to accommodate new events",t)}return this}flush(){if(this.transports.length===0){o.w(_t,"No valid signalling API found to flush analytics");return}try{for(;this.pendingEvents.length>0;){let e=this.pendingEvents.shift();e&&this.transports.forEach(t=>t.sendEvent(e))}}catch(e){o.w(_t,"Flush Failed",e)}}},ei=new Sr,R=ei;var Nt="AudioPluginsAnalytics",xt=class{constructor(){this.initTime={},this.addedTimestamps={},this.pluginAdded={}}added(e){this.pluginAdded[e]=!0,this.addedTimestamps[e]=Date.now(),this.initTime[e]=0}removed(e){if(this.pluginAdded[e]){let t={pluginName:e,duration:Math.floor((Date.now()-this.addedTimestamps[e])/1e3),loadTime:this.initTime[e]};R.queue(se.audioPluginStats(t)).flush(),this.clean(e)}}failure(e,t){this.pluginAdded[e]&&(R.queue(se.failure(e,t)).flush(),this.clean(e))}initWithTime(e,t){return c(this,null,function*(){if(this.initTime[e]){o.i(Nt,`Plugin Already loaded ${e}, time it took: ${this.initTime[e]}`);return}let r;try{r=yield this.timeInMs(t),o.i(Nt,`Time taken for Plugin ${e} initialization : ${r}`)}catch(i){let a=p.MediaPluginErrors.InitFailed(h.AUDIO_PLUGINS,`failed during initialization of plugin${i.message||i}`);throw o.e(Nt,a),this.failure(e,a),a}r&&(this.initTime[e]=r)})}timeInMs(e){return c(this,null,function*(){let t=Date.now();return yield e(),Math.floor(Date.now()-t)})}clean(e){delete this.addedTimestamps[e],delete this.initTime[e],delete this.pluginAdded[e]}};var te="AudioPluginsManager",et=class{constructor(e){this.pluginAddInProgress=!1;this.hmsTrack=e,this.pluginsMap=new Map,this.analytics=new xt}getPlugins(){return Array.from(this.pluginsMap.keys())}addPlugin(e){return c(this,null,function*(){var r;let t=(r=e.getName)==null?void 0:r.call(e);if(!t){o.w("no name provided by the plugin");return}if(this.pluginAddInProgress){let i=p.MediaPluginErrors.AddAlreadyInProgress(h.AUDIO_PLUGINS,"Add Plugin is already in Progress");throw this.analytics.failure(t,i),o.w("can't add another plugin when previous add is in progress"),i}this.pluginAddInProgress=!0;try{yield this.addPluginInternal(e)}finally{this.pluginAddInProgress=!1}})}addPluginInternal(e){return c(this,null,function*(){var r;let t=(r=e.getName)==null?void 0:r.call(e);if(this.pluginsMap.get(t)){o.w(te,`plugin - ${t} already added.`);return}if(!e.isSupported()){let i=p.MediaPluginErrors.PlatformNotSupported(h.AUDIO_PLUGINS,"platform not supported ");this.analytics.failure(t,i),o.i(te,`Platform is not supported for plugin - ${e.getName()}`);return}try{this.pluginsMap.size===0?yield this.initContextAndAudioNodes():this.prevAudioNode&&this.prevAudioNode.disconnect(),this.analytics.added(t),yield this.analytics.initWithTime(t,()=>c(this,null,function*(){return e.init()})),this.pluginsMap.set(t,e),yield this.processPlugin(e),yield this.connectToDestination()}catch(i){throw o.e(te,"failed to add plugin",i),i}})}removePlugin(e){return c(this,null,function*(){yield this.removePluginInternal(e),this.pluginsMap.size===0?(yield this.cleanup(),o.i(te,"No plugins left, stopping plugins loop"),yield this.hmsTrack.setProcessedTrack(void 0)):yield this.reprocessPlugins()})}cleanup(){return c(this,null,function*(){var e,t,r,i;for(let a of this.pluginsMap.values())yield this.removePluginInternal(a);yield this.hmsTrack.setProcessedTrack(void 0),(e=this.audioContext)==null||e.close(),(t=this.sourceNode)==null||t.disconnect(),(r=this.prevAudioNode)==null||r.disconnect(),(i=this.outputTrack)==null||i.stop(),this.sourceNode=void 0,this.destinationNode=void 0,this.audioContext=void 0,this.prevAudioNode=void 0,this.outputTrack=void 0})}reprocessPlugins(){return c(this,null,function*(){if(this.pluginsMap.size===0||!this.sourceNode)return;let e=Array.from(this.pluginsMap.values());yield this.cleanup(),yield this.initContextAndAudioNodes();for(let t of e)yield this.addPlugin(t)})}initContextAndAudioNodes(){return c(this,null,function*(){if(this.audioContext||(this.audioContext=new AudioContext),!this.sourceNode){let e=new MediaStream([this.hmsTrack.nativeTrack]);this.sourceNode=this.audioContext.createMediaStreamSource(e)}if(!this.destinationNode){this.destinationNode=this.audioContext.createMediaStreamDestination(),this.outputTrack=this.destinationNode.stream.getAudioTracks()[0];try{yield this.hmsTrack.setProcessedTrack(this.outputTrack)}catch(e){throw o.e(te,"error in setting processed track",e),e}}})}processPlugin(e){return c(this,null,function*(){try{let t=yield e.processAudioTrack(this.audioContext,this.prevAudioNode||this.sourceNode);this.prevAudioNode&&this.prevAudioNode.connect(t),this.prevAudioNode=t}catch(t){let r=e.getName();o.e(te,`error in processing plugin ${r}`,t),yield this.removePluginInternal(e)}})}connectToDestination(){return c(this,null,function*(){try{this.prevAudioNode&&this.destinationNode&&this.prevAudioNode.context===this.destinationNode.context&&this.prevAudioNode.connect(this.destinationNode)}catch(e){o.e(te,"error in connecting to destination node",e)}})}removePluginInternal(e){return c(this,null,function*(){var r;let t=(r=e.getName)==null?void 0:r.call(e);if(!this.pluginsMap.get(t)){o.w(te,`plugin - ${t} not found to remove.`);return}o.i(te,`removing plugin ${t}`),this.pluginsMap.delete(t),e.stop(),this.analytics.removed(t)})}};var De=class{constructor(e){this.key=e;this.storage=null}getStorage(){return Ee&&(this.storage=window.localStorage),this.storage}get(){var r;let e=(r=this.getStorage())==null?void 0:r.getItem(this.key);return e?JSON.parse(e):void 0}set(e){var r;let t=JSON.stringify(e);(r=this.getStorage())==null||r.setItem(this.key,t)}clear(){var e;(e=this.getStorage())==null||e.removeItem(this.key)}};var Tr=class{constructor(){this.storage=new De("hms-device-selection");this.remember=!1;this.TAG="HMSDeviceStorage"}setDevices(e){this.devices=e}rememberDevices(e){this.remember=e}updateSelection(e,{deviceId:t,groupId:r}){if(!this.devices||!this.remember)return;let i=this.devices[e].find(s=>this.isSame({deviceId:t,groupId:r},s));if(!i){o.w(this.TAG,`Could not find device with deviceId: ${t}, groupId: ${r}`);return}let a=this.storage.get()||{};a[e]=i,this.storage.set(a)}getSelection(){if(!!this.remember)return this.storage.get()}cleanup(){this.remember=!1,this.devices=void 0}isSame(e,t){return e.deviceId===t.deviceId&&(e.groupId===t.groupId||!e.groupId)}},J=new Tr;function fr(n,e){return function(r){return r in n&&n[r]!==e[r]}}var ti="HMSLocalAudioTrack",ne=class extends Re{constructor(e,t,r,i,a=new j().build()){super(e,t,r);this.eventBus=i;this.handleSettingsChange=e=>c(this,null,function*(){let t=this.stream,r=fr(e,this.settings);r("maxBitrate")&&e.maxBitrate&&(yield t.setMaxBitrate(e.maxBitrate,this)),r("advanced")&&(yield this.nativeTrack.applyConstraints(e.toConstraints()))});this.handleDeviceChange=(e,t=!1)=>c(this,null,function*(){fr(e,this.settings)("deviceId")&&(yield this.replaceTrackWith(e),t||J.updateSelection("audioInput",{deviceId:e.deviceId,groupId:this.nativeTrack.getSettings().groupId}))});e.tracks.push(this),this.settings=a,a.deviceId==="default"&&!Ze(t)&&(this.settings=this.buildNewSettings({deviceId:t.getSettings().deviceId})),this.pluginsManager=new et(this),this.setFirstTrackId(t.id)}replaceTrackWith(e){return c(this,null,function*(){let t=this.nativeTrack,r=this.enabled,i=Boolean(this.audioLevelMonitor);t==null||t.stop();let a=yield ze(e);a.enabled=r;let s=this.stream;yield s.replaceSenderTrack(t,this.processedTrack||a),yield s.replaceStreamTrack(t,a),this.nativeTrack=a,i&&this.initAudioLevelMonitor(),yield this.pluginsManager.reprocessPlugins()})}setEnabled(e){var t=r=>super[r];return c(this,null,function*(){e!==this.enabled&&(e&&Ze(this.nativeTrack)&&(yield this.replaceTrackWith(this.settings)),yield t("setEnabled").call(this,e),this.eventBus.localAudioEnabled.publish(e),this.stream.trackUpdate(this))})}isPublishedTrackId(e){return this.publishedTrackId===e}setSettings(e,t=!1){return c(this,null,function*(){let r=this.buildNewSettings(e);if(yield this.handleDeviceChange(r,t),Ze(this.nativeTrack)){this.settings=r;return}yield this.handleSettingsChange(r),this.settings=r})}getPlugins(){return this.pluginsManager.getPlugins()}addPlugin(e){return c(this,null,function*(){return this.pluginsManager.addPlugin(e)})}removePlugin(e){return c(this,null,function*(){return this.pluginsManager.removePlugin(e)})}setProcessedTrack(e){return c(this,null,function*(){if(!e){this.processedTrack&&(yield this.stream.replaceSenderTrack(this.processedTrack,this.nativeTrack)),this.processedTrack=void 0;return}e!==this.processedTrack&&(this.processedTrack?yield this.stream.replaceSenderTrack(this.processedTrack,e):yield this.stream.replaceSenderTrack(this.nativeTrack,e),this.processedTrack=e)})}initAudioLevelMonitor(){this.audioLevelMonitor&&this.destroyAudioLevelMonitor(),o.d(ti,"Monitor Audio Level for",this,this.getMediaTrackSettings().deviceId),this.audioLevelMonitor=new Lt(this,this.eventBus.trackAudioLevelUpdate,this.eventBus.localAudioSilence),this.audioLevelMonitor.start(),this.audioLevelMonitor.detectSilence()}destroyAudioLevelMonitor(){var e;(e=this.audioLevelMonitor)==null||e.stop(),this.audioLevelMonitor=void 0}cleanup(){var e=t=>super[t];return c(this,null,function*(){var r;e("cleanup").call(this),yield this.pluginsManager.cleanup(),(r=this.processedTrack)==null||r.stop(),this.destroyAudioLevelMonitor()})}getTrackIDBeingSent(){return this.processedTrack?this.processedTrack.id:this.nativeTrack.id}getTrackBeingSent(){return this.processedTrack||this.nativeTrack}buildNewSettings(e){let{volume:t,codec:r,maxBitrate:i,deviceId:a,advanced:s}=v(v({},this.settings),e);return new Me(t,r,i,a,s)}};var Ie;(function(t){t.TRANSFORM="TRANSFORM",t.ANALYZE="ANALYZE"})(Ie||(Ie={}));var tt=class{constructor(){this.total=0;this.count=0}add(e){this.count++,this.total+=e}getAvg(){return Math.floor(this.total/this.count)}reset(){this.total=0,this.count=0}};var rt="VideoPluginsAnalytics",Ot=class{constructor(){this.initTime={},this.preProcessingAvgs=new tt,this.addedTimestamps={},this.processingAvgs={},this.pluginAdded={},this.pluginInputFrameRate={},this.pluginFrameRate={}}added(e,t,r){this.pluginAdded[e]=!0,this.addedTimestamps[e]=Date.now(),this.initTime[e]=0,this.processingAvgs[e]=new tt,this.pluginInputFrameRate[e]=t,this.pluginFrameRate[e]=r||t}removed(e){var t;if(this.pluginAdded[e]){let r={pluginName:e,duration:Math.floor((Date.now()-this.addedTimestamps[e])/1e3),loadTime:this.initTime[e],avgPreProcessingTime:this.preProcessingAvgs.getAvg(),avgProcessingTime:(t=this.processingAvgs[e])==null?void 0:t.getAvg(),inputFrameRate:this.pluginInputFrameRate[e],pluginFrameRate:this.pluginFrameRate[e]};R.queue(se.stats(r)).flush(),this.clean(e)}}failure(e,t){this.pluginAdded[e]&&(R.queue(se.failure(e,t)).flush(),this.clean(e))}initWithTime(e,t){return c(this,null,function*(){if(this.initTime[e]){o.i(rt,`Plugin Already loaded ${e}, time it took: ${this.initTime[e]}`);return}let r;try{r=yield this.timeInMs(t),o.i(rt,`Time taken for Plugin ${e} initialization : ${r}`)}catch(i){let a=p.MediaPluginErrors.InitFailed(h.VIDEO_PLUGINS,`failed during initialization of plugin${i.message||i}`);throw o.e(rt,a),this.failure(e,a),a}r&&(this.initTime[e]=r)})}preProcessWithTime(e){return c(this,null,function*(){let t=yield this.timeInMs(e);this.preProcessingAvgs.add(t)})}processWithTime(e,t){return c(this,null,function*(){var i;let r;try{r=yield this.timeInMs(t)}catch(a){let s=p.MediaPluginErrors.ProcessingFailed(h.VIDEO_PLUGINS,`Failed during processing of plugin${a.message||a}`);throw o.e(rt,s),this.failure(e,s),s}r&&((i=this.processingAvgs[e])==null||i.add(r))})}timeInMs(e){return c(this,null,function*(){let t=Date.now();return yield e(),Math.floor(Date.now()-t)})}clean(e){delete this.addedTimestamps[e],delete this.initTime[e],delete this.processingAvgs[e],delete this.pluginAdded[e],delete this.pluginInputFrameRate[e],delete this.pluginFrameRate[e]}};var kr=24,ri=320,ii=240,K="VideoPluginsManager",it=class{constructor(e){this.pluginsLoopRunning=!1;this.pluginsLoopState="paused";this.pluginAddInProgress=!1;this.hmsTrack=e,this.plugins=[],this.pluginsMap={},this.pluginNumFramesToSkip={},this.pluginNumFramesSkipped={},this.analytics=new Ot,this.canvases=new Array}getPlugins(){return[...this.plugins]}addPlugin(e,t){return c(this,null,function*(){var r;if(this.pluginAddInProgress){let i=(r=e.getName)==null?void 0:r.call(e);if(!i||i===""){o.w("no name provided by the plugin");return}let a=p.MediaPluginErrors.AddAlreadyInProgress(h.VIDEO_PLUGINS,"Add Plugin is already in Progress");throw this.analytics.failure(i,a),o.w("can't add another plugin when previous add is in progress"),a}this.pluginAddInProgress=!0;try{yield this.addPluginInternal(e,t)}finally{this.pluginAddInProgress=!1}})}addPluginInternal(e,t){return c(this,null,function*(){var s;let r=(s=e.getName)==null?void 0:s.call(e);if(!r||r===""){o.w("no name provided by the plugin");return}if(this.pluginsMap[r]){o.w(K,`plugin - ${e.getName()} already added.`);return}let i=this.hmsTrack.getMediaTrackSettings().frameRate||kr,a=0;if(t&&t>0?(o.i(K,`adding plugin ${e.getName()} with framerate ${t}`),t<i&&(a=Math.ceil(i/t)-1),this.analytics.added(r,i,t)):(o.i(K,`adding plugin ${e.getName()}`),this.analytics.added(r,i)),o.i(K,"numFrames to skip processing",a),this.pluginNumFramesToSkip[r]=a,this.pluginNumFramesSkipped[r]=a,!e.isSupported()){let d=p.MediaPluginErrors.PlatformNotSupported(h.VIDEO_PLUGINS,"platform not supported ");this.analytics.failure(r,d),o.i(K,`Platform is not supported for plugin - ${e.getName()}`);return}try{if(yield this.analytics.initWithTime(r,()=>c(this,null,function*(){return yield e.init()})),this.plugins.push(r),this.pluginsMap[r]=e,this.plugins.length+1>this.canvases.length)for(let d=this.canvases.length;d<=this.plugins.length;d++)this.canvases[d]=document.createElement("canvas");yield this.startPluginsLoop()}catch(d){throw o.e(K,"failed to add plugin",d),yield this.removePlugin(e),d}})}removePlugin(e){return c(this,null,function*(){let t=e.getName();if(!this.pluginsMap[t]){o.w(K,`plugin - ${t} not found to remove.`);return}o.i(K,`removing plugin ${t}`),this.removePluginEntry(t),this.plugins.length===0&&(o.i(K,"No plugins left, stopping plugins loop"),yield this.stopPluginsLoop()),e.stop(),this.analytics.removed(t)})}removePluginEntry(e){let t=this.plugins.indexOf(e);t!==-1&&this.plugins.splice(t,1),this.pluginsMap[e]&&delete this.pluginsMap[e],this.pluginNumFramesToSkip[e]&&delete this.pluginNumFramesToSkip[e],this.pluginNumFramesSkipped[e]&&delete this.pluginNumFramesSkipped[e]}waitForRestart(){return c(this,null,function*(){if(!(!this.pluginsLoopRunning||this.pluginsLoopState==="running"))for(;this.pluginsLoopState==="paused";)yield ee(100)})}cleanup(){return c(this,null,function*(){var e;for(let t of this.plugins)yield this.removePlugin(this.pluginsMap[t]);(e=this.outputTrack)==null||e.stop()})}initElementsAndStream(){this.inputCanvas||(this.inputCanvas=document.createElement("canvas")),this.outputCanvas=document.createElement("canvas"),this.inputVideo||(this.inputVideo=document.createElement("video")),this.inputCanvas.getContext("2d"),this.outputCanvas.getContext("2d");let e=this.outputCanvas.captureStream();this.outputTrack=e.getVideoTracks()[0]}startPluginsLoop(){return c(this,null,function*(){if(!this.pluginsLoopRunning){this.initElementsAndStream(),this.pluginsLoopRunning=!0;try{yield this.hmsTrack.setProcessedTrack(this.outputTrack)}catch(e){throw this.pluginsLoopRunning=!1,o.e(K,"error in setting processed track",e),e}this.pluginsLoop().then(()=>{o.d(K,"processLoop stopped")})}})}stopPluginsLoop(){return c(this,null,function*(){var e;this.pluginsLoopRunning=!1,yield this.hmsTrack.setProcessedTrack(void 0),this.resetCanvases(),(e=this.outputTrack)==null||e.stop(),this.inputVideo&&(this.inputVideo.srcObject=null,this.inputVideo=void 0)})}pluginsLoop(){return c(this,null,function*(){for(;this.pluginsLoopRunning;){let e=this.hmsTrack.getMediaTrackSettings().frameRate||kr,t=Math.floor(1e3/e);if(!this.hmsTrack.enabled||this.hmsTrack.nativeTrack.readyState==="ended"){this.pluginsLoopState==="running"&&this.resetCanvases(),this.pluginsLoopState="paused",yield ee(t);continue}let r=0;try{yield this.analytics.preProcessWithTime(()=>c(this,null,function*(){return yield this.doPreProcessing()}));let i=Date.now();yield this.processFramesThroughPlugins(),r=Math.floor(Date.now()-i),r>t&&(r=t)}catch(i){o.e(K,"error in plugins loop",i)}this.pluginsLoopState="running",yield ee(t-r)}})}doPreProcessing(){return c(this,null,function*(){yield this.addTrackToVideo(),yield this.updateInputCanvas()})}processFramesThroughPlugins(){return c(this,null,function*(){this.canvases[0]=this.inputCanvas;for(let e=0;e<this.plugins.length;e++){let t=this.plugins[e],r=this.pluginsMap[t];if(!!r)try{let i=this.checkIfSkipRequired(t);if(r.getPluginType()===Ie.TRANSFORM){let a=(s,d)=>c(this,null,function*(){try{yield r.processVideoFrame(s,d,i)}catch(l){o.e(K,`error in processing plugin ${t}`,l)}});i?e==this.plugins.length-1?yield a(this.canvases[e],this.outputCanvas):yield a(this.canvases[e],this.canvases[e+1]):e==this.plugins.length-1?yield this.analytics.processWithTime(t,()=>c(this,null,function*(){return a(this.canvases[e],this.outputCanvas)})):yield this.analytics.processWithTime(t,()=>c(this,null,function*(){return a(this.canvases[e],this.canvases[e+1])}))}else r.getPluginType()===Ie.ANALYZE&&!i&&(yield this.analytics.processWithTime(t,()=>c(this,null,function*(){return yield r.processVideoFrame(this.inputCanvas)})))}catch(i){o.e(K,`error in processing plugin ${t}`,i),yield this.removePlugin(r)}}})}addTrackToVideo(){return c(this,null,function*(){var t;if(!this.inputVideo)return;let e=this.inputVideo.srcObject;e!==null&&e instanceof MediaStream&&((t=e.getVideoTracks()[0])==null?void 0:t.id)===this.hmsTrack.nativeTrack.id||(this.inputVideo.pause(),this.inputVideo.srcObject=new MediaStream([this.hmsTrack.nativeTrack]),this.inputVideo.muted=!0,this.inputVideo.playsInline=!0,this.inputVideo&&(this.inputVideo.oncanplaythrough=()=>{var r;(r=this.inputVideo)==null||r.play()}))})}updateInputCanvas(){return c(this,null,function*(){if(!this.inputCanvas||!this.inputVideo)return;let{width:e=ri,height:t=ii}=this.hmsTrack.getMediaTrackSettings();this.inputCanvas.height!==t&&(this.inputCanvas.height=t),this.inputCanvas.width!==e&&(this.inputCanvas.width=e),this.inputCanvas.getContext("2d").drawImage(this.inputVideo,0,0,e,t)})}resetCanvases(){if(!this.outputCanvas||!this.inputCanvas)return;let e=this.outputCanvas.getContext("2d");e&&(e.fillStyle="rgb(0, 0, 0)",e.fillRect(0,0,this.outputCanvas.width,this.outputCanvas.height));let t=this.inputCanvas.getContext("2d");t&&(t.fillStyle="rgb(0, 0, 0)",t.fillRect(0,0,this.outputCanvas.width,this.outputCanvas.height)),this.canvases=[]}checkIfSkipRequired(e){let t=!1;return this.pluginNumFramesSkipped[e]<this.pluginNumFramesToSkip[e]?(this.pluginNumFramesSkipped[e]++,t=!0):(t=!1,this.pluginNumFramesSkipped[e]=0),t}};var at="HMSLocalStream",pe=class extends fe{constructor(){super(...arguments);this.connection=null}setConnection(e){this.connection=e}addTransceiver(e,t){let r=[];if(e instanceof z)if(t.length>0)o.v(at,"Simulcast enabled with layers",t),r.push(...t);else{let a={active:this.nativeStream.active};e.settings.maxBitrate&&!ke&&(a.maxBitrate=e.settings.maxBitrate),r.push(a)}let i=this.connection.addTransceiver(e.nativeTrack,{streams:[this.nativeStream],direction:"sendonly",sendEncodings:r});return this.setPreferredCodec(i,e.nativeTrack.kind),i}setMaxBitrate(e,t){return c(this,null,function*(){var r;yield(r=this.connection)==null?void 0:r.setMaxBitrate(e,t)})}setPreferredCodec(e,t){}replaceTrack(e,t){return c(this,null,function*(){yield this.replaceSenderTrack(e,t),e.stop(),this.replaceStreamTrack(e,t)})}replaceStreamTrack(e,t){this.nativeStream.addTrack(t),this.nativeStream.removeTrack(e)}replaceSenderTrack(e,t){return c(this,null,function*(){var i;let r=(i=this.connection)==null?void 0:i.getSenders().find(a=>a.track&&a.track.id===e.id);if(r===void 0){o.w(at,`No sender found for trackId=${e.id}`);return}yield r.replaceTrack(t)})}removeSender(e){let t=0;this.connection.getSenders().forEach(r=>{var i,a;if(((i=r.track)==null?void 0:i.id)===e.trackId||((a=r.track)==null?void 0:a.id)===e.getTrackIDBeingSent()){this.connection.removeTrack(r),t+=1;let s=this.tracks.indexOf(e);s!==-1?this.tracks.splice(s,1):o.e(at,`Cannot find ${e.trackId} in locally stored tracks`)}}),t!==1&&o.e(at,`Removed ${t} sender's, expected to remove 1`)}trackUpdate(e){var t;(t=this.connection)==null||t.trackUpdate(e)}};var D=class{static connect(e,t=new Date,r=new Date,i){let a=this.eventNameFor("connect",e===void 0),s=e?N.ERROR:N.INFO,d=this.getPropertiesWithError({[this.KEY_REQUESTED_AT]:t==null?void 0:t.getTime(),[this.KEY_RESPONDED_AT]:r==null?void 0:r.getTime(),endpoint:i},e);return new O({name:a,level:s,properties:d})}static disconnect(e){let t="disconnected",r=e?N.ERROR:N.INFO,i=this.getPropertiesWithError({},e);return new O({name:t,level:r,properties:i})}static join(e,t,r){let i=this.eventNameFor("join",r===void 0),a=r?N.ERROR:N.INFO,s=this.getPropertiesWithError({[this.KEY_REQUESTED_AT]:e.getTime(),[this.KEY_RESPONDED_AT]:t.getTime()},r);return new O({name:i,level:a,properties:s})}static publish({devices:e,settings:t,error:r}){let i=this.eventNameFor("publish",r===void 0),a=r?N.ERROR:N.INFO,s=this.getPropertiesWithError({devices:e,audio:t==null?void 0:t.audio,video:t==null?void 0:t.video},r);return new O({name:i,level:a,properties:s})}static subscribeFail(e){let t=this.eventNameFor("subscribe",!1),r=N.ERROR,i=e.toAnalyticsProperties();return new O({name:t,level:r,properties:i})}static leave(){return new O({name:"leave",level:N.INFO})}static autoplayError(){return new O({name:"autoplayError",level:N.ERROR})}static deviceChange({selection:e,type:t,devices:r,error:i}){let a=this.eventNameFor(i?"publish":`device.${t}`,i===void 0),s=i?N.ERROR:N.INFO,d=this.getPropertiesWithError({selection:e,devices:r},i);return new O({name:a,level:s,properties:d})}static performance(e){let t="perf.stats",r=N.INFO,i=e.toAnalyticsProperties();return new O({name:t,level:r,properties:i})}static rtcStats(e){let t="rtc.stats",r=N.INFO,i=e.toAnalyticsProperties();return new O({name:t,level:r,properties:i})}static degradationStats(e,t){let r="video.degradation.stats",i=N.INFO,a={degradedAt:e.degradedAt,trackId:e.trackId};if(!t&&e.degradedAt instanceof Date){let s=new Date,d=s.valueOf()-e.degradedAt.valueOf();a=x(v({},a),{duration:d,restoredAt:s})}return new O({name:r,level:i,properties:a})}static audioDetectionFail(e,t){let r=this.getPropertiesWithError({device:t},e),i=N.ERROR,a="audiopresence.failed";return new O({name:a,level:i,properties:r})}static eventNameFor(e,t){return`${e}.${t?"success":"failed"}`}static getPropertiesWithError(e,t){return t&&(e=v(v({},t.toAnalyticsProperties()),e)),e}};D.KEY_REQUESTED_AT="requested_at",D.KEY_RESPONDED_AT="responded_at";var Er={isAudioMuted:!1,isVideoMuted:!1,audioInputDeviceId:"default",audioOutputDeviceId:"default",videoDeviceId:"default"},_e,oe=class{constructor(e,t,r,i){this.store=e;this.observer=t;this.deviceManager=r;this.eventBus=i;this.TAG="[LocalTrackManager]"}getTracksToPublish(e){return c(this,null,function*(){let t=this.store.getPublishParams();if(!t)return[];let{allowed:r}=t,i=Boolean(r&&r.includes("audio")),a=Boolean(r&&r.includes("video"));if(!i&&!a)return[];let s=[],d=this.getTrackSettings(e,t);if(!d)return[];let l=this.store.getLocalPeerTracks(),u=l.find(b=>b.type===H.VIDEO&&b.source==="regular"),m=l.find(b=>b.type===H.AUDIO&&b.source==="regular"),T=l.find(b=>b.type===H.VIDEO&&b.source==="screen"),S=Boolean(u&&this.store.getTrackById(u.trackId)),G=Boolean(m&&this.store.getTrackById(m.trackId));if(u&&d.video&&(yield u.setSettings(d.video)),m&&d.audio&&(yield m.setSettings(d.audio)),T&&d.screen&&T.setSettings(d.screen),S&&G)return[];let A={audio:i&&!m&&(e.isAudioMuted?"empty":!0),video:a&&!u&&(e.isVideoMuted?"empty":!0)};try{o.d(this.TAG,"Init Local Tracks",{fetchTrackOptions:A}),s=yield this.getLocalTracks(A,d)}catch(b){s=yield this.retryGetLocalTracks(b,d,A)}return u&&a&&!S&&s.push(u),m&&i&&!G&&s.push(m),s})}getLocalTracks(){return c(this,arguments,function*(e={audio:!0,video:!0},t){try{let r=yield this.getNativeLocalTracks(e,t),i=r.find(l=>l.kind==="video"),a=r.find(l=>l.kind==="audio"),s=new pe(new MediaStream(r)),d=[];if(a&&(t==null?void 0:t.audio)){let l=new ne(s,a,"regular",this.eventBus,t.audio);d.push(l)}if(i&&(t==null?void 0:t.video)){let l=new z(s,i,"regular",this.eventBus,t.video);d.push(l)}return d}catch(r){throw r instanceof g&&R.queue(D.publish({devices:this.deviceManager.getDevices(),error:r,settings:t})).flush(),r}})}getNativeLocalTracks(){return c(this,arguments,function*(e={audio:!1,video:!1},t){let r=new ye(e.video===!0?t.video:null,e.audio===!0?t.audio:null,t.simulcast),i=[];return(r.audio||r.video)&&i.push(...yield this.getAVTracks(r)),e.audio==="empty"&&i.push(oe.getEmptyAudioTrack()),e.video==="empty"&&i.push(oe.getEmptyVideoTrack()),i})}getLocalScreen(e,t){return c(this,null,function*(){let r=t.toConstraints();delete r.advanced;let i={video:e.toConstraints(),audio:x(v({},r),{autoGainControl:!1,noiseSuppression:!1,googAutoGainControl:!1,echoCancellation:!1})},a;try{a=yield navigator.mediaDevices.getDisplayMedia(i)}catch(T){throw Y(T,$.SCREEN)}let s=[],d=new pe(a),l=a.getVideoTracks()[0],u=new z(d,l,"screen",this.eventBus,e);s.push(u);let m=a.getAudioTracks()[0];if(m){let T=new ne(d,m,"screen",this.eventBus,t);s.push(T)}return o.v(this.TAG,"getLocalScreen",s),s})}requestPermissions(){return c(this,null,function*(){try{(yield navigator.mediaDevices.getUserMedia({audio:!0,video:!0})).getTracks().forEach(t=>t.stop())}catch(e){o.e(this.TAG,e)}})}static getEmptyVideoTrack(e){var l,u,m;let t=((l=e==null?void 0:e.getSettings())==null?void 0:l.width)||320,r=((u=e==null?void 0:e.getSettings())==null?void 0:u.height)||240,i=10;_e||(_e=Object.assign(document.createElement("canvas"),{width:t,height:r}),(m=_e.getContext("2d"))==null||m.fillRect(0,0,t,r));let s=_e.captureStream(i).getVideoTracks()[0],d=setInterval(()=>{if(s.readyState==="ended"){clearInterval(d);return}let T=_e.getContext("2d");if(T){let G=T.getImageData(0,0,1,1).data[0]===0?1:0;T.fillStyle=`rgb(${G}, 0, 0)`,T.fillRect(0,0,1,1)}},1e3/i);return s.onended=()=>{clearInterval(d)},s.enabled=!1,s}static getEmptyAudioTrack(){let e=new AudioContext,t=e.createOscillator(),r=t.connect(e.createMediaStreamDestination());t.start();let i=r.stream.getAudioTracks()[0];return i.enabled=!1,i}getAVTracks(e){return c(this,null,function*(){try{let t=yield navigator.mediaDevices.getUserMedia({audio:e.audio?e.audio.toConstraints():!1,video:e.video?e.video.toConstraints():!1});return t.getVideoTracks().concat(t.getAudioTracks())}catch(t){let r=!1,i=!1;throw yield this.deviceManager.init(),!this.deviceManager.hasWebcamPermission&&e.video&&(r=!0),!this.deviceManager.hasMicrophonePermission&&e.audio&&(i=!0),r&&i?Y(t,$.AV):r?Y(t,$.VIDEO):Y(t,$.AUDIO)}})}getTrackSettings(e,t){let{audio:r,video:i,screen:a,allowed:s}=t,d=Boolean(s&&s.includes("audio")),l=Boolean(s&&s.includes("video")),u=Boolean(s&&s.includes("screen"));if(!d&&!l)return null;let m=this.store.getLocalPeer(),T=m==null?void 0:m.videoTrack,S=m==null?void 0:m.audioTrack,G=(S==null?void 0:S.settings.deviceId)||e.audioInputDeviceId,A=(T==null?void 0:T.settings.deviceId)||e.videoDeviceId,b=null,E=null,de=null;if(d&&(b=new j().codec(r.codec).maxBitrate(r.bitRate).deviceId(G||Er.audioInputDeviceId).build()),l){let B=this.store.getSimulcastDimensions("regular");E=new U().codec(i.codec).maxBitrate(i.bitRate).maxFramerate(i.frameRate).setWidth((B==null?void 0:B.width)||i.width).setHeight((B==null?void 0:B.height)||i.height).deviceId(A||Er.videoDeviceId).build()}if(u){let B=this.store.getSimulcastDimensions("screen");de=new U().maxBitrate(a.bitRate,!1).codec(a.codec).maxFramerate(a.frameRate).setWidth((B==null?void 0:B.width)||a.width).setHeight((B==null?void 0:B.height)||a.height).build()}return new je().video(E).audio(b).screen(de).build()}retryGetLocalTracks(e,t,r){return c(this,null,function*(){if(e instanceof g&&e.action===h.TRACK){this.observer.onFailure(e);let i=e.code===k.TracksErrors.OVER_CONSTRAINED,a=e.message.includes("audio"),s=e.message.includes("video");if(i){let d=new je().video(new Ae).audio(new Me).build();o.w(this.TAG,"Fetch AV Tracks failed with overconstrained error",{fetchTrackOptions:r},{error:e});try{return yield this.getLocalTracks(r,d)}catch(l){let u=l instanceof g?l.nativeError:l,m=l;if((u==null?void 0:u.name)==="OverconstrainedError"){let T=p.TracksErrors.GenericTrack(h.TRACK,"Overconstrained error after dropping all constraints");T.addNativeError(u),m=T}return yield this.retryGetLocalTracks(m,t,r)}}r.audio=a?"empty":r.audio,r.video=s?"empty":r.video,o.w(this.TAG,"Fetch AV Tracks failed",{fetchTrackOptions:r},e);try{return yield this.getLocalTracks(r,t)}catch(d){return o.w(this.TAG,"Fetch empty tacks failed",d),r.audio=r.audio&&"empty",r.video=r.video&&"empty",this.observer.onFailure(p.TracksErrors.GenericTrack(h.TRACK,d.message)),yield this.getLocalTracks(r,t)}}else return o.w(this.TAG,"Fetch AV Tracks failed - unknown exception",e),this.observer.onFailure(p.TracksErrors.GenericTrack(h.TRACK,e.message)),[]})}};function Mr(n,e){return function(r){return r in n&&n[r]!==e[r]}}var z=class extends be{constructor(e,t,r,i,a=new U().build()){super(e,t,r);this.eventBus=i;this.buildNewSettings=e=>{let{width:t,height:r,codec:i,maxFramerate:a,maxBitrate:s,deviceId:d,advanced:l}=v(v({},this.settings),e);return new Ae(t,r,i,a,d,l,s)};this.handleSettingsChange=e=>c(this,null,function*(){let t=this.stream,r=Mr(e,this.settings);r("maxBitrate")&&e.maxBitrate&&(yield t.setMaxBitrate(e.maxBitrate,this)),(r("width")||r("height")||r("advanced"))&&(yield this.nativeTrack.applyConstraints(e.toConstraints()))});this.handleDeviceChange=(e,t=!1)=>c(this,null,function*(){if(Mr(e,this.settings)("deviceId")&&this.source==="regular"){if(this.enabled){let i=yield this.replaceTrackWith(e);yield this.replaceSender(i,this.enabled),this.nativeTrack=i}t||J.updateSelection("videoInput",{deviceId:e.deviceId,groupId:this.nativeTrack.getSettings().groupId})}});e.tracks.push(this),this.settings=a,a.deviceId==="default"&&t.enabled&&(this.settings=this.buildNewSettings({deviceId:t.getSettings().deviceId})),this.pluginsManager=new it(this),this.setFirstTrackId(this.trackId)}setEnabled(e){var t=r=>super[r];return c(this,null,function*(){if(e!==this.enabled){if(this.source==="regular"){let i;e?i=yield this.replaceTrackWith(this.settings):i=yield this.replaceTrackWithBlank(),yield this.replaceSender(i,e),this.nativeTrack=i,e&&(yield this.pluginsManager.waitForRestart())}yield t("setEnabled").call(this,e),this.eventBus.localVideoEnabled.publish(e),this.stream.trackUpdate(this)}})}isPublishedTrackId(e){return this.publishedTrackId===e}addSink(e){this.addSinkInternal(e,this.processedTrack||this.nativeTrack)}setSettings(e,t=!1){return c(this,null,function*(){let r=this.buildNewSettings(e);if(yield this.handleDeviceChange(r,t),!this.enabled){this.settings=r;return}yield this.handleSettingsChange(r),this.settings=r})}getPlugins(){return this.pluginsManager.getPlugins()}addPlugin(e,t){return c(this,null,function*(){return this.pluginsManager.addPlugin(e,t)})}removePlugin(e){return c(this,null,function*(){return this.pluginsManager.removePlugin(e)})}cleanup(){var e=t=>super[t];return c(this,null,function*(){var r;e("cleanup").call(this),yield this.pluginsManager.cleanup(),(r=this.processedTrack)==null||r.stop()})}setProcessedTrack(e){return c(this,null,function*(){if(!this.nativeTrack.enabled){this.processedTrack=e;return}if(!e){this.processedTrack&&(yield this.stream.replaceSenderTrack(this.processedTrack,this.nativeTrack)),this.processedTrack=void 0;return}e!==this.processedTrack&&(this.processedTrack?yield this.stream.replaceSenderTrack(this.processedTrack,e):yield this.stream.replaceSenderTrack(this.nativeTrack,e),this.processedTrack=e)})}getTrackIDBeingSent(){return this.processedTrack?this.processedTrack.id:this.nativeTrack.id}getTrackBeingSent(){return this.processedTrack||this.nativeTrack}replaceTrackWith(e){return c(this,null,function*(){let t=this.nativeTrack;t==null||t.stop();let r=yield Qe(e);return this.settings.deviceId==="default"&&(this.settings=this.buildNewSettings({deviceId:this.nativeTrack.getSettings().deviceId})),r})}replaceTrackWithBlank(){return c(this,null,function*(){let e=this.nativeTrack;return e==null||e.stop(),oe.getEmptyVideoTrack(e)})}replaceSender(e,t){return c(this,null,function*(){let r=this.stream;t?yield r.replaceSenderTrack(this.nativeTrack,this.processedTrack||e):yield r.replaceSenderTrack(this.processedTrack||this.nativeTrack,e),yield r.replaceStreamTrack(this.nativeTrack,e)})}};var Vt=class{constructor(e,t,r){this.store=e;this.eventEmitter=t;this.listener=r;this.tracksToProcess=new Map;this.handleTrackAdd=e=>{o.d(this.TAG,"ONTRACKADD",e,e.nativeTrack),this.store.addTrack(e),this.tracksToProcess.set(e.trackId,e),this.processPendingTracks()};this.handleTrackRemove=e=>{var a;o.d(this.TAG,"ONTRACKREMOVE",e,e.nativeTrack);let t=this.store.getTrackState(e.trackId);if(!t)return;e.type===H.AUDIO&&this.eventEmitter.emit("track-removed",{detail:e});let r=this.store.getPeerById(t.peerId);if(!r)return;let i=()=>{let s=r.auxiliaryTracks.indexOf(e);s>-1&&r.auxiliaryTracks.splice(s,1)};switch(e.type){case H.AUDIO:e.source!=="regular"?i():r.audioTrack=void 0;break;case H.VIDEO:e.source!=="regular"?i():r.videoTrack=void 0}this.store.removeTrack(e.trackId),(a=this.listener)==null||a.onTrackUpdate(L.TRACK_REMOVED,e,r)};this.handleTrackLayerUpdate=e=>{var t,r;for(let i in e.tracks){let a=e.tracks[i],s=this.store.getTrackById(i);if(!s)continue;let d=this.store.getPeerByTrackId(i);if(!!d&&s instanceof ue){let l=this.isTrackDegraded(a.expected_layer,a.current_layer);s.setDegraded(l),l?(t=this.listener)==null||t.onTrackUpdate(L.TRACK_DEGRADED,s,d):(r=this.listener)==null||r.onTrackUpdate(L.TRACK_RESTORED,s,d)}}};this.handleTrackUpdate=e=>{var r,i,a,s;o.d(this.TAG,"TRACK_UPDATE",e);let t=this.store.getPeerById(e.peer.peer_id);if(!!t)for(let d in e.tracks){let l=Object.assign({},(r=this.store.getTrackState(d))==null?void 0:r.trackInfo),u=e.tracks[d],m=this.store.getTrackById(d);this.store.setTrackState({peerId:e.peer.peer_id,trackInfo:v(v({},l),u)}),!m||this.tracksToProcess.has(d)?this.processPendingTracks():(m.setEnabled(!u.mute),l.mute!==u.mute?(u.mute?(i=this.listener)==null||i.onTrackUpdate(L.TRACK_MUTED,m,t):(a=this.listener)==null||a.onTrackUpdate(L.TRACK_UNMUTED,m,t),m.type===H.AUDIO&&this.eventEmitter.emit("track-updated",{detail:{track:m,enabled:!u.mute}})):l.description!==u.description&&((s=this.listener)==null||s.onTrackUpdate(L.TRACK_DESCRIPTION_CHANGED,m,t)))}}}get TAG(){return`[${this.constructor.name}]`}isTrackDegraded(e,t){let r=i=>{switch(i){case F.HIGH:return 3;case F.MEDIUM:return 2;case F.LOW:return 1;case F.NONE:return 0}};return r(t)<r(e)}handleTrackMetadataAdd(e){o.d(this.TAG,"TRACK_METADATA_ADD",e);for(let t in e.tracks)this.store.setTrackState({peerId:e.peer.peer_id,trackInfo:e.tracks[t]});this.processPendingTracks()}processPendingTracks(){new Map(this.tracksToProcess).forEach(t=>{var a;let r=this.store.getTrackState(t.trackId);if(!r)return;let i=this.store.getPeerById(r.peerId);if(!!i){switch(t.source=r.trackInfo.source,t.peerId=i.peerId,t.setEnabled(!r.trackInfo.mute),t.type){case H.AUDIO:!i.audioTrack&&t.source==="regular"?i.audioTrack=t:i.auxiliaryTracks.push(t);break;case H.VIDEO:{let s=t,d=this.store.getSimulcastDefinitionsForPeer(i,s.source);s.setSimulcastDefinitons(d),!i.videoTrack&&t.source==="regular"?i.videoTrack=s:i.auxiliaryTracks.push(s)}}t.type===H.AUDIO?this.eventEmitter.emit("track-added",{detail:{track:t,peer:i}}):(a=this.listener)==null||a.onTrackUpdate(L.TRACK_ADDED,t,i),this.tracksToProcess.delete(t.trackId)}})}};var st=class{constructor(e,t,r){this.store=e;this.listener=t;this.audioListener=r;this.TAG="[HMSNotificationManager]";this.eventEmitter=new ai;this.hasConsistentRoomStateArrived=!1;this.ignoreNotification=e=>{if(e===y.PEER_LIST)this.hasConsistentRoomStateArrived=!0;else if(e===y.ROOM_STATE)return this.hasConsistentRoomStateArrived;return!1};this.handleTrackAdd=e=>{this.trackManager.handleTrackAdd(e)};this.handleTrackRemove=e=>{this.trackManager.handleTrackRemove(e)};this.updateLocalPeer=({name:e,metadata:t})=>{let r=this.store.getLocalPeer();this.peerManager.handlePeerInfoUpdate({peer:r,name:e,data:t})};this.trackManager=new Vt(this.store,this.eventEmitter,this.listener),this.peerManager=new Rt(this.store,this.trackManager,this.listener),this.peerListManager=new Ct(this.store,this.peerManager,this.trackManager,this.listener),this.broadcastManager=new It(this.store,this.listener),this.policyChangeManager=new bt(this.store,this.eventEmitter),this.requestManager=new Ht(this.store,this.listener),this.activeSpeakerManager=new Pt(this.store,this.listener,this.audioListener),this.roomUpdateManager=new wt(this.store,this.listener)}setListener(e){this.listener=e,this.trackManager.listener=e,this.peerManager.listener=e,this.peerListManager.listener=e,this.broadcastManager.listener=e,this.requestManager.listener=e,this.activeSpeakerManager.listener=e,this.roomUpdateManager.listener=e}setAudioListener(e){this.audioListener=e,this.activeSpeakerManager.audioListener=e}addEventListener(e,t){this.eventEmitter.addListener(e,t)}removeEventListener(e,t){this.eventEmitter.removeListener(e,t)}once(e,t){this.eventEmitter.once(e,t)}handleNotification(e,t=!1){var a,s;let r=e.method,i=e.params;if([y.ACTIVE_SPEAKERS,y.SFU_STATS].includes(r)||o.d(this.TAG,"Received notification",{method:r,notification:i}),r===y.SFU_STATS&&((a=window.HMS)==null?void 0:a.ON_SFU_STATS)&&typeof((s=window.HMS)==null?void 0:s.ON_SFU_STATS)=="function"&&window.HMS.ON_SFU_STATS(e.params),!this.ignoreNotification(r))switch(this.roomUpdateManager.handleNotification(r,i),this.peerManager.handleNotification(r,i),this.requestManager.handleNotification(r,i),this.peerListManager.handleNotification(r,i,t),this.broadcastManager.handleNotification(r,i),r){case y.TRACK_METADATA_ADD:{this.trackManager.handleTrackMetadataAdd(i);break}case y.TRACK_UPDATE:{this.trackManager.handleTrackUpdate(i);break}case y.ON_SFU_TRACK_LAYER_UPDATE:{this.trackManager.handleTrackLayerUpdate(i);break}case y.ACTIVE_SPEAKERS:this.activeSpeakerManager.handleActiveSpeakers(i);break;case y.POLICY_CHANGE:this.policyChangeManager.handlePolicyChange(i);break;default:break}}};var nt=class{constructor(e){this.type=e.type,this.source=e.source||"regular",this.description="",e instanceof le?(this.mute=!e.enabled,this.track_id=e.publishedTrackId,this.stream_id=e.stream.id):(this.mute=e.mute,this.track_id=e.track_id,this.stream_id=e.stream_id)}};var w;(function(s){s[s.Disconnected=0]="Disconnected",s[s.Connecting=1]="Connecting",s[s.Joined=2]="Joined",s[s.Failed=3]="Failed",s[s.Reconnecting=4]="Reconnecting",s[s.Leaving=5]="Leaving"})(w||(w={}));var Ft=class{constructor(e,t,r,i,a,s,d){this.authToken=e;this.peerId=t;this.peerName=r;this.data=i;this.endpoint=a;this.autoSubscribeVideo=s;this.serverSubDegrade=d}};var I;(function(i){i[i.ConnectFailed=0]="ConnectFailed",i[i.SignalDisconnect=1]="SignalDisconnect",i[i.PublishIceConnectionFailed=2]="PublishIceConnectionFailed",i[i.SubscribeIceConnectionFailed=3]="SubscribeIceConnectionFailed"})(I||(I={}));var Ar={[0]:[],[1]:[],[2]:[1],[3]:[1]};var Gt=class{constructor(e){this.promise=new Promise((t,r)=>{this.resolve=t,this.reject=r,e(t,r)})}};var ce="[RetryScheduler]",Ut=class{constructor(e,t){this.inProgress=new Map;this.retryTaskIds=[];this.analyticsEventsService=e,this.onStateChange=t}schedule(s,d,l){return c(this,arguments,function*(e,t,r,i=Ce,a=!0){yield this.scheduleTask(e,t,a,r,i)})}reset(){this.retryTaskIds.forEach(e=>clearTimeout(e)),this.retryTaskIds=[],this.inProgress.clear()}scheduleTask(d,l,u,m){return c(this,arguments,function*(e,t,r,i,a=Ce,s=0){if(o.d(ce,"schedule: ",{category:I[e],error:t}),s===0){let b=this.inProgress.get(e);if(b){o.d(ce,`schedule: Already a task for ${I[e]} scheduled, waiting for its completion`),yield b.promise;return}let E=new Gt((de,B)=>{});this.inProgress.set(e,E),this.sendEvent(t,e)}let T=!1,S=Ar[e];for(let b in S){let E=S[parseInt(b)];try{let de=this.inProgress.get(E);de&&(o.d(ce,`schedule: Suspending retry task of ${I[e]}, waiting for ${I[E]} to recover`),yield de.promise,o.d(ce,`schedule: Resuming retry task ${I[e]} as it's dependency ${I[E]} is recovered`))}catch(de){o.d(ce,`schedule: Stopping retry task of ${I[e]} as it's dependency ${I[E]} failed to recover`),T=!0;break}}if(s>=a||T){if(t.description+=`. [${I[e]}] Could not recover after ${s} tries`,T&&(t.description+=` Could not recover all of it's required dependencies - [${S.map(b=>I[b]).toString()}]`),t.isTerminal=!0,this.inProgress.delete(e),this.sendEvent(t,e),this.reset(),r)this.onStateChange(w.Failed,t);else throw t;return}r&&this.onStateChange(w.Reconnecting,t);let G=this.getDelayForRetryCount(s);o.i(ce,`schedule: [${I[e]}] [failedRetryCount=${s}] Scheduling retry task in ${G}ms`);let A;try{A=yield this.setTimeoutPromise(i,G)}catch(b){A=!1,o.w(ce,`[${I[e]}] Un-caught exception ${b.name} in retry-task, initiating retry`,b)}if(A){let b=this.inProgress.get(e);this.inProgress.delete(e),b==null||b.resolve(s),r&&this.inProgress.size===0&&this.onStateChange(w.Joined),o.i(ce,`schedule: [${I[e]}] [failedRetryCount=${s}] Recovered \u267B\uFE0F`)}else yield this.scheduleTask(e,t,r,i,a,s+1)})}sendEvent(e,t){let r;switch(t){case I.ConnectFailed:r=D.connect(e);break;case I.SignalDisconnect:r=D.disconnect(e);break;case I.PublishIceConnectionFailed:r=D.publish({error:e});break;case I.SubscribeIceConnectionFailed:r=D.subscribeFail(e);break}this.analyticsEventsService.queue(r).flush()}getDelayForRetryCount(e){let t=Math.pow(2,e),r=Math.random();return Math.round(Math.min(t+r,sr)*1e3)}setTimeoutPromise(e,t){return c(this,null,function*(){return new Promise((r,i)=>{let a=window.setTimeout(()=>c(this,null,function*(){try{let s=yield e();s&&this.retryTaskIds.splice(this.retryTaskIds.indexOf(a),1),r(s)}catch(s){i(s)}}),t);this.retryTaskIds.push(a)})})}};var Bt=class{constructor(){this.TAG="AnalyticsTransport"}sendEvent(e){try{this.sendSingleEvent(e),this.flushFailedEvents()}catch(t){o.w(this.TAG,"sendEvent failed",t)}}flushFailedEvents(){try{for(o.d(this.TAG,"Flushing failed events",this.failedEvents);this.failedEvents.size()>0;){let e=this.failedEvents.dequeue();e&&this.sendSingleEvent(e)}}catch(e){o.w(this.TAG,"flushFailedEvents failed",e)}}sendSingleEvent(e){try{o.d(this.TAG,"Sending event",{event:e}),this.transportProvider.sendEvent(e)}catch(t){throw o.w(this.TAG,`${this.transportProvider.constructor.name}.sendEvent failed, adding to local storage events`,{event:e,error:t}),this.failedEvents.enqueue(e),t}}};var qt=class extends Le{constructor(){super(Oe);this.localStorage=new De("hms-analytics");this.localStorage.clear(),this.initLocalStorageQueue()}enqueue(e){super.enqueue(e),this.localStorage.set(this.storage)}dequeue(){let e=super.dequeue();return this.localStorage.set(this.storage),e}initLocalStorageQueue(){var e;(e=this.localStorage.get())==null||e.forEach(t=>{let r=new O(t);super.enqueue(r)})}};var $t=class extends Bt{constructor(e){super();this.transportProvider=e;this.failedEvents=new qt}};var ot=class{constructor(e,t){this.store=e;this.eventBus=t;this.TAG="[TrackDegradationController]";this.MAX_RECOVER_GRACE_PERIOD=120;this.recoverAttemptCount=0;this.packetsLost=0;let r=this.store.getSubscribeDegradationParams();this.PACKETS_LOST_THRESHOLD=r.packetLossThreshold,this.MIN_DEGRADE_GRACE_PERIOD=r.degradeGracePeriodSeconds,this.MIN_RECOVER_GRACE_PERIOD=r.recoverGracePeriodSeconds,this.degradeGracePeriod=this.MIN_DEGRADE_GRACE_PERIOD,this.recoverGracePeriod=this.MIN_RECOVER_GRACE_PERIOD}get isAttemptingRecover(){return Boolean(this.recoveringTrack)}handleRtcStatsChange(e){let t=e>this.packetsLost+this.PACKETS_LOST_THRESHOLD;this.packetsLost=e,t?this.degrade():this.recover()}degrade(){if(this.degradeGracePeriod>0){this.degradeGracePeriod--;return}if(this.isAttemptingRecover)return this.cancelRecovery();o.d(this.TAG,"Packet loss increased, Degrading",{packetsLost:this.packetsLost}),this.degradeActiveTracksByHalf(),this.degradeGracePeriod=this.MIN_DEGRADE_GRACE_PERIOD,this.recoverGracePeriod=this.MIN_RECOVER_GRACE_PERIOD}recover(){if(this.degradeGracePeriod=this.MIN_DEGRADE_GRACE_PERIOD,this.recoverGracePeriod>0){this.recoverGracePeriod--;return}this.recoveringTrack=this.getActiveTracks(!0).find(e=>e.degraded),!!this.recoveringTrack&&(o.d(this.TAG,"Packet lost stable, recovering track",this.recoveringTrack),this.recoveringTrack.setDegraded(!1),this.eventBus.trackRestored.publish(this.recoveringTrack),this.recoverGracePeriod=this.MIN_RECOVER_GRACE_PERIOD)}cleanUp(){this.eventBus.trackDegraded.removeAllListeners(),this.eventBus.trackRestored.removeAllListeners()}degradeActiveTracksByHalf(){let e=this.getActiveTracks(!1);if(!e.length)return;o.d(this.TAG,{activeTracks:[...e]});let t=Math.ceil(e.length/2);for(;t--;){let r=e.pop();r.setDegraded(!0),this.eventBus.trackDegraded.publish(r)}}getActiveTracks(e){return this.store.getRemoteVideoTracks().filter(t=>t.hasSinks()&&(!t.degraded||e)).sort((t,r)=>{let i=this.store.getComparator().getTrackComparators();return-1*(i.screenShare(t,r)||i.rolePriority(t,r)||i.peerAudioLevel(t,r)||this.store.getComparator().stringComparator(t.trackId,r.trackId))}).slice(0)}cancelRecovery(){this.recoveringTrack&&(this.recoveringTrack.setDegraded(!0),this.eventBus.trackDegraded.publish(this.recoveringTrack)),this.recoveringTrack=void 0,this.recoverAttemptCount++,this.recoverGracePeriod=this.getDelayForRecoverCount(this.recoverAttemptCount),this.degradeGracePeriod=this.MIN_DEGRADE_GRACE_PERIOD,o.d(this.TAG,"Recover Attempt Failed",{count:this.recoverAttemptCount,delay:this.recoverGracePeriod})}getDelayForRecoverCount(e){let t=this.MIN_RECOVER_GRACE_PERIOD+this.MIN_RECOVER_GRACE_PERIOD*e;return Math.min(t,this.MAX_RECOVER_GRACE_PERIOD)}};var yr=(n,e,t,r)=>c(void 0,null,function*(){var T;let i=e instanceof ne||e instanceof z,a=i?"publish":"subscribe",s=i?e.getTrackBeingSent():e.nativeTrack,d;try{d=yield(T=n[a])==null?void 0:T.call(n,s)}catch(S){o.e("[HMSWebrtcStats]","Error in getting track stats",e,s,S)}let l=si(d),u=Cr(a==="publish"?"bytesSent":"bytesReceived",l,r),m=Wt("packetsLost",l,r);return(l==null?void 0:l.remote)&&Object.assign(l.remote,{packetsLostRate:Wt("packetsLost",l.remote,r==null?void 0:r.remote)}),l&&Object.assign(l,{bitrate:u,packetsLostRate:m,peerId:e.peerId,peerName:t})}),si=n=>{let e,t;return n==null||n.forEach(r=>{switch(r.type){case"inbound-rtp":e=r;break;case"outbound-rtp":e=r;break;case"remote-inbound-rtp":t=r;break;default:break}}),e&&Object.assign(e,{remote:t})},Kt=(n,e,t)=>{let r=ni(e),i=Cr(n==="publish"?"bytesSent":"bytesReceived",r,t&&t[n]);return r&&Object.assign(r,{bitrate:i})},ni=n=>{let e;return n.forEach(t=>{t.type==="transport"&&(e=n.get(t.selectedCandidatePairId))}),e||n.forEach(t=>{t.type==="candidate-pair"&&t.selected&&(e=t)}),e},Pr=n=>{let e={packetsLost:0,jitter:0};return n==null||n.forEach(t=>{t.packetsLost&&(e.packetsLost+=t.packetsLost),t.jitter>e.jitter&&(e.jitter=t.jitter)}),e},Ir=(n,e)=>Array.from(new Set(n.concat(e))),Cr=(n,e,t)=>Wt(n,e,t)*8,Wt=(n,e,t)=>{let r=e&&e[n],i=t?t[n]:null;return e&&t&&Z(r)&&Z(i)?jt(r,i,e.timestamp,t.timestamp)*1e3:0},jt=(n,e,t,r)=>Z(n)&&Z(e)&&t&&r?(n-e)/(t-r):0;var ct=class{constructor(e,t){this.getStats=e;this.store=t;this.TAG="[HMSWebrtcStats]";this.peerStats={};this.trackStats={};var r;this.localPeerID=(r=this.store.getLocalPeer())==null?void 0:r.peerId}getLocalPeerStats(){if(!!this.localPeerID)return this.peerStats[this.localPeerID]}getTrackStats(e){return this.trackStats[e]}updateStats(){return c(this,null,function*(){yield this.updateLocalPeerStats(),yield this.updateTrackStats()})}updateLocalPeerStats(){return c(this,null,function*(){var m,T,S,G,A,b;if(!this.localPeerID)return;let e=this.getLocalPeerStats(),t;try{t=yield(T=(m=this.getStats).publish)==null?void 0:T.call(m)}catch(E){o.e(this.TAG,"Error in getting publish stats",E)}let r=t&&Kt("publish",t,e),i;try{i=yield(G=(S=this.getStats).subscribe)==null?void 0:G.call(S)}catch(E){o.e(this.TAG,"Error in getting subscribe stats",E)}let a=i&&Kt("subscribe",i,e),{packetsLost:s,jitter:d}=Pr(i),l=jt(s,(A=e==null?void 0:e.subscribe)==null?void 0:A.packetsLost,a==null?void 0:a.timestamp,(b=e==null?void 0:e.subscribe)==null?void 0:b.timestamp),u=a&&Object.assign(a,{packetsLostRate:l,jitter:d,packetsLost:s});this.peerStats[this.localPeerID]={publish:r,subscribe:u}})}updateTrackStats(){return c(this,null,function*(){var r;let e=this.store.getTracksMap(),t=Ir(Object.keys(this.trackStats),Object.keys(e));for(let i of t){let a=e[i];if(a){let s=a.peerId&&((r=this.store.getPeerById(a.peerId))==null?void 0:r.name),d=this.getTrackStats(a.trackId),l=yield yr(this.getStats,a,s,d);l&&(this.trackStats[i]=l)}else delete this.trackStats[i]}})}};var dt=class{constructor(e,t,r,i){this.store=e;this.eventBus=t;this.publishConnection=r;this.subscribeConnection=i;this.TAG="[HMSWebrtcInternals]";this.interval=dr;this.isMonitored=!1;this.handleStatsUpdate=()=>c(this,null,function*(){var e;yield(e=this.hmsStats)==null?void 0:e.updateStats(),this.eventBus.statsUpdate.publish(this.hmsStats)})}getPublishPeerConnection(){return this.publishConnection}getSubscribePeerConnection(){return this.subscribeConnection}onStatsChange(e){return this.eventBus.statsUpdate.subscribe(e),()=>{this.eventBus.statsUpdate.unsubscribe(e)}}setPeerConnections({publish:e,subscribe:t}){var r,i;this.publishConnection=e,this.subscribeConnection=t,this.hmsStats=new ct({publish:(r=this.publishConnection)==null?void 0:r.getStats.bind(this.publishConnection),subscribe:(i=this.subscribeConnection)==null?void 0:i.getStats.bind(this.subscribeConnection)},this.store)}start(){return c(this,null,function*(){this.stop(),this.isMonitored=!0,o.d(this.TAG,"Starting Webrtc Stats Monitor"),this.startLoop().then(()=>o.d(this.TAG,"Stopping Webrtc Stats Monitor")).catch(e=>o.e(this.TAG,e.message))})}stop(){this.isMonitored=!1}startLoop(){return c(this,null,function*(){for(;this.isMonitored;)yield this.handleStatsUpdate(),yield ee(this.interval)})}cleanUp(){this.stop(),this.eventBus.statsUpdate.removeAllListeners()}};var _="[HMSTransport]:",lt=class{constructor(e,t,r,i,a){this.observer=e;this.deviceManager=t;this.store=r;this.localTrackManager=i;this.eventBus=a;this.state=w.Disconnected;this.trackStates=new Map;this.publishConnection=null;this.subscribeConnection=null;this.retryScheduler=new Ut(R,(e,t)=>c(this,null,function*(){e!==this.state&&(this.state=e,yield this.observer.onStateChange(this.state,t))}));this.callbacks=new Map;this.signalObserver={onOffer:e=>c(this,null,function*(){try{yield this.subscribeConnection.setRemoteDescription(e),o.d(_,`[SUBSCRIBE] Adding ${this.subscribeConnection.candidates.length} ice-candidates`,this.subscribeConnection.candidates);for(let r of this.subscribeConnection.candidates)yield this.subscribeConnection.addIceCandidate(r);this.subscribeConnection.candidates.length=0;let t=yield this.subscribeConnection.createAnswer();yield this.subscribeConnection.setLocalDescription(t),this.signal.answer(t),o.d(_,"[role=SUBSCRIBE] onOffer renegotiation DONE \u2705")}catch(t){o.d(_,"[role=SUBSCRIBE] onOffer renegotiation FAILED \u274C"),this.state=w.Failed;let r;throw t instanceof g?r=t:r=p.GenericErrors.Unknown(h.PUBLISH,t.message),R.queue(D.subscribeFail(r)).flush(),r}}),onTrickle:e=>c(this,null,function*(){let t=e.target===W.Publish?this.publishConnection:this.subscribeConnection;t.remoteDescription===null?t.candidates.push(e.candidate):yield t.addIceCandidate(e.candidate)}),onNotification:e=>this.observer.onNotification(e),onServerError:e=>c(this,null,function*(){yield this.observer.onStateChange(w.Failed,e)}),onFailure:e=>{this.joinParameters&&this.retryScheduler.schedule(I.SignalDisconnect,e,this.retrySignalDisconnectTask)},onOffline:()=>c(this,null,function*(){o.d(_,"socket offline",w[this.state]);try{this.state!==w.Leaving&&this.joinParameters&&this.retryScheduler.schedule(I.SignalDisconnect,p.WebSocketConnectionErrors.WebSocketConnectionLost(h.RECONNECT_SIGNAL,"Network offline"),this.retrySignalDisconnectTask)}catch(e){console.error(e)}}),onOnline:()=>{o.d(_,"socket online",w[this.state]),this.analyticsSignalTransport.flushFailedEvents()}};this.signal=new We(this.signalObserver);this.analyticsSignalTransport=new $t(this.signal);this.publishConnectionObserver={onRenegotiationNeeded:()=>c(this,null,function*(){yield this.performPublishRenegotiation()}),onIceConnectionChange:e=>c(this,null,function*(){o.d("publisher ice connection state change, ",e)}),onConnectionStateChange:e=>c(this,null,function*(){o.d("publisher connection state change, ",e),e==="failed"&&(yield this.handleIceConnectionFailure(W.Publish))})};this.subscribeConnectionObserver={onApiChannelMessage:e=>{this.observer.onNotification(JSON.parse(e))},onTrackAdd:e=>{o.d(_,"[Subscribe] onTrackAdd",e),this.observer.onTrackAdd(e)},onTrackRemove:e=>{o.d(_,"[Subscribe] onTrackRemove",e),this.observer.onTrackRemove(e)},onIceConnectionChange:e=>c(this,null,function*(){if(o.d("subscriber ice connection state change, ",e),e==="connected"){let t=this.callbacks.get(Te);this.callbacks.delete(Te),t&&t.promise.resolve(!0)}}),onConnectionStateChange:e=>c(this,null,function*(){if(o.d("subscriber connection state change, ",e),e==="failed"&&(yield this.handleIceConnectionFailure(W.Subscribe)),e==="connected"){let t=this.callbacks.get(Te);this.callbacks.delete(Te),t&&t.promise.resolve(!0)}})};this.retryPublishIceFailedTask=()=>c(this,null,function*(){if(this.publishConnection.iceConnectionState!=="connected"||this.publishConnection.connectionState!=="connected"){let e=new Promise((t,r)=>{this.callbacks.set(Se,{promise:{resolve:t,reject:r},action:h.RESTART_ICE,extra:{}})});yield this.performPublishRenegotiation({iceRestart:!0}),yield e}return!0});this.retrySubscribeIceFailedTask=()=>c(this,null,function*(){if(this.subscribeConnection.iceConnectionState!=="connected"||this.subscribeConnection.connectionState!=="connected"){let e=new Promise((r,i)=>{this.callbacks.set(Te,{promise:{resolve:r,reject:i},action:h.RESTART_ICE,extra:{}})}),t=new Promise(r=>{setTimeout(r,cr,!1)});return Promise.race([e,t])}return!0});this.retrySignalDisconnectTask=()=>c(this,null,function*(){let e=this.signal.isConnected;if(o.d(_,"retrySignalDisconnectTask",{signalConnected:this.signal.isConnected}),!this.signal.isConnected)try{yield this.internalConnect(this.joinParameters.authToken,this.joinParameters.endpoint,this.joinParameters.peerId),e=!0}catch(t){e=!1}return e=this.signal.isConnected&&(yield this.retryPublishIceFailedTask()),this.signal.trackUpdate(this.trackStates),e});var s,d;this.webrtcInternals=new dt(this.store,this.eventBus,(s=this.publishConnection)==null?void 0:s.nativeConnection,(d=this.subscribeConnection)==null?void 0:d.nativeConnection)}getLocalScreen(e,t){return c(this,null,function*(){try{return yield this.localTrackManager.getLocalScreen(e,t)}catch(r){throw r instanceof g&&R.queue(D.publish({error:r,devices:this.deviceManager.getDevices(),settings:new ye(e,t,!1)})).flush(),r}})}getWebrtcInternals(){return this.webrtcInternals}join(e,t,r,i="https://prod-init.100ms.live/init",a=!1,s=!1){return c(this,null,function*(){this.setTransportStateForJoin(),this.joinParameters=new Ft(e,t,r.name,r.metaData,i,a,s),o.d(_,"join: started \u23F0");let d=new Date;try{(!this.signal.isConnected||!this.initConfig)&&(yield this.connect(e,i,t)),this.initConfig&&(yield this.connectionJoin(r.name,r.metaData,this.initConfig.rtcConfiguration,a,s))}catch(l){o.e(_,`join: failed \u274C [token=${e}]`,l),this.state=w.Failed,l instanceof g&&R.queue(D.join(d,new Date,l)).flush();let u=l;throw u.isTerminal=u.code===500,yield this.observer.onStateChange(this.state,u),u}o.d(_,"\u2705 join: successful"),this.state=w.Joined,this.observer.onStateChange(this.state)})}connect(e,t,r){return c(this,null,function*(){try{return yield this.internalConnect(e,t,r)}catch(i){if(i instanceof g&&([k.WebSocketConnectionErrors.WEBSOCKET_CONNECTION_LOST,k.InitAPIErrors.ENDPOINT_UNREACHABLE].includes(i.code)||i.code.toString().startsWith("5")||i.code.toString().startsWith("429"))){let s=()=>c(this,null,function*(){return yield this.internalConnect(e,t,r),Boolean(this.initConfig&&this.initConfig.endpoint)});yield this.retryScheduler.schedule(I.ConnectFailed,i,s,Ce,!1)}else throw i}})}leave(){return c(this,null,function*(){var e,t,r,i;R.removeTransport(this.analyticsSignalTransport),this.retryScheduler.reset(),this.joinParameters=void 0;try{this.state=w.Leaving,(e=this.webrtcInternals)==null||e.cleanUp(),(t=this.trackDegradationController)==null||t.cleanUp(),yield(r=this.publishConnection)==null?void 0:r.close(),yield(i=this.subscribeConnection)==null?void 0:i.close(),this.signal.isConnected&&(this.signal.leave(),yield this.signal.close())}catch(a){a instanceof g&&R.queue(D.disconnect(a)).flush(),o.e(_,"leave: FAILED \u274C",a)}finally{this.state=w.Disconnected,this.observer.onStateChange(this.state)}})}publish(e){return c(this,null,function*(){for(let t of e)try{yield this.publishTrack(t)}catch(r){r instanceof g&&R.queue(D.publish({devices:this.deviceManager.getDevices(),error:r})).flush()}})}unpublish(e){return c(this,null,function*(){for(let t of e)yield this.unpublishTrack(t)})}sendMessage(e){return c(this,null,function*(){yield this.signal.broadcast(e)})}trackUpdate(e){let r=Array.from(this.trackStates.values()).find(i=>e.type===i.type&&e.source===i.source);if(r){let i=new nt(x(v({},r),{mute:!e.enabled}));this.trackStates.set(r.track_id,i),o.d(_,"Track Update",this.trackStates,e),this.signal.trackUpdate(new Map([[r.track_id,i]]))}}changeRole(e,t,r=!1){return c(this,null,function*(){yield this.signal.requestRoleChange({requested_for:e.peerId,role:t,force:r})})}acceptRoleChange(e){return c(this,null,function*(){yield this.signal.acceptRoleChangeRequest({role:e.role.name,token:e.token})})}endRoom(e,t){return c(this,null,function*(){yield this.signal.endRoom(e,t)})}removePeer(e,t){return c(this,null,function*(){yield this.signal.removePeer({requested_for:e,reason:t})})}startRTMPOrRecording(e){return c(this,null,function*(){var t;((t=e.rtmpURLs)==null?void 0:t.length)?yield this.signal.startRTMPOrRecording({meeting_url:e.meetingURL,record:e.record,rtmp_urls:e.rtmpURLs}):yield this.signal.startRTMPOrRecording({meeting_url:e.meetingURL,record:e.record})})}stopRTMPOrRecording(){return c(this,null,function*(){yield this.signal.stopRTMPAndRecording()})}startHLSStreaming(e){return c(this,null,function*(){let t={variants:e.variants.map(r=>{let i={meeting_url:r.meetingURL};return r.metadata&&(i.metadata=r.metadata),i})};e.recording&&(t.recording={single_file_per_layer:e.recording.singleFilePerLayer,hls_vod:e.recording.hlsVod}),yield this.signal.startHLSStreaming(t)})}stopHLSStreaming(e){return c(this,null,function*(){if(e){let t={variants:e==null?void 0:e.variants.map(r=>{let i={meeting_url:r.meetingURL};return r.metadata&&(i.metadata=r.metadata),i})};yield this.signal.stopHLSStreaming(t)}yield this.signal.stopHLSStreaming()})}changeName(e){return c(this,null,function*(){yield this.signal.updatePeer({name:e})})}changeMetadata(e){return c(this,null,function*(){yield this.signal.updatePeer({data:e})})}changeTrackState(e){return c(this,null,function*(){yield this.signal.requestTrackStateChange(e)})}changeMultiTrackState(e){return c(this,null,function*(){yield this.signal.requestMultiTrackStateChange(e)})}publishTrack(e){return c(this,null,function*(){e.publishedTrackId=e.nativeTrack.id,o.d(_,`\u23F3 publishTrack: trackId=${e.trackId}, toPublishTrackId=${e.publishedTrackId}`,e),this.trackStates.set(e.publishedTrackId,new nt(e));let t=new Promise((s,d)=>{this.callbacks.set(Se,{promise:{resolve:s,reject:d},action:h.PUBLISH,extra:{}})}),r=e.stream;r.setConnection(this.publishConnection);let i=this.store.getSimulcastLayers(e.source);r.addTransceiver(e,i),o.time(`publish-${e.trackId}-${e.type}`),yield t,o.timeEnd(`publish-${e.trackId}-${e.type}`),this.store.addTrack(e);let a=e.settings.maxBitrate;a&&(yield r.setMaxBitrate(a,e).then(()=>{o.d(_,`Setting maxBitrate for ${e.source} ${e.type} to ${a} kpbs`)}).catch(s=>o.e(_,"Failed setting maxBitrate",s))),o.d(_,`\u2705 publishTrack: trackId=${e.trackId}`,e,this.callbacks)})}unpublishTrack(e){return c(this,null,function*(){if(o.d(_,`\u23F3 unpublishTrack: trackId=${e.trackId}`,e),e.publishedTrackId&&this.trackStates.has(e.publishedTrackId))this.trackStates.delete(e.publishedTrackId);else{let a=Array.from(this.trackStates.values()).find(s=>e.type===s.type&&e.source===s.source);a&&this.trackStates.delete(a.track_id)}let t=new Promise((i,a)=>{this.callbacks.set(Se,{promise:{resolve:i,reject:a},action:h.UNPUBLISH,extra:{}})});e.stream.removeSender(e),yield t,yield e.cleanup(),this.store.removeTrack(e.trackId),o.d(_,`\u2705 unpublishTrack: trackId=${e.trackId}`,this.callbacks)})}connectionJoin(d,l,u,m,T){return c(this,arguments,function*(e,t,r,i,a,s={offerToReceiveAudio:!1,offerToReceiveVideo:!1}){this.publishConnection=new Ve(this.signal,r,this.publishConnectionObserver,this),this.subscribeConnection=new Be(this.signal,r,this.subscribeConnectionObserver,a);try{o.d(_,"\u23F3 join: Negotiating over PUBLISH connection");let S=yield this.publishConnection.createOffer(s,new Map);yield this.publishConnection.setLocalDescription(S);let G=yield this.signal.join(e,t,S,!i,a);yield this.publishConnection.setRemoteDescription(G);for(let A of this.publishConnection.candidates||[])yield this.publishConnection.addIceCandidate(A);this.publishConnection.initAfterJoin(),yield this.initRtcStatsMonitor(),o.d(_,"\u2705 join: Negotiated over PUBLISH connection")}catch(S){throw this.state=w.Failed,S}})}performPublishRenegotiation(e){return c(this,null,function*(){o.d(_,"\u23F3 [role=PUBLISH] onRenegotiationNeeded START",this.trackStates);let t=this.callbacks.get(Se);if(!!t)try{let r=yield this.publishConnection.createOffer(e,this.trackStates);yield this.publishConnection.setLocalDescription(r),o.time("renegotiation-offer-exchange");let i=yield this.signal.offer(r,this.trackStates);this.callbacks.delete(Se),o.timeEnd("renegotiation-offer-exchange"),yield this.publishConnection.setRemoteDescription(i),t.promise.resolve(!0),o.d(_,"[role=PUBLISH] onRenegotiationNeeded DONE \u2705")}catch(r){let i;r instanceof g?i=r:i=p.GenericErrors.Unknown(h.PUBLISH,r.message),t.promise.reject(i),o.d(_,"[role=PUBLISH] onRenegotiationNeeded FAILED \u274C")}})}handleIceConnectionFailure(e){return c(this,null,function*(){e===W.Publish?this.retryScheduler.schedule(I.PublishIceConnectionFailed,p.WebrtcErrors.ICEFailure(h.PUBLISH),this.retryPublishIceFailedTask):this.retryScheduler.schedule(I.SubscribeIceConnectionFailed,p.WebrtcErrors.ICEFailure(h.SUBSCRIBE),this.retrySubscribeIceFailedTask,1)})}internalConnect(e,t,r){return c(this,null,function*(){o.d(_,"connect: started \u23F0");let i=new Date;try{this.initConfig=yield Ke.fetchInitConfig(e,r,t),yield this.openSignal(e,r),o.d(_,"Adding Analytics Transport: JsonRpcSignal"),R.addTransport(this.analyticsSignalTransport),R.flush()}catch(a){throw a instanceof g&&R.queue(D.connect(a,i,new Date,t)).flush(),o.d(_,"\u274C internal connect: failed",a),a}})}openSignal(e,t){return c(this,null,function*(){if(!this.initConfig)throw p.WebSocketConnectionErrors.GenericConnect(h.INIT,"Init Config not found");o.d(_,"\u23F3 internal connect: connecting to ws endpoint",this.initConfig.endpoint);let r=new URL(this.initConfig.endpoint);r.searchParams.set("peer",t),r.searchParams.set("token",e),r.searchParams.set("user_agent",$e),this.endpoint=r.toString(),yield this.signal.open(this.endpoint),o.d(_,"\u2705 internal connect: connected to ws endpoint")})}initRtcStatsMonitor(){return c(this,null,function*(){var e,t,r,i,a;(r=this.webrtcInternals)==null||r.setPeerConnections({publish:(e=this.publishConnection)==null?void 0:e.nativeConnection,subscribe:(t=this.subscribeConnection)==null?void 0:t.nativeConnection}),this.store.getSubscribeDegradationParams()&&(((i=this.joinParameters)==null?void 0:i.serverSubDegrade)||(this.trackDegradationController=new ot(this.store,this.eventBus),this.eventBus.statsUpdate.subscribe(s=>{var d,l,u;(u=this.trackDegradationController)==null||u.handleRtcStatsChange(((l=(d=s.getLocalPeerStats())==null?void 0:d.subscribe)==null?void 0:l.packetsLost)||0)})),this.eventBus.trackDegraded.subscribe(s=>{R.queue(D.degradationStats(s,!0)).flush(),this.observer.onTrackDegrade(s)}),this.eventBus.trackRestored.subscribe(s=>{R.queue(D.degradationStats(s,!1)).flush(),this.observer.onTrackRestore(s)})),yield(a=this.webrtcInternals)==null?void 0:a.start()})}setTransportStateForJoin(){if(this.state===w.Failed&&(this.state=w.Disconnected),this.state!==w.Disconnected&&this.state!==w.Reconnecting)throw p.WebsocketMethodErrors.AlreadyJoined(h.JOIN,`Cannot join a meeting in ${this.state}`);this.state===w.Disconnected&&(this.state=w.Connecting,this.observer.onStateChange(this.state))}};function ut(n){if(n.length===0)throw p.InitAPIErrors.InvalidTokenFormat(h.INIT,"Token cannot be an empty string");let e=n.split(".");if(e.length!==3)throw p.InitAPIErrors.InvalidTokenFormat(h.INIT,"Expected 3 '.' separate fields - header, payload and signature respectively");let t=atob(e[1]);try{let r=JSON.parse(t);return{roomId:r.room_id,userId:r.user_id,role:r.role}}catch(r){throw p.InitAPIErrors.InvalidTokenFormat(h.INIT,`couldn't parse to json - ${r.message}`)}}var ht=class{constructor(e,t){this.id=e;this.store=t;this.recording={server:{running:!1},browser:{running:!1},hls:{running:!1}};this.rtmp={running:!1};this.hls={running:!1,variants:[]}}get localPeer(){return this.store.getLocalPeer()}get peers(){return this.store.getPeers()}};import{EventEmitter2 as oi}from"eventemitter2";import{v4 as ci}from"uuid";var pt="autoplay-error",Rr={autoplayFailed:void 0,initialized:!1,autoplayCheckPromise:void 0},mt=class{constructor(e,t,r,i){this.store=e;this.notificationManager=t;this.deviceManager=r;this.eventBus=i;this.autoPausedTracks=new Set;this.TAG="[AudioSinkManager]:";this.volume=100;this.eventEmitter=new oi;this.state=v({},Rr);this.audioContextList=new Map;this.handleAudioPaused=e=>{var a;let r=(a=e.target.srcObject)==null?void 0:a.getAudioTracks()[0];if(!(r==null?void 0:r.enabled))return;o.d(this.TAG,"Audio Paused",e.target.id);let i=this.store.getTrackById(e.target.id);i&&(hr()?setTimeout(()=>c(this,null,function*(){i&&(yield this.playAudioFor(i))}),500):this.autoPausedTracks.add(i))};this.handleTrackUpdate=e=>{var t;if((t=window.HMS)==null?void 0:t.AUDIO_SINK){let{track:r,enabled:i}=e.detail;i?(r.addSink(),this.playAudioFor(r)):r.removeSink()}};this.handleTrackAdd=e=>{this.handleTrackAddAsync(e)};this.handleTrackAddAsync=e=>c(this,null,function*(){var a,s,d,l;let{track:t,peer:r}=e.detail,i=document.createElement("audio");if(i.style.display="none",i.id=t.trackId,i.addEventListener("pause",this.handleAudioPaused),t.setAudioElement(i),t.setVolume(this.volume),this.connectAudioContext(i,t.trackId),o.d(this.TAG,"Audio track added",t.trackId),(a=this.audioSink)==null||a.append(i),this.outputDevice&&(yield t.setOutputDevice(this.outputDevice)),(s=window.HMS)==null?void 0:s.AUDIO_SINK){if(!t.enabled){t.removeSink(),(d=this.listener)==null||d.onTrackUpdate(L.TRACK_ADDED,t,r);return}t.addSink()}else i.srcObject=new MediaStream([t.nativeTrack]);if((l=this.listener)==null||l.onTrackUpdate(L.TRACK_ADDED,t,r),this.state.autoplayFailed===void 0&&(this.state.autoplayCheckPromise||(this.state.autoplayCheckPromise=new Promise(u=>{this.playAudioFor(t).then(u)})),yield this.state.autoplayCheckPromise),this.state.autoplayFailed){this.autoPausedTracks.add(t);return}yield this.playAudioFor(t)});this.handleAudioDeviceChange=e=>{e.error||!e.selection||e.type==="video"||this.unpauseAudioTracks()};this.handleTrackRemove=e=>{let t=e.detail;this.autoPausedTracks.delete(t);let r=document.getElementById(t.trackId);r&&(r.removeEventListener("pause",this.handleAudioPaused),r.srcObject=null,r.remove(),t.setAudioElement(null)),this.audioSink&&this.audioSink.childElementCount===0&&(this.state.autoplayCheckPromise=void 0,this.state.autoplayFailed=void 0),o.d(this.TAG,"Audio track removed",t.trackId)};this.unpauseAudioTracks=()=>c(this,null,function*(){let e=[];this.autoPausedTracks.forEach(t=>{e.push(this.playAudioFor(t))}),yield Promise.all(e)});this.connectAudioContext=(e,t)=>{var s;if(!Ee||!((s=window.HMS)==null?void 0:s.GAIN_VALUE))return;let r=new AudioContext,i=r.createMediaElementSource(e),a=r.createGain();a.gain.value=window.HMS.GAIN_VALUE,i.connect(a),a.connect(r.destination),this.audioContextList.set(t,r)};this.notificationManager.addEventListener("track-added",this.handleTrackAdd),this.notificationManager.addEventListener("track-removed",this.handleTrackRemove),this.notificationManager.addEventListener("track-updated",this.handleTrackUpdate),this.eventBus.deviceChange.subscribe(this.handleAudioDeviceChange)}setListener(e){this.listener=e}addEventListener(e,t){this.eventEmitter.addListener(e,t)}removeEventListener(e,t){this.eventEmitter.removeListener(e,t)}get outputDevice(){return this.deviceManager.outputDevice}getVolume(){return this.volume}setVolume(e){this.store.updateAudioOutputVolume(e),this.volume=e}unblockAutoplay(){return c(this,null,function*(){this.autoPausedTracks.size>0&&this.unpauseAudioTracks()})}init(e){if(this.state.initialized)return;this.state.initialized=!0;let t=document.createElement("div");t.id=`HMS-SDK-audio-sink-${ci()}`,(e&&document.getElementById(e)||document.body).append(t),this.audioSink=t}cleanUp(){var e;(e=this.audioSink)==null||e.remove(),this.audioSink=void 0;for(let t of this.audioContextList.values())t.close();this.audioContextList.clear(),this.notificationManager.removeEventListener("track-added",this.handleTrackAdd),this.notificationManager.removeEventListener("track-removed",this.handleTrackRemove),this.notificationManager.removeEventListener("track-updated",this.handleTrackUpdate),this.eventBus.deviceChange.unsubscribe(this.handleAudioDeviceChange),this.autoPausedTracks=new Set,this.state=v({},Rr)}playAudioFor(e){return c(this,null,function*(){var r;let t=e.getAudioElement();if(!t){o.w(this.TAG,"No audio element found on track",e.trackId);return}try{let i=this.audioContextList.get(e.trackId);(i==null?void 0:i.state)==="suspended"&&(i==null||i.resume()),yield t.play(),this.state.autoplayFailed=!1,this.autoPausedTracks.delete(e),o.d(this.TAG,"Played track",e.trackId)}catch(i){if(this.autoPausedTracks.add(e),o.e(this.TAG,"Failed to play track",e.trackId,i),!this.state.autoplayFailed&&!((r=i==null?void 0:i.message)==null?void 0:r.includes("new load request"))){this.state.autoplayFailed=!0;let a=p.TracksErrors.AutoplayBlocked(h.AUTOPLAY,"");R.queue(D.autoplayError()).flush(),this.eventEmitter.emit(pt,{error:a})}}})}};var gt=class{constructor(e,t){this.store=e;this.eventBus=t;this.audioInput=[];this.audioOutput=[];this.videoInput=[];this.hasWebcamPermission=!1;this.hasMicrophonePermission=!1;this.TAG="[Device Manager]:";this.initialized=!1;this.videoInputChanged=!1;this.audioInputChanged=!1;this.updateOutputDevice=e=>{let t=this.audioOutput.find(r=>r.deviceId===e);return t&&(this.outputDevice=t,this.store.updateAudioOutputDevice(t),J.updateSelection("audioOutput",{deviceId:t.deviceId,groupId:t.groupId})),t};this.getCurrentSelection=()=>{var s,d;let e=this.store.getLocalPeer(),t=this.createIdentifier((s=e==null?void 0:e.audioTrack)==null?void 0:s.getMediaTrackSettings()),r=this.createIdentifier((d=e==null?void 0:e.videoTrack)==null?void 0:d.getMediaTrackSettings()),i=this.audioInput.find(l=>this.createIdentifier(l)===t),a=this.videoInput.find(l=>this.createIdentifier(l)===r);return{audioInput:i,videoInput:a,audioOutput:this.outputDevice}};this.computeChange=(e,t)=>e.length!==t.length?!0:t.some(r=>!e.includes(this.createIdentifier(r)));this.enumerateDevices=()=>c(this,null,function*(){try{let e=yield navigator.mediaDevices.enumerateDevices(),t=this.videoInput.map(this.createIdentifier),r=this.audioInput.map(this.createIdentifier);this.audioInput=[],this.audioOutput=[],this.videoInput=[],e.forEach(i=>{i.kind==="audioinput"&&i.label?(this.hasMicrophonePermission=!0,this.audioInput.push(i)):i.kind==="audiooutput"?this.audioOutput.push(i):i.kind==="videoinput"&&i.label&&(this.hasWebcamPermission=!0,this.videoInput.push(i))}),this.videoInputChanged=this.computeChange(t,this.videoInput),this.audioInputChanged=this.computeChange(r,this.audioInput),J.setDevices({videoInput:[...this.videoInput],audioInput:[...this.audioInput],audioOutput:[...this.audioOutput]}),this.logDevices("Enumerate Devices")}catch(e){o.e(this.TAG,"Failed enumerating devices",e)}});this.handleDeviceChange=gr(()=>c(this,null,function*(){yield this.enumerateDevices(),R.queue(D.deviceChange({selection:this.getCurrentSelection(),type:"list",devices:this.getDevices()})).flush(),this.logDevices("After Device Change");let e=this.store.getLocalPeer();this.setOutputDevice(!0),yield this.handleAudioInputDeviceChange(e==null?void 0:e.audioTrack),yield this.handleVideoInputDeviceChange(e==null?void 0:e.videoTrack)}),500).bind(this);this.handleAudioInputDeviceChange=e=>c(this,null,function*(){if(!e){o.d(this.TAG,"No Audio track on local peer");return}if(!this.audioInputChanged){o.d(this.TAG,"No Change in AudioInput Device");return}let t=this.getNewAudioInputDevice();if(!t||!t.deviceId){o.w(this.TAG,"Audio device not found");return}let{settings:r}=e,i=new j().codec(r.codec).maxBitrate(r.maxBitrate).deviceId(t.deviceId).build();try{yield e.setSettings(i,!0),this.eventBus.deviceChange.publish({devices:this.getDevices(),selection:t,type:"audioInput"}),this.logDevices("Audio Device Change Success")}catch(a){o.e(this.TAG,"[Audio Device Change]",a),R.queue(D.deviceChange({selection:{audioInput:t},devices:this.getDevices(),error:a})).flush(),this.eventBus.deviceChange.publish({error:a,selection:t,type:"audioInput",devices:this.getDevices()})}});this.handleVideoInputDeviceChange=e=>c(this,null,function*(){if(!e){o.d(this.TAG,"No video track on local peer");return}if(!this.videoInputChanged){o.d(this.TAG,"No Change in VideoInput Device");return}let t=this.videoInput[0];if(!t||!t.deviceId){o.w(this.TAG,"Video device not found");return}let{settings:r}=e,i=new U().codec(r.codec).maxBitrate(r.maxBitrate).maxFramerate(r.maxFramerate).setWidth(r.width).setHeight(r.height).deviceId(t.deviceId).build();try{yield e.setSettings(i,!0),this.eventBus.deviceChange.publish({devices:this.getDevices(),selection:t,type:"video"}),this.logDevices("Video Device Change Success")}catch(a){o.e(this.TAG,"[Video Device Change]",a),R.queue(D.deviceChange({selection:{videoInput:t},devices:this.getDevices(),error:a})).flush(),this.eventBus.deviceChange.publish({error:a,type:"video",selection:t,devices:this.getDevices()})}})}init(){return c(this,null,function*(){this.initialized||(this.initialized=!0,navigator.mediaDevices.addEventListener("devicechange",this.handleDeviceChange),yield this.enumerateDevices(),this.logDevices("Init"),this.setOutputDevice(),this.eventBus.deviceChange.publish({devices:this.getDevices()}),this.eventBus.localVideoEnabled.subscribeOnce(e=>c(this,null,function*(){!e||(yield this.enumerateDevices(),this.videoInputChanged&&this.eventBus.deviceChange.publish({devices:this.getDevices()}))})),this.eventBus.localAudioEnabled.subscribeOnce(e=>c(this,null,function*(){!e||(yield this.enumerateDevices(),this.audioInputChanged&&this.eventBus.deviceChange.publish({devices:this.getDevices()}))})),R.queue(D.deviceChange({selection:this.getCurrentSelection(),type:"list",devices:this.getDevices()})).flush())})}getDevices(){return{audioInput:this.audioInput,audioOutput:this.audioOutput,videoInput:this.videoInput}}cleanUp(){this.initialized=!1,this.audioInput=[],this.audioOutput=[],this.videoInput=[],this.outputDevice=void 0,navigator.mediaDevices.removeEventListener("devicechange",this.handleDeviceChange)}createIdentifier(e){return e?`${e.deviceId}${e.groupId}`:""}getNewAudioInputDevice(){let e=this.audioInput.find(t=>t.deviceId==="default");return e?this.audioInput.find(r=>r.label!==e.label&&e.label.includes(r.label)):this.audioInput[0]}setOutputDevice(e=!1){let t=this.getNewAudioInputDevice(),r=this.createIdentifier(this.outputDevice);this.outputDevice=void 0,(t==null?void 0:t.groupId)&&(this.outputDevice=this.audioOutput.find(i=>t.deviceId!=="default"&&i.label===t.label)),this.outputDevice||(this.outputDevice=this.audioOutput.find(i=>i.deviceId==="default")||this.audioOutput[0]),this.store.updateAudioOutputDevice(this.outputDevice),e&&r!==this.createIdentifier(this.outputDevice)&&this.eventBus.deviceChange.publish({selection:this.outputDevice,type:"audioOutput",devices:this.getDevices()})}logDevices(e=""){o.d(this.TAG,e,JSON.stringify({videoInput:[...this.videoInput],audioInput:[...this.audioInput],audioOutput:[...this.audioOutput],selected:this.getCurrentSelection()},null,4))}};var vt=class{constructor(e,t){this.deviceManager=e;this.audioSinkManager=t}getVolume(){return this.audioSinkManager.getVolume()}setVolume(e){if(e<0||e>100)throw Error("Please pass a valid number between 0-100");this.audioSinkManager.setVolume(e)}getDevice(){return this.deviceManager.outputDevice}setDevice(e){return this.deviceManager.updateOutputDevice(e)}unblockAutoplay(){return c(this,null,function*(){yield this.audioSinkManager.unblockAutoplay()})}};var Jt=class{constructor(e){this.store=e;this.primitiveComparator=(e,t)=>e===t?0:Number(e)-Number(t);this.stringComparator=(e,t)=>e===t?0:e<t?-1:1}getPeerComparators(){return{videoEnabled:(e,t)=>{var r,i;return this.primitiveComparator(Boolean((r=e.videoTrack)==null?void 0:r.enabled),Boolean((i=t.videoTrack)==null?void 0:i.enabled))},audioEnabled:(e,t)=>{var r,i;return this.primitiveComparator(Boolean((r=e.audioTrack)==null?void 0:r.enabled),Boolean((i=t.audioTrack)==null?void 0:i.enabled))},screenShare:(e,t)=>this.primitiveComparator(e.auxiliaryTracks.some(r=>r.source==="screen"),t.auxiliaryTracks.some(r=>r.source==="screen")),audioLevel:(e,t)=>{var r,i;return this.primitiveComparator(((r=this.store.getSpeakers().find(a=>a.peer&&a.peer.peerId===(e==null?void 0:e.peerId)))==null?void 0:r.audioLevel)||-1,((i=this.store.getSpeakers().find(a=>a.peer&&a.peer.peerId===(t==null?void 0:t.peerId)))==null?void 0:i.audioLevel)||-1)},rolePriority:(e,t)=>{var r,i;return this.primitiveComparator(((r=e.role)==null?void 0:r.priority)||0,((i=t.role)==null?void 0:i.priority)||0)}}}getTrackComparators(){return{video:(e,t)=>this.primitiveComparator(e.type===H.VIDEO,t.type===H.VIDEO),audio:(e,t)=>this.primitiveComparator(e.type===H.AUDIO,t.type===H.AUDIO),enabled:(e,t)=>this.primitiveComparator(Boolean(e.enabled),Boolean(t.enabled)),peerAudioLevel:(e,t)=>{let r=this.store.getPeerByTrackId(e.trackId),i=this.store.getPeerByTrackId(t.trackId);return this.getPeerComparators().audioLevel(r,i)},audioLevel:(e,t)=>{var r,i;return this.primitiveComparator(((r=this.store.getSpeakers().find(a=>a.track.trackId===e.trackId))==null?void 0:r.audioLevel)||0,((i=this.store.getSpeakers().find(a=>a.track.trackId===t.trackId))==null?void 0:i.audioLevel)||0)},screenShare:(e,t)=>this.primitiveComparator(e.source==="screen",t.source==="screen"),rolePriority:(e,t)=>{var r,i,a,s;return this.primitiveComparator(((i=(r=this.store.getPeerByTrackId(e.trackId))==null?void 0:r.role)==null?void 0:i.priority)||0,((s=(a=this.store.getPeerByTrackId(t.trackId))==null?void 0:a.role)==null?void 0:s.priority)||0)}}}};var St=class{constructor(){this.comparator=new Jt(this);this.knownRoles={};this.peers={};this.tracks={};this.peerTrackStates={};this.speakers=[];this.videoLayers=null;this.screenshareLayers=null;this.roleDetailsArrived=!1}getConfig(){return this.config}getPublishParams(){return this.publishParams}getComparator(){return this.comparator}getRoom(){return this.room}getPolicyForRole(e){return this.knownRoles[e]}getKnownRoles(){return this.knownRoles}getLocalPeer(){if(this.localPeerId&&this.peers[this.localPeerId])return this.peers[this.localPeerId]}getRemotePeers(){return Object.values(this.peers).filter(e=>!e.isLocal)}getPeers(){return Object.values(this.peers)}getPeerById(e){if(this.peers[e])return this.peers[e]}getTracksMap(){return this.tracks}getTracks(){return Object.values(this.tracks)}getVideoTracks(){return this.getTracks().filter(e=>e.type===H.VIDEO)}getRemoteVideoTracks(){return this.getTracks().filter(e=>e instanceof ue)}getAudioTracks(){return this.getTracks().filter(e=>e.type===H.AUDIO)}getPeerTracks(e){let t=e?this.peers[e]:void 0,r=[];return(t==null?void 0:t.videoTrack)&&r.push(t.videoTrack),(t==null?void 0:t.audioTrack)&&r.push(t.audioTrack),r.concat((t==null?void 0:t.auxiliaryTracks)||[])}getLocalPeerTracks(){return this.getPeerTracks(this.localPeerId)}getTrackById(e){var i,a;let t=this.tracks[e];if(t)return t;let r=this.getLocalPeer();if(r){if((i=r.audioTrack)==null?void 0:i.isPublishedTrackId(e))return r.audioTrack;if((a=r.videoTrack)==null?void 0:a.isPublishedTrackId(e))return r.videoTrack}}getPeerByTrackId(e){let t=this.tracks[e];return t.peerId?this.peers[t.peerId]:void 0}getSpeakers(){return this.speakers}getSpeakerPeers(){return this.speakers.map(e=>e.peer)}setRoom(e){this.room=e}setKnownRoles(e){this.knownRoles=e,this.roleDetailsArrived=!0,this.updatePeersPolicy()}hasRoleDetailsArrived(){return this.roleDetailsArrived}setConfig(e){var t,r,i;if(J.rememberDevices(Boolean(e.rememberDeviceSelection)),e.rememberDeviceSelection){let a=J.getSelection();a&&(e.settings||(e.settings={}),((t=a.audioInput)==null?void 0:t.deviceId)&&(e.settings.audioInputDeviceId=e.settings.audioInputDeviceId||a.audioInput.deviceId),((r=a.audioOutput)==null?void 0:r.deviceId)&&(e.settings.audioOutputDeviceId=e.settings.audioOutputDeviceId||a.audioOutput.deviceId),((i=a.videoInput)==null?void 0:i.deviceId)&&(e.settings.videoDeviceId=e.settings.videoDeviceId||a.videoInput.deviceId))}this.config=e}setPublishParams(e){this.publishParams=e}addPeer(e){this.peers[e.peerId]=e,e.isLocal&&(this.localPeerId=e.peerId)}addTrack(e){this.tracks[e.trackId]=e}getTrackState(e){return this.peerTrackStates[e]}setTrackState(e){this.peerTrackStates[e.trackInfo.track_id]=e}removePeer(e){this.localPeerId===e&&(this.localPeerId=void 0),delete this.peers[e]}removeTrack(e){delete this.tracks[e]}updateSpeakers(e){this.speakers=e}updateAudioOutputVolume(e){this.getAudioTracks().forEach(t=>t.setVolume(e))}updateAudioOutputDevice(e){this.getAudioTracks().forEach(t=>{t.setOutputDevice(e)})}getSubscribeDegradationParams(){var t,r;let e=(r=(t=this.getLocalPeer())==null?void 0:t.role)==null?void 0:r.subscribeParams.subscribeDegradation;if(e&&Object.keys(e).length>0)return e}getSimulcastLayers(e){var t,r;return e==="screen"?((t=this.screenshareLayers)==null?void 0:t.layers)||[]:((r=this.videoLayers)==null?void 0:r.layers)||[]}getSimulcastDimensions(e){let t=e==="screen"?this.screenshareLayers:this.videoLayers,r=t==null?void 0:t.width,i=t==null?void 0:t.height;return{width:r,height:i}}convertSimulcastLayers(e){return x(v({},e),{layers:(e.layers||[]).map(t=>x(v({},t),{maxBitrate:t.maxBitrate*1e3}))})}setVideoSimulcastLayers(e){this.videoLayers=this.convertSimulcastLayers(e)}setScreenshareSimulcastLayers(e){this.screenshareLayers=this.convertSimulcastLayers(e)}getSimulcastDefinitionsForPeer(e,t){if(!e.role)return[];let r=this.getPolicyForRole(e.role.name).publishParams,i;if(t==="regular"?i=r.videoSimulcastLayers:t==="screen"&&(i=r.screenSimulcastLayers),!i||!i.layers||i.layers.length===0)return[];let a=i.width,s=i.height;return i.layers.map(d=>{let l=ur[d.rid],u={width:a&&d.scaleResolutionDownBy?a/d.scaleResolutionDownBy:void 0,height:s&&d.scaleResolutionDownBy?s/d.scaleResolutionDownBy:void 0};return{layer:l,resolution:u}})}cleanUp(){let e=this.getTracks();for(let t of e)t.cleanup();this.config=void 0,this.localPeerId=void 0,this.roleDetailsArrived=!1}setErrorListener(e){this.errorListener=e}updatePeersPolicy(){this.getPeers().forEach(e=>{var t;if(!e.role){(t=this.errorListener)==null||t.onError(p.GenericErrors.InvalidRole(h.VALIDATION,""));return}e.role=this.getPolicyForRole(e.role.name)})}};var Tt=class{constructor(e,t,r,i,a){this.store=e;this.transport=t;this.publish=r;this.removeAuxillaryTrack=i;this.listener=a;this.handleLocalPeerRoleUpdate=e=>c(this,null,function*(){var u,m;let t=this.store.getLocalPeer();if(!t)return;let r=e.detail.oldRole,i=e.detail.newRole,a=r.publishParams.allowed||[],s=i.publishParams.allowed||[],d={removeVideo:!1,removeAudio:!1,removeScreen:!1};a.length>0&&(s.length===0?(d.removeVideo=!0,d.removeAudio=!0,d.removeScreen=!0):(a.includes("video")&&!s.includes("video")&&(d.removeVideo=!0),a.includes("audio")&&!s.includes("audio")&&(d.removeAudio=!0),a.includes("screen")&&!s.includes("screen")&&(d.removeScreen=!0))),yield this.removeLocalTracks(d),this.store.setPublishParams(i.publishParams);let l=((u=this.store.getConfig())==null?void 0:u.settings)||{isAudioMuted:!0,isVideoMuted:!0,audioInputDeviceId:"default",videoDeviceId:"default",audioOutputDeviceId:"default"};yield this.publish(x(v({},l),{isAudioMuted:!0,isVideoMuted:!0})),(m=this.listener)==null||m.onPeerUpdate(q.ROLE_UPDATED,t)})}removeLocalTracks(i){return c(this,arguments,function*({removeVideo:e,removeAudio:t,removeScreen:r}){var d;let a=this.store.getLocalPeer();if(!a)return;let s=[];(a==null?void 0:a.videoTrack)&&e&&(s.push(a.videoTrack),a.videoTrack=void 0),(a==null?void 0:a.audioTrack)&&t&&(s.push(a.audioTrack),a.audioTrack=void 0),yield this.transport.unpublish(s);for(let l of s)(d=this.listener)==null||d.onTrackUpdate(L.TRACK_REMOVED,l,a);if(a.auxiliaryTracks&&r){let l=[...a.auxiliaryTracks];for(let u of l)u.source==="screen"&&(yield this.removeAuxillaryTrack(u.trackId))}})}};import{EventEmitter2 as di}from"eventemitter2";var me=class extends di{on(e,t){return super.on(e,t)}off(e,t){return super.off(e,t)}emit(e,t){return super.emit(e,t)}listeners(e){return super.listeners(e)}};var Ne=class{constructor(e){this.audioContext=new AudioContext,this.source=this.audioContext.createMediaElementSource(e),this.source.connect(this.audioContext.destination)}resumeContext(){this.audioContext.state==="suspended"&&(o.d(this.TAG,"AudioContext is resumed"),this.audioContext.resume())}getAudioTrack(){return this.destinationNode&&this.source.disconnect(this.destinationNode),this.destinationNode=this.audioContext.createMediaStreamDestination(),this.source.connect(this.destinationNode),this.destinationNode.stream.getAudioTracks()[0]}cleanup(){this.audioContext.state!=="closed"&&this.audioContext.close()}get TAG(){return"AudioContextManager"}};var Yt=class extends me{constructor(){super();this.seeked=!1;this.audioElement=this.getAudioElement()}play(e){return c(this,null,function*(){return new Promise((t,r)=>{this.audioElement=this.getAudioElement(),this.audioElement.src=e,this.seeked=!1,this.audioElement.onerror=()=>{let i=`Error loading ${e}`;o.e(this.TAG,i),this.stop(),r(i)},this.audioElement.oncanplaythrough=()=>c(this,null,function*(){try{if(!this.audioElement)return;if(this.audioContextManager.resumeContext(),this.track)this.seeked?this.seeked=!1:(yield this.audioElement.play(),t([this.track]));else{yield this.audioElement.play();let i=this.audioContextManager.getAudioTrack();this.track=i,t([i])}}catch(i){o.e(this.TAG,"Error playing audio",e,i.message),r(i)}}),this.audioElement.onseeked=()=>{this.seeked=!0}})})}getTracks(){return this.track?[this.track.id]:[]}getElement(){return this.audioElement}stop(){var e,t;(e=this.audioElement)==null||e.pause(),(t=this.audioElement)==null||t.removeAttribute("src"),this.audioElement=null,this.audioContextManager.cleanup(),this.track=void 0}getAudioElement(){if(this.audioElement)return this.audioElement;let e=document.createElement("audio");return e.crossOrigin="anonymous",e.addEventListener("timeupdate",t=>this.emit("progress",t)),e.addEventListener("ended",()=>{this.emit("ended",null)}),this.audioContextManager=new Ne(e),e}get TAG(){return"PlaylistAudioManager"}};var zt=class extends me{constructor(){super();this.tracks=[];this.DEFAUL_FPS=24;this.seeked=!1;this.drawImage=()=>{var e,t,r;this.videoElement&&!this.videoElement.paused&&!this.videoElement.ended&&((r=this.canvasContext)==null||r.drawImage(this.videoElement,0,0,(e=this.canvas)==null?void 0:e.width,(t=this.canvas)==null?void 0:t.height),this.timer=setTimeout(()=>{this.drawImage()},1e3/this.DEFAUL_FPS))};this.videoElement=this.getVideoElement(),this.canvas=document.createElement("canvas"),this.canvasContext=this.canvas.getContext("2d")}play(e){return new Promise((t,r)=>{this.videoElement=this.getVideoElement(),this.videoElement.src=e,this.seeked=!1,this.videoElement.onerror=()=>{let i=`Error loading ${e}`;o.e(this.TAG,i),this.stop(),r(i)},this.videoElement.oncanplaythrough=()=>c(this,null,function*(){var i,a,s;try{if(!this.videoElement)return;if(this.canvas.width=this.videoElement.videoWidth,this.canvas.height=this.videoElement.videoHeight,this.tracks.length===0){this.clearCanvasAndTracks();let d=this.canvas.captureStream();if(!d){o.e(this.TAG,"Browser does not support captureStream");return}this.videoElement.onplay=this.drawImage,this.audioContextManager.resumeContext(),yield this.videoElement.play();let l=this.audioContextManager.getAudioTrack();d.addTrack(l),d.getTracks().forEach(u=>{this.tracks.push(u)}),t(this.tracks)}else this.seeked?(this.seeked=!1,(s=this.canvasContext)==null||s.drawImage(this.videoElement,0,0,(i=this.canvas)==null?void 0:i.width,(a=this.canvas)==null?void 0:a.height)):(yield this.videoElement.play(),t(this.tracks))}catch(d){o.e(this.TAG,"Error playing video",e,d.message),r(d)}}),this.videoElement.onseeked=()=>{this.seeked=!0}})}getTracks(){return this.tracks.map(e=>e.id)}getElement(){return this.videoElement}stop(){var e,t;(e=this.videoElement)==null||e.pause(),(t=this.videoElement)==null||t.removeAttribute("src"),this.videoElement=null,this.clearCanvasAndTracks()}clearCanvasAndTracks(){var e;this.tracks=[],(e=this.canvasContext)==null||e.clearRect(0,0,this.canvas.width,this.canvas.height),clearTimeout(this.timer)}getVideoElement(){if(this.videoElement)return this.videoElement;let e=document.createElement("video");return e.crossOrigin="anonymous",e.addEventListener("timeupdate",t=>this.emit("progress",t)),e.addEventListener("ended",()=>{this.emit("ended",null)}),this.audioContextManager=new Ne(e),e}get TAG(){return"PlaylistVideoManager"}};var ft={audio:{list:[],currentIndex:-1,isAutoplayOn:!0},video:{list:[],currentIndex:-1,isAutoplayOn:!0}},kt=class extends me{constructor(e){super();this.sdk=e;this.state={audio:v({},ft.audio),video:v({},ft.video)};this.addTrack=(e,t)=>c(this,null,function*(){yield this.sdk.addTrack(e,t),o.d(this.TAG,"Playlist track added",e)});this.removeTrack=e=>c(this,null,function*(){yield this.sdk.removeTrack(e),o.d(this.TAG,"Playlist track removed",e)});this.audioManager=new Yt,this.videoManager=new zt,this.addListeners()}getList(e=P.audio){return this.state[e].list}setList(e){if(!e||e.length===0){o.w(this.TAG,"Please pass in a list of HMSPlaylistItem's");return}e.forEach(t=>{this.state[t.type].list.push(t)})}removeItem(e){let t=this.state[e.type].list,r=t.findIndex(i=>e.id===i.id);r>-1&&t.splice(r,1)}seek(e,t=P.audio){let{currentIndex:r}=this.state[t];if(r===-1)throw p.PlaylistErrors.NoEntryToPlay(h.PLAYLIST,"No item is currently playing");let i=this.getElement(t);if(i){let a=Math.max(i.currentTime+e,0);i.currentTime=Math.min(a,i.duration)}}seekTo(e,t=P.audio){let{currentIndex:r}=this.state[t];if(r===-1)throw p.PlaylistErrors.NoEntryToPlay(h.PLAYLIST,"No item is currently playing");if(e<0)throw Error("value cannot be negative");let i=this.getElement(t);i&&(i.currentTime=Math.min(e,i.duration))}setVolume(e,t=P.audio){if(e<0||e>100)throw Error("Please pass a valid number between 0-100");let r=this.getElement(t);r&&(r.volume=e*.01)}getVolume(e=P.audio){let t=this.getElement(e);return t?t.volume*100:0}getCurrentTime(e=P.audio){let t=this.getElement(e);return(t==null?void 0:t.currentTime)||0}getCurrentIndex(e=P.audio){return this.state[e].currentIndex}getCurrentProgress(e=P.audio){var s;let{list:t,currentIndex:r}=this.state[e],i=(s=t[r])==null?void 0:s.url,a=this.getElement(e);return!i||!a?0:Math.floor(100*(a.currentTime/a.duration))}getCurrentSelection(e=P.audio){let{list:t,currentIndex:r}=this.state[e];if(r!==-1)return t[r]}isPlaying(e=P.audio){let t=this.getElement(e);return!!t&&!t.paused}setIsAutoplayOn(e=P.audio,t){this.state[e].isAutoplayOn=t}getPlaybackRate(e=P.audio){let t=this.getElement(e);return t?t.playbackRate:1}setPlaybackRate(e=P.audio,t){if(t<.25||t>2)throw Error("Please pass a value between 0.25 and 2.0");let r=this.getElement(e);r&&(r.playbackRate=t)}setEnabled(i,a){return c(this,arguments,function*(e,{id:t,type:r=P.audio}){let d=this.state[r].list.findIndex(u=>u.id===t);if(!t||d===-1){o.w(this.TAG,"Pass a valid id");return}let l=this.state[r].list[d].url;e?yield this.play(l,r):yield this.pause(l,r),this.state[r].currentIndex=d,this.setDuration(r)})}playNext(){return c(this,arguments,function*(e=P.audio){let{list:t,currentIndex:r}=this.state[e];if(r>=t.length-1)throw p.PlaylistErrors.NoEntryToPlay(h.PLAYLIST,"Reached end of playlist");yield this.play(t[r+1].url,e),this.state[e].currentIndex=r+1,this.setDuration(e)})}playPrevious(){return c(this,arguments,function*(e=P.audio){let{list:t,currentIndex:r}=this.state[e];if(r<=0)throw p.PlaylistErrors.NoEntryToPlay(h.PLAYLIST,"Reached start of playlist");yield this.play(t[r-1].url,e),this.state[e].currentIndex=r-1,this.setDuration(e)})}stop(){return c(this,arguments,function*(e=P.audio){var r;let t=e===P.audio?this.audioManager:this.videoManager;(r=t.getElement())==null||r.pause(),yield this.removeTracks(e),t.stop(),this.state[e].currentIndex=-1})}cleanup(){this.state={audio:v({},ft.audio),video:v({},ft.video)},this.audioManager.stop(),this.videoManager.stop()}onProgress(e){this.videoManager.on("progress",()=>{try{e({type:P.video,progress:this.getCurrentProgress(P.video)})}catch(t){o.e(this.TAG,"Error in onProgress callback")}}),this.audioManager.on("progress",()=>{try{e({type:P.audio,progress:this.getCurrentProgress(P.audio)})}catch(t){o.e(this.TAG,"Error in onProgress callback")}})}onNewTrackStart(e){this.on("newTrackStart",e)}onPlaylistEnded(e){this.on("playlistEnded",e)}onCurrentTrackEnded(e){this.on("currentTrackEnded",e)}getElement(e=P.audio){return e===P.audio?this.audioManager.getElement():this.videoManager.getElement()}removeTracks(){return c(this,arguments,function*(e=P.audio){let r=(e===P.audio?this.audioManager:this.videoManager).getTracks();for(let i of r)yield this.removeTrack(i)})}play(r){return c(this,arguments,function*(e,t=P.audio){let i=t===P.audio?this.audioManager:this.videoManager,a=i.getElement();if(this.isItemCurrentlyPlaying(e,t)){o.w(this.TAG,`The ${t} is currently playing`);return}if(a==null?void 0:a.src.includes(e))yield a.play();else{a==null||a.pause();let s=yield i.play(e);for(let d of s)yield this.addTrack(d,t===P.audio?"audioplaylist":"videoplaylist")}})}isItemCurrentlyPlaying(e,t){let r=this.getElement(t);return!!(r&&!r.paused&&r.src.includes(e))}setDuration(e=P.audio){let t=this.getElement(e),{list:r,currentIndex:i}=this.state[e];r[i]&&(r[i].duration=(t==null?void 0:t.duration)||0),this.emit("newTrackStart",r[i])}pause(r){return c(this,arguments,function*(e,t=P.audio){let i=this.getElement(t);i&&!i.paused&&i.src.includes(e)?(i.pause(),o.d(this.TAG,"paused url",e)):o.w(this.TAG,"The passed in url is not currently playing")})}addListeners(){this.audioManager.on("ended",()=>this.handleEnded(P.audio)),this.videoManager.on("ended",()=>this.handleEnded(P.video))}handleEnded(){return c(this,arguments,function*(e=P.audio){let{list:t,currentIndex:r,isAutoplayOn:i}=this.state[e];r===t.length-1?(yield this.stop(e),this.emit("playlistEnded",e)):i?this.playNext(e):yield this.pause(t[r].url,e),this.emit("currentTrackEnded",t[r])})}get TAG(){return"PlaylistManager"}};import{EventEmitter2 as li}from"eventemitter2";var Q=class{constructor(e,t){this.eventName=e;this.eventEmitter=t;this.publish=e=>{this.eventEmitter.emit(this.eventName,e)};this.subscribe=e=>{this.eventEmitter.on(this.eventName,e)};this.subscribeOnce=e=>{this.eventEmitter.once(this.eventName,e)};this.unsubscribe=e=>{this.eventEmitter.off(this.eventName,e)};this.removeAllListeners=()=>{this.eventEmitter.removeAllListeners(this.eventName)}}};var Qt=class{constructor(){this.eventEmitter=new li;this.deviceChange=new Q(X.DEVICE_CHANGE,this.eventEmitter);this.localAudioEnabled=new Q(X.LOCAL_AUDIO_ENABLED,this.eventEmitter);this.localVideoEnabled=new Q(X.LOCAL_VIDEO_ENABLED,this.eventEmitter);this.statsUpdate=new Q(X.STATS_UPDATE,this.eventEmitter);this.trackDegraded=new Q(X.TRACK_DEGRADED,this.eventEmitter);this.trackRestored=new Q(X.TRACK_RESTORED,this.eventEmitter);this.trackAudioLevelUpdate=new Q(X.TRACK_AUDIO_LEVEL_UPDATE,this.eventEmitter);this.localAudioSilence=new Q(X.LOCAL_AUDIO_SILENCE,this.eventEmitter)}};var br={isAudioMuted:!1,isVideoMuted:!1,audioInputDeviceId:"default",audioOutputDeviceId:"default",videoDeviceId:"default"},Hr={published:!1,isInitialised:!1,isReconnecting:!1,isPreviewInProgress:!1,deviceManagersInitialised:!1},ui=class{constructor(){this.TAG="[HMSSdk]:";this.transportState=w.Disconnected;this.sdkState=v({},Hr);this.handleAutoplayError=e=>{var t,r;(r=(t=this.errorListener)==null?void 0:t.onError)==null||r.call(t,e.error)};this.observer={onNotification:e=>{if(e.method===y.PEER_LEAVE_REQUEST){this.handlePeerLeaveRequest(e.params);return}this.notificationManager.handleNotification(e,this.sdkState.isReconnecting)},onTrackAdd:e=>{this.notificationManager.handleTrackAdd(e)},onTrackRemove:e=>{this.notificationManager.handleTrackRemove(e)},onTrackDegrade:e=>{var t,r;o.d(this.TAG,"Sending Track Update Track Degraded",e),(r=this.listener)==null||r.onTrackUpdate(L.TRACK_DEGRADED,e,(t=this.store)==null?void 0:t.getPeerByTrackId(e.trackId))},onTrackRestore:e=>{var t,r;o.d(this.TAG,"Sending Track Update Track Restored",e),(r=this.listener)==null||r.onTrackUpdate(L.TRACK_RESTORED,e,(t=this.store)==null?void 0:t.getPeerByTrackId(e.trackId))},onFailure:e=>{var t;(t=this.errorListener)==null||t.onError(e)},onStateChange:(e,t)=>c(this,null,function*(){var r,i,a,s;switch(e){case w.Joined:this.transportState===w.Reconnecting&&((r=this.listener)==null||r.onReconnected());break;case w.Failed:yield this.leave(),(a=(i=this.errorListener)==null?void 0:i.onError)==null||a.call(i,t),this.sdkState.isReconnecting=!1;break;case w.Reconnecting:this.sdkState.isReconnecting=!0,(s=this.listener)==null||s.onReconnecting(t);break}this.transportState=e})};this.handlePeerLeaveRequest=e=>{var i;let t=this.store.getPeerById(e.requested_by),r={roomEnded:e.room_end,reason:e.reason,requestedBy:t};(i=this.listener)==null||i.onRemovedFromRoom(r),this.leave()};this.handleDeviceChange=e=>{var t,r,i,a,s,d;if(o.d(this.TAG,"Device Change event",e),(r=(t=this.deviceChangeListener)==null?void 0:t.onDeviceChange)==null||r.call(t,e),e.error&&e.type){let l=e.type.includes("audio")?(i=this.localPeer)==null?void 0:i.audioTrack:(a=this.localPeer)==null?void 0:a.videoTrack;(s=this.errorListener)==null||s.onError(e.error),[k.TracksErrors.CANT_ACCESS_CAPTURE_DEVICE,k.TracksErrors.DEVICE_IN_USE,k.TracksErrors.DEVICE_NOT_AVAILABLE].includes(e.error.code)&&l&&(l.setEnabled(!1),(d=this.listener)==null||d.onTrackUpdate(L.TRACK_MUTED,l,this.localPeer))}};this.sendAudioPresenceFailed=()=>{let e=p.TracksErrors.NoAudioDetected(h.PREVIEW);R.queue(D.audioDetectionFail(e,this.deviceManager.getCurrentSelection().audioInput)).flush()}}initStoreAndManagers(){if(this.sdkState.isInitialised){this.notificationManager.setListener(this.listener),this.audioSinkManager.setListener(this.listener);return}this.sdkState.isInitialised=!0,this.store=new St,this.eventBus=new Qt,this.playlistManager=new kt(this),this.notificationManager=new st(this.store,this.listener,this.audioListener),this.deviceManager=new gt(this.store,this.eventBus),this.audioSinkManager=new mt(this.store,this.notificationManager,this.deviceManager,this.eventBus),this.audioOutput=new vt(this.deviceManager,this.audioSinkManager),this.audioSinkManager.setListener(this.listener),this.audioSinkManager.addEventListener(pt,this.handleAutoplayError),this.localTrackManager=new oe(this.store,this.observer,this.deviceManager,this.eventBus),this.transport=new lt(this.observer,this.deviceManager,this.store,this.localTrackManager,this.eventBus)}validateJoined(e){if(!this.localPeer)throw p.GenericErrors.NotConnected(h.VALIDATION,`Not connected - ${e}`)}getWebrtcInternals(){var e;return(e=this.transport)==null?void 0:e.getWebrtcInternals()}getPlaylistManager(){return this.playlistManager}getRecordingState(){var e;return(e=this.store.getRoom())==null?void 0:e.recording}getRTMPState(){var e;return(e=this.store.getRoom())==null?void 0:e.rtmp}getHLSState(){var e;return(e=this.store.getRoom())==null?void 0:e.hls}get localPeer(){var e;return(e=this.store)==null?void 0:e.getLocalPeer()}preview(e,t){return c(this,null,function*(){return Mt(),Et(),this.sdkState.isPreviewInProgress?Promise.reject(p.GenericErrors.PreviewAlreadyInProgress(h.PREVIEW,"Preview already called")):(this.setUpPreview(e,t),e.alwaysRequestPermissions&&this.localTrackManager.requestPermissions().then(()=>c(this,null,function*(){yield this.initDeviceManagers()})),new Promise((r,i)=>{let a=()=>c(this,null,function*(){var d;this.notificationManager.removeEventListener("policy-change",a);let s=yield this.localTrackManager.getTracksToPublish(e.settings||br);s.forEach(l=>this.setLocalPeerTrack(l)),((d=this.localPeer)==null?void 0:d.audioTrack)&&this.initPreviewTrackAudioLevelMonitor(),yield this.initDeviceManagers(),t.onPreview(this.store.getRoom(),s),this.sdkState.isPreviewInProgress=!1,r()});this.notificationManager.addEventListener("policy-change",a),this.transport.connect(e.authToken,e.initEndpoint||"https://prod-init.100ms.live/init",this.localPeer.peerId).catch(s=>{var d;(d=this.errorListener)==null||d.onError(s),this.sdkState.isPreviewInProgress=!1,i(s)})}))})}join(e,t){var s,d,l;if(Mt(),Et(),this.sdkState.isPreviewInProgress)throw p.GenericErrors.NotReady(h.JOIN,"Preview is in progress, can't join");let{roomId:r,userId:i,role:a}=ut(e.authToken);(d=(s=this.localPeer)==null?void 0:s.audioTrack)==null||d.destroyAudioLevelMonitor(),this.listener=t,this.commonSetup(e,r,t),this.removeDevicesFromConfig(e),this.store.setConfig(e),this.localPeer?(this.localPeer.name=e.userName,this.localPeer.role=this.store.getPolicyForRole(a),this.localPeer.customerUserId=i,this.localPeer.metadata=e.metaData||""):(this.notificationManager.addEventListener("role-change",u=>{this.store.setPublishParams(u.detail.params.role.publishParams)}),this.createAndAddLocalPeerToStore(e,a,i)),this.roleChangeManager=new Tt(this.store,this.transport,this.publish.bind(this),this.removeTrack.bind(this),this.listener),this.notificationManager.addEventListener("local-peer-role-update",this.roleChangeManager.handleLocalPeerRoleUpdate),o.d(this.TAG,"SDK Store",this.store),o.d(this.TAG,`\u23F3 Joining room ${r}`),o.time(`join-room-${r}`),this.transport.join(e.authToken,this.localPeer.peerId,{name:e.userName,metaData:e.metaData||""},e.initEndpoint,e.autoVideoSubscribe,((l=window.HMS)==null?void 0:l.SERVER_SUB_DEGRADE)||!1).then(()=>c(this,null,function*(){o.d(this.TAG,`\u2705 Joined room ${r}`),this.notifyJoin(),this.publishParams&&!this.sdkState.published&&!ke&&(yield this.publish(e.settings||br))})).catch(u=>{var m;(m=this.listener)==null||m.onError(u),o.e(this.TAG,"Unable to join room",u)}).then(()=>{o.timeEnd(`join-room-${r}`)})}stringifyMetadata(e){e.metaData&&typeof e.metaData!="string"&&JSON.stringify(e.metaData)}cleanUp(){var e,t;this.store.cleanUp(),this.cleanDeviceManagers(),J.cleanup(),this.playlistManager.cleanup(),o.cleanUp(),this.sdkState=v({},Hr),this.localPeer&&((e=this.localPeer.audioTrack)==null||e.cleanup(),this.localPeer.audioTrack=void 0,(t=this.localPeer.videoTrack)==null||t.cleanup(),this.localPeer.videoTrack=void 0),this.listener=void 0,this.roleChangeManager&&this.notificationManager.removeEventListener("local-peer-role-update",this.roleChangeManager.handleLocalPeerRoleUpdate)}leave(){return c(this,null,function*(){var t;let e=this.store.getRoom();if(e){let r=e.id;o.d(this.TAG,`\u23F3 Leaving room ${r}`),yield(t=this.transport)==null?void 0:t.leave(),this.cleanUp(),o.d(this.TAG,`\u2705 Left room ${r}`)}})}getLocalPeer(){return this.store.getLocalPeer()}getPeers(){let e=this.store.getPeers();return o.d(this.TAG,"Got peers",e),e}getAudioOutput(){return this.audioOutput}sendMessage(e,t){this.sendMessageInternal({message:t,type:e})}sendBroadcastMessage(e,t){return c(this,null,function*(){return yield this.sendMessageInternal({message:e,type:t})})}sendGroupMessage(e,t,r){return c(this,null,function*(){let i=this.store.getKnownRoles();if((t.filter(s=>i[s.name])||[]).length===0)throw p.GenericErrors.ValidationFailed("No valid role is present",t);return yield this.sendMessageInternal({message:e,recipientRoles:t,type:r})})}sendDirectMessage(e,t,r){return c(this,null,function*(){var a;if(!this.store.getPeerById(t.peerId))throw p.GenericErrors.ValidationFailed("Invalid peer - peer not present in the room",t);if(((a=this.localPeer)==null?void 0:a.peerId)===t.peerId)throw p.GenericErrors.ValidationFailed("Cannot send message to self");return yield this.sendMessageInternal({message:e,recipientPeer:t,type:r})})}sendMessageInternal(a){return c(this,arguments,function*({recipientRoles:e,recipientPeer:t,type:r="chat",message:i}){if(i.replace(/\u200b/g," ").trim()==="")throw o.w(this.TAG,"sendMessage","Ignoring empty message send"),p.GenericErrors.ValidationFailed("Empty message not allowed");let s=new Pe({sender:this.localPeer,type:r,message:i,recipientPeer:t,recipientRoles:e,time:new Date});return o.d(this.TAG,"Sending Message:: ",s),yield this.transport.sendMessage(s),s})}startScreenShare(e,t=!1){return c(this,null,function*(){var d,l,u;let r=this.publishParams;if(!r)return;let{allowed:i}=r;if(!(i&&i.includes("screen"))){o.e(this.TAG,`Role ${(d=this.localPeer)==null?void 0:d.role} cannot share screen`);return}if((u=(l=this.localPeer)==null?void 0:l.auxiliaryTracks)==null?void 0:u.find(m=>m.source==="screen"))throw Error("Cannot share multiple screens");let s=yield this.getScreenshareTracks(r,e,t);if(!this.localPeer){o.d(this.TAG,"Screenshared when not connected"),s.forEach(m=>{m.cleanup()});return}yield this.transport.publish(s),s.forEach(m=>{var T,S,G;m.peerId=(T=this.localPeer)==null?void 0:T.peerId,(S=this.localPeer)==null||S.auxiliaryTracks.push(m),(G=this.listener)==null||G.onTrackUpdate(L.TRACK_ADDED,m,this.localPeer)})})}stopEndedScreenshare(e){return c(this,null,function*(){o.d(this.TAG,"\u2705 Screenshare ended natively"),yield this.stopScreenShare(),e()})}stopScreenShare(){return c(this,null,function*(){var t;o.d(this.TAG,"\u2705 Screenshare ended from app");let e=(t=this.localPeer)==null?void 0:t.auxiliaryTracks.filter(r=>r.source==="screen");if(e)for(let r of e)yield this.removeTrack(r.trackId)})}addTrack(e,t="regular"){return c(this,null,function*(){var u,m,T,S;if(!e){o.w(this.TAG,"Please pass a valid MediaStreamTrack");return}if(!this.localPeer)throw p.GenericErrors.NotConnected(h.VALIDATION,"No local peer present, cannot addTrack");if(this.localPeer.auxiliaryTracks.find(G=>G.trackId===e.id))return;let i=e.kind,a=new MediaStream([e]),s=new pe(a),d=i==="audio"?ne:z,l=new d(s,e,t,this.eventBus);this.setPlaylistSettings({track:e,hmsTrack:l,source:t}),yield(u=this.transport)==null?void 0:u.publish([l]),l.peerId=(m=this.localPeer)==null?void 0:m.peerId,(T=this.localPeer)==null||T.auxiliaryTracks.push(l),(S=this.listener)==null||S.onTrackUpdate(L.TRACK_ADDED,l,this.localPeer)})}removeTrack(e){return c(this,null,function*(){var r;if(!this.localPeer)throw p.GenericErrors.NotConnected(h.VALIDATION,"No local peer present, cannot removeTrack");let t=this.localPeer.auxiliaryTracks.findIndex(i=>i.trackId===e);if(t>-1){let i=this.localPeer.auxiliaryTracks[t];yield this.transport.unpublish([i]),this.localPeer.auxiliaryTracks.splice(t,1),(r=this.listener)==null||r.onTrackUpdate(L.TRACK_REMOVED,i,this.localPeer)}else o.w(this.TAG,`No track found for ${e}`)})}setAnalyticsLevel(e){R.level=e}setLogLevel(e){o.level=e}addAudioListener(e){this.audioListener=e,this.notificationManager.setAudioListener(e)}changeRole(e,t,r=!1){return c(this,null,function*(){var i;!e.role||e.role.name===t||(yield(i=this.transport)==null?void 0:i.changeRole(e,t,r))})}acceptChangeRole(e){return c(this,null,function*(){var t;yield(t=this.transport)==null?void 0:t.acceptRoleChange(e)})}endRoom(e,t){return c(this,null,function*(){var r;if(!this.localPeer)throw p.GenericErrors.NotConnected(h.VALIDATION,"No local peer present, cannot end room");yield(r=this.transport)==null?void 0:r.endRoom(e,t),yield this.leave()})}removePeer(e,t){return c(this,null,function*(){var r;if(!this.localPeer)throw p.GenericErrors.NotConnected(h.VALIDATION,"No local peer present, cannot remove peer");if(!this.store.getPeerById(e.peerId))throw p.GenericErrors.ValidationFailed("Invalid peer, given peer not present in room",e);yield(r=this.transport)==null?void 0:r.removePeer(e.peerId,t)})}startRTMPOrRecording(e){return c(this,null,function*(){var t;if(!this.localPeer)throw p.GenericErrors.NotConnected(h.VALIDATION,"No local peer present, cannot start streaming or recording");yield(t=this.transport)==null?void 0:t.startRTMPOrRecording(e)})}stopRTMPAndRecording(){return c(this,null,function*(){var e;if(!this.localPeer)throw p.GenericErrors.NotConnected(h.VALIDATION,"No local peer present, cannot stop streaming or recording");yield(e=this.transport)==null?void 0:e.stopRTMPOrRecording()})}startHLSStreaming(e){return c(this,null,function*(){var t;if(!this.localPeer)throw p.GenericErrors.NotConnected(h.VALIDATION,"No local peer present, cannot start HLS streaming");yield(t=this.transport)==null?void 0:t.startHLSStreaming(e)})}stopHLSStreaming(e){return c(this,null,function*(){var t;if(!this.localPeer)throw p.GenericErrors.NotConnected(h.VALIDATION,"No local peer present, cannot stop HLS streaming");yield(t=this.transport)==null?void 0:t.stopHLSStreaming(e)})}changeName(e){return c(this,null,function*(){var t;this.validateJoined("changeName"),yield(t=this.transport)==null?void 0:t.changeName(e),this.notificationManager.updateLocalPeer({name:e})})}changeMetadata(e){return c(this,null,function*(){var t;this.validateJoined("changeMetadata"),yield(t=this.transport)==null?void 0:t.changeMetadata(e),this.notificationManager.updateLocalPeer({metadata:e})})}getRoles(){return Object.values(this.store.getKnownRoles())}changeTrackState(e,t){return c(this,null,function*(){var i;if(e.type===H.VIDEO&&e.source!=="regular"){o.w(this.TAG,"Muting non-regular video tracks is currently not supported");return}if(e.enabled===t){o.w(this.TAG,`Aborting change track state, track already has enabled - ${t}`,e);return}if(!this.store.getTrackById(e.trackId))throw p.GenericErrors.ValidationFailed("No track found for change track state",e);let r=this.store.getPeerByTrackId(e.trackId);if(!r)throw p.GenericErrors.ValidationFailed("No peer found for change track state",e);yield(i=this.transport)==null?void 0:i.changeTrackState({requested_for:r.peerId,track_id:e.trackId,stream_id:e.stream.id,mute:!t})})}changeMultiTrackState(e){return c(this,null,function*(){var s;if(typeof e.enabled!="boolean")throw p.GenericErrors.ValidationFailed("Pass a boolean for enabled");let{enabled:t,roles:r,type:i,source:a}=e;yield(s=this.transport)==null?void 0:s.changeMultiTrackState({value:!t,type:i,source:a,roles:r==null?void 0:r.map(d=>d==null?void 0:d.name)})})}publish(e){return c(this,null,function*(){let t=yield this.localTrackManager.getTracksToPublish(e);yield this.setAndPublishTracks(t),this.sdkState.published=!0})}setAndPublishTracks(e){return c(this,null,function*(){var t;for(let r of e)yield this.transport.publish([r]),this.setLocalPeerTrack(r),(t=this.listener)==null||t.onTrackUpdate(L.TRACK_ADDED,r,this.localPeer);yield this.initDeviceManagers()})}setLocalPeerTrack(e){var t;switch(e.peerId=(t=this.localPeer)==null?void 0:t.peerId,e.type){case H.AUDIO:this.localPeer.audioTrack=e;break;case H.VIDEO:this.localPeer.videoTrack=e;break}}initDeviceManagers(){return c(this,null,function*(){var e,t,r;this.sdkState.deviceManagersInitialised||(this.sdkState.deviceManagersInitialised=!0,this.eventBus.deviceChange.subscribe(this.handleDeviceChange),yield this.deviceManager.init(),this.deviceManager.updateOutputDevice((t=(e=J.getSelection())==null?void 0:e.audioOutput)==null?void 0:t.deviceId),this.audioSinkManager.init((r=this.store.getConfig())==null?void 0:r.audioSinkElementId))})}cleanDeviceManagers(){this.eventBus.deviceChange.subscribe(this.handleDeviceChange),this.deviceManager.cleanUp(),this.audioSinkManager.removeEventListener(pt,this.handleAutoplayError),this.audioSinkManager.cleanUp()}initPreviewTrackAudioLevelMonitor(){var t;let e=(t=this.localPeer)==null?void 0:t.audioTrack;e==null||e.initAudioLevelMonitor(),this.eventBus.trackAudioLevelUpdate.subscribe(r=>{var a;let i=r&&r.track.trackId===(e==null?void 0:e.trackId)?[{audioLevel:r.audioLevel,peer:this.localPeer,track:e}]:[];this.store.updateSpeakers(i),(a=this.audioListener)==null||a.onAudioLevelUpdate(i)}),this.eventBus.localAudioSilence.subscribe(this.sendAudioPresenceFailed)}get publishParams(){var e;return(e=this.store)==null?void 0:e.getPublishParams()}notifyJoin(){var r;let e=this.store.getLocalPeer(),t=this.store.getRoom();t.joinedAt=new Date,(e==null?void 0:e.role)?(r=this.listener)==null||r.onJoin(t):this.notificationManager.once("policy-change",()=>{var i;(i=this.listener)==null||i.onJoin(t)})}setUpPreview(e,t){this.listener=t,this.sdkState.isPreviewInProgress=!0;let{roomId:r,userId:i,role:a}=ut(e.authToken);this.commonSetup(e,r,t),this.store.setConfig(e),this.createAndAddLocalPeerToStore(e,a,i),o.d(this.TAG,"SDK Store",this.store)}setPlaylistSettings(i){return c(this,arguments,function*({track:e,hmsTrack:t,source:r}){if(r==="videoplaylist"){let a={};if(e.kind==="audio")a.maxBitrate=64;else{a.maxBitrate=1e3;let{width:s,height:d}=e.getSettings();a.width=s,a.height=d}yield t.setSettings(a)}else r==="audioplaylist"&&(yield t.setSettings({maxBitrate:64}))})}createAndAddLocalPeerToStore(e,t,r){let i=this.store.getPolicyForRole(t),a=new Je({name:e.userName||"",customerUserId:r,metadata:e.metaData||"",role:i});this.store.addPeer(a)}commonSetup(e,t,r){this.stringifyMetadata(e),this.errorListener=r,this.deviceChangeListener=r,this.initStoreAndManagers(),this.store.setErrorListener(this.errorListener),this.store.getRoom()||this.store.setRoom(new ht(t,this.store))}removeDevicesFromConfig(e){this.store.getConfig()&&e.settings&&(delete e.settings.audioOutputDeviceId,delete e.settings.videoDeviceId,delete e.settings.audioInputDeviceId)}getScreenshareTracks(e,t,r){return c(this,null,function*(){let{screen:i}=e,a=this.store.getSimulcastDimensions("screen"),[s,d]=yield this.transport.getLocalScreen(new U().maxBitrate(i.bitRate,!1).codec(i.codec).maxFramerate(i.frameRate).setWidth((a==null?void 0:a.width)||i.width).setHeight((a==null?void 0:a.height)||i.height).build(),new j().build()),l=()=>{this.stopEndedScreenshare(t)},u=[];if(r){if(s.nativeTrack.stop(),!d)throw Error("Select share audio when sharing screen");u.push(d),d.nativeTrack.onended=l}else u.push(s),s.nativeTrack.onended=l,d&&u.push(d);return u})}};function wr(n){return c(this,null,function*(){try{return yield navigator.mediaDevices.getUserMedia(n)}catch(e){throw Y(e,$.AV)}})}function hh(n){return c(this,null,function*(){try{return yield navigator.mediaDevices.getDisplayMedia({video:n,audio:!1})}catch(e){throw Y(e,$.SCREEN)}})}function ph(){return c(this,null,function*(){try{let n=yield navigator.mediaDevices.enumerateDevices(),e={audioinput:[],audiooutput:[],videoinput:[]};return n.forEach(t=>e[t.kind].push(t)),e}catch(n){throw Y(n,$.AV)}})}function Eh(){return c(this,null,function*(){let n=new U().build(),e=new j().build();try{(yield ze(e)).stop()}catch(r){if(hi(r))throw(yield wr({audio:!1,video:!0})).getTracks().forEach(a=>a.stop()),r}return(yield Qe(n)).stop(),!1})}function hi(n){return n instanceof g&&n.action===h.TRACK}o.i("adapter",`${Lr.browserDetails.browser} v${Lr.browserDetails.version}`);export{Ge as HMSAudioCodec,Dt as HMSAudioPluginType,et as HMSAudioPluginsManager,Re as HMSAudioTrack,g as HMSException,ne as HMSLocalAudioTrack,z as HMSLocalVideoTrack,V as HMSLogLevel,q as HMSPeerUpdate,P as HMSPlaylistType,At as HMSRemoteAudioTrack,ue as HMSRemoteVideoTrack,lr as HMSRoomType,re as HMSRoomUpdate,ui as HMSSdk,F as HMSSimulcastLayer,le as HMSTrack,H as HMSTrackType,L as HMSTrackUpdate,Fe as HMSVideoCodec,Ie as HMSVideoPluginType,it as HMSVideoPluginsManager,be as HMSVideoTrack,dt as HMSWebrtcInternals,ct as HMSWebrtcStats,ph as getLocalDevices,hh as getLocalScreen,wr as getLocalStream,Ee as isBrowser,hr as isMobile,ke as isNode,ja as isSupported,He as parsedUserAgent,$e as userAgent,Eh as validateDeviceAV};
